<section class="library-section">
    <style>
    .library-section {
        --lib-bg: rgba(0, 0, 0, 0.175);
        --lib-text: var(--text-primary);
        --lib-card-bg: rgba(0, 0, 0, 0.234);
        --lib-border: rgba(255, 255, 255, 0.08);
        --lib-header-bg: rgba(255, 255, 255, 0.03);
        --accent-blue: #3d85ff;

        padding: 25px;
        border-radius: 18px;
        background-color: var(--lib-bg);
        backdrop-filter: blur(5px);
        font-family: 'Inter', sans-serif;
    }

    [data-theme="light"] .library-section {
        --lib-bg: rgba(0, 0, 0, 0.05);
        --lib-card-bg: #ffffff;
        --lib-border: rgba(0, 0, 0, 0.1);
        --lib-header-bg: rgba(0, 0, 0, 0.03);
    }

    .library-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .library-header h2 {
        color: var(--lib-text);
        font-size: 24px;
        font-weight: 700;
        margin: 0;
    }

    .view-all {
        color: var(--lib-text);
        text-decoration: none;
        font-size: 14px;
        background-color: var(--hover-bg);
        width: 84px;
        height: 37px;
        display: flex;
        justify-content: center;
        border-radius: 17px;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        border: 1px solid var(--lib-border);
    }
    .view-all:hover{
        background-color: var(--lib-border);
        transform: scale(1.05);
    }

    /* THE MAIN BOX: Flex row as requested */
    .library-main-box {
        display: flex;
        flex-direction: row; 
        gap: 12px;
        overflow-x: auto; /* Allows scrolling if boxes are too wide */
        padding-bottom: 10px;
        scrollbar-width: thin;
        scrollbar-color: #444 transparent;
    }

    .library-main-box::-webkit-scrollbar {
        height: 6px;
    }
    .library-main-box::-webkit-scrollbar-track {
        background: transparent;
    }
    .library-main-box::-webkit-scrollbar-thumb {
        background-color: #444;
        border-radius: 10px;
        transition: background-color 0.3s;
    }
    .library-main-box::-webkit-scrollbar-thumb:hover {
        background-color: var(--accent-blue);
    }

    /* INDIVIDUAL BLOCKS */
    .content-card {
        flex: 1; /* Makes all 3 take equal width */
        min-width: 320px;
        min-height: 280px;
        position: relative;
        background: var(--lib-card-bg);
        border-radius: 16px;
        padding: 0; /* Remove padding to match image card style */
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid var(--lib-border);
        cursor: pointer;
        display: flex;
        flex-direction: column;
    }

    /* Override styles for cards inside library to fit horizontal layout */
    .library-main-box .user-search-card,
    .library-main-box .image-card {
        min-width: 320px;
        width: 320px;
        margin-bottom: 0;
        flex-shrink: 0;
        height: auto;
        break-inside: auto;
    }
    
    .library-main-box .user-search-card {
        padding: 15px;
        justify-content: center;
        background: var(--lib-card-bg);
    }

    .content-card:hover {
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        border-color: var(--accent-blue);
    }

    .user-card-header {
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--lib-header-bg);
        border-bottom: 1px solid var(--lib-border);
        z-index: 2;
    }

    .header-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid var(--lib-border);
    }

    .header-username {
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--lib-text);
    }

    .card-img-body {
        width: 100%;
        flex: 1;
        position: relative;
        overflow: hidden;
    }
    .library-card-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        background-color: rgba(245, 193, 156, 0.821), rgba(159, 108, 80, 0.81);
        transition: transform 0.3s ease;
    }

    /* Mobile Specific Overrides */
    @media (max-width: 768px) {
        .library-section {
            width: 96%;
            margin: 0 auto 24px;
        }
        .content-card {
            height: auto;
            min-width: 300px;
            display: flex;
            flex-direction: column;
        }
        .library-card-img {
            height: auto;
        }
    }
    </style>

    <div class="library-header">
        <h2>Trending Library</h2>
        <a href="#" class="view-all" id="libViewAllBtn">View All</a>
    </div>

    <div class="library-main-box" id="libraryDynamicGrid">
        <!-- Content injected via JS -->
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const grid = document.getElementById('libraryDynamicGrid');
        const viewAllBtn = document.getElementById('libViewAllBtn');
        const R2_DOMAIN = "{{ r2_domain }}";

        const isMobile = window.innerWidth <= 768;

        function getLocalAssetUrl(filename) { 
            if (!filename) return '';
            if (typeof window.getAssetUrl === 'function') return window.getAssetUrl(filename);
            return (R2_DOMAIN && R2_DOMAIN !== 'None') ? `${R2_DOMAIN}/${filename}` : `/uploads/${filename}`;
        }

        // Handle View All Navigation
        if(viewAllBtn) {
            viewAllBtn.addEventListener('click', (e) => {
                e.preventDefault();
                // 1. Try to click the actual sidebar button to trigger all state changes
                const imagesTab = document.querySelector('[data-target="section-images"]');
                if(imagesTab) {
                    imagesTab.click();
                } else {
                    // 2. Fallback: Manually switch sections if sidebar button is missing
                    document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
                    const target = document.getElementById('section-images');
                    if(target) {
                        target.style.display = 'block';
                        if(typeof window.loadImagesContent === 'function') window.loadImagesContent();
                    }
                }
            });
        }

        if(grid) {
            // 1. Show Skeletons
            grid.innerHTML = '';
            for(let i=0; i<5; i++) {
                const skel = document.createElement('div');
                skel.className = 'content-card';
                skel.innerHTML = '<div class="user-card-header" style="height:57px;"></div><div class="card-img-body" style="background:var(--lib-header-bg);"></div>';
                grid.appendChild(skel);
            }

            // Observer for Blur-Up Loading
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const card = entry.target;
                        const img = card.querySelector('img[data-medium]');
                        if (img) {
                            const mediumUrl = img.getAttribute('data-medium');
                            if (mediumUrl) {
                                const mediumImg = new Image();
                                mediumImg.src = mediumUrl;
                                mediumImg.onload = () => {
                                    img.src = mediumUrl;
                                };
                            }
                        }
                        obs.unobserve(card);
                    }
                });
            }, { rootMargin: "50px" });

            // 2. Fetch Data
            // We fetch from search to get a mix of users and images
            let apiUrl = '/api/search?type=user&limit=50&sort=random';
            if (isMobile) {
                apiUrl = '/api/search?type=user&limit=30&sort=random';
            }

            fetch(apiUrl)
                .then(r => r.json())
                .then(data => {
                    if(data.success && data.assets.length > 0) {
                        grid.innerHTML = '';

                        // The API is already asked for users with `type=user`, so we can trust the result.
                        // The previous filter `a.type === 'user'` was redundant and would fail if the backend
                        // omitted the 'type' field in the response.
                        const users = data.assets;

                        if (users.length === 0) {
                             grid.innerHTML = '<div class="library-empty-msg">No creators found to display.</div>';
                             return;
                        }

                        users.forEach((asset) => {
                            let card;
                            if (typeof window.createUserCard === 'function') {
                                card = window.createUserCard(asset);
                            }
                            
                            if (card) {
                                card.classList.add('fade-in');
                                grid.appendChild(card);
                            }
                        });
                        
                        // Fallback if no cards generated (e.g. functions missing)
                        if (grid.children.length === 0) {
                             grid.innerHTML = '<div style="color:#888; padding:20px;">Library unavailable</div>';
                        }
                    } else {
                        grid.innerHTML = '<div style="color:#888; padding:20px;">No items found</div>';
                    }
                })
                .catch(err => {
                    console.error("Library load error", err);
                    grid.innerHTML = '<div style="color:#888; padding:20px;">Failed to load library</div>';
                });
        }
    });
</script>