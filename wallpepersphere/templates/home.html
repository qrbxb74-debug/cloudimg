<!doctype html>

<html lang="{{ current_lang }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4GX9ZBFQ21"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4GX9ZBFQ21');
    </script>
    <meta name="theme-color" content="#0c0f16">
    <title>
        {% if search_query %}
            {{ search_query|capitalize }} ({{ result_count }}) - {{ t('Photo Gallery') }}
        {% elif view_asset %}
            {{ view_asset.name }} by {{ view_asset.username or 'Artist' }} - wallpepersphere
        {% elif open_generator %}
            Free AI Image Generator - Unlimited & High Quality | wallpepersphere
        {% else %}
            wallpepersphere - Free 4K Wallpapers & AI Generator{% if current_page > 1 %} - Page {{ current_page }}{% endif %}
        {% endif %}
    </title>

    <!-- SEO & Social Media Meta Tags -->
    {% if view_asset %}
    <meta property="og:title" content="{{ view_asset.name }}">
    <meta property="og:description" content="{{ view_asset.description or 'Download high-quality 4K wallpapers and assets.' }}">
    <meta property="og:image" content="{{ r2_domain }}/{{ view_asset.link_medium or view_asset.link_small }}">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    {% elif open_generator %}
    <meta property="og:title" content="Free AI Image Generator - Create Unlimited Images">
    <meta property="og:description" content="Generate unlimited free AI images with our advanced text-to-image tool. Create stunning 4K visuals, wallpapers, and art from text prompts instantly. No limits, 100% free.">
    <meta property="og:image" content="{{ request.url_root }}static/wallpeperspheredark.jpg">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    {% else %}
    <meta property="og:title" content="wallpepersphere - Free 4K Wallpapers & AI Image Generator">
    <meta property="og:description" content="{{ t('Download free 4K wallpapers, backgrounds, and generate unlimited AI images. The best platform for creators and designers.') }}">
    <meta property="og:image" content="{{ request.url_root }}static/wallpeperspheredark.jpg">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">
    {% endif %}
    {% if open_generator %}
    <meta name="description" content="Generate unlimited free AI images with our advanced text-to-image tool. Create stunning 4K visuals, wallpapers, and art from text prompts instantly. No limits, 100% free.">
    <meta name="keywords" content="free ai image generator, unlimited ai art, text to image, ai wallpaper generator, generate images free, no limit ai generator, vertex ai, imagen 3, ai art creator">
    {% else %}
    <meta name="description" content="{{ t('Download free 4K wallpapers and backgrounds. Use our powerful free AI Image Generator to create stunning visuals from text. Explore aesthetic, nature, and abstract images.') }}">
    <meta name="keywords" content="free 4k wallpapers, ai image generator, text to image, background images, free stock photos, wallpepersphere, unlimited ai art, 4k backgrounds">
    {% endif %}

    <!-- Favicon / Website Logo -->
    <link rel="icon" href="/static/wallpepersphere.jpg">
    <link rel="apple-touch-icon" href="/static/wallpeperspheredark.jpg">

    <!-- Security: Upgrade Insecure Requests (CSP) -->
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> -->

    <!-- JSON-LD Structured Data -->
    {% if view_asset %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org/",
      "@type": "ImageObject",
      "contentUrl": "{% if r2_domain %}{{ r2_domain }}/{% else %}{{ request.url_root }}uploads/{% endif %}{{ view_asset.link_original }}",
      "license": "https://creativecommons.org/licenses/by/4.0/",
      "acquireLicensePage": "{{ request.base_url }}",
      "creditText": {{ (view_asset.username or 'Photo Shop User')|tojson }},
      "creator": {
        "@type": "Person",
        "name": {{ (view_asset.username or 'Photo Shop User')|tojson }}
      },
      "copyrightNotice": "Free for personal use",
      "name": {{ view_asset.name|tojson }},
      "description": {{ (view_asset.description or view_asset.name)|tojson }}
    }
    </script>
    {% elif open_generator %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "wallpepersphere AI Generator",
      "url": "{{ request.url_root }}generator",
      "applicationCategory": "MultimediaApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "Generate unlimited free AI images with our advanced text-to-image tool. Create stunning 4K visuals, wallpapers, and art from text prompts instantly."
    }
    </script>
    {% else %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "wallpepersphere",
      "url": "{{ request.url_root }}",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "{{ request.url_root }}search?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "wallpepersphere AI Generator",
      "url": "{{ request.url_root }}generator",
      "applicationCategory": "MultimediaApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "Generate unlimited free AI images with our advanced text-to-image tool. Create stunning 4K visuals, wallpapers, and art from text prompts instantly."
    }
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "{{ request.url_root }}"
      }]
    }
    </script>
    {% endif %}

    <!-- SEO: Canonical URL -->
    <link rel="canonical" href="{{ request.base_url }}{% if current_page > 1 %}?page={{ current_page }}{% endif %}" />

    <!-- SEO: Pagination -->
    {% if current_page > 1 %}
    <link rel="prev" href="{{ url_for('index', page=current_page-1) }}" />
    {% endif %}
    {% if seo_assets|length >= 20 %}
    <link rel="next" href="{{ url_for('index', page=current_page+1) }}" />
    {% endif %}

    <!-- SEO: Hreflang Tags for Google Indexing -->
    {% for code in supported_languages %}
    <link rel="alternate" hreflang="{{ code }}" href="{{ request.base_url }}?lang={{ code }}" />
    {% endfor %}
    <link rel="alternate" hreflang="x-default" href="{{ request.base_url }}" />

    <!-- Performance: Preconnect to Font Origins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Performance: Async Fonts with display:swap -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@700;800&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@700;800&display=swap" rel="stylesheet"></noscript>
    
    <link rel="preload" href="https://fonts.googleapis.com/icon?family=Material+Icons&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://fonts.googleapis.com/icon?family=Material+Icons&display=swap" rel="stylesheet"></noscript>
    <script>
        window.SERVER_CONFIG = {
            searchQuery: {{ search_query|default(None)|tojson }},
            viewAsset: {{ view_asset|default(None)|tojson }},
            viewProfileUser: {{ view_profile_user|default(None)|tojson }},
            seoAssets: {{ seo_assets|default([])|tojson }},
            currentPage: {{ current_page|default(1)|tojson }},
            openGenerator: {{ open_generator|default(False)|tojson }}
        };
    </script>
   
    <style>
        /* Truncate text in viewer details */
        .description-box p {
            display: flex;
            align-items: center;
            max-width: 100%;
        }
        .description-box p strong {
            flex-shrink: 0;
            margin-right: 5px;
        }
        #viewerTitle, #viewerDescription {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0; /* Required for flexbox truncation */
        }
        .similar-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 10px;
            margin-top: 20px;
        }
        .viewer-scroll-view {
            width: 100%;
        }
        
        /* Mobile Layout Fixes */
        @media (max-width: 768px) {
            .profile-header-banner {
                padding: 20px 10px !important;
                margin-bottom: 20px !important;
            }
            .profile-avatar-large {
                width: 100px !important;
                height: 100px !important;
            }
            #publicProfileName {
                font-size: 1.8rem !important;
            }
            /* Ensure sections don't break layout */
            .content-section {
                width: 100%;
                overflow-x: hidden;
            }
        }
        
        /* Pexels-like Simple Banner Styles */
        .welcome-banner {
            background: transparent !important;
            box-shadow: none !important;
            padding: 40px 20px 20px !important;
            min-height: auto !important;
            height: auto !important;
            position: relative;
            overflow: hidden;
            border-radius: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .welcome-banner {
                background: transparent !important;
            }
        }
        @media (min-width: 769px) {
            .welcome-banner {
                background-image: url('/static/hero.webp') !important;
                background-size: cover !important;
                background-position: center !important;
                height: 400px !important;
                justify-content: center;
            }
            .welcome-banner::before {
                content: '';
                position: absolute;
                top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 0;
            }
            .welcome-title, .welcome-text, .welcome-search-box, .welcome-license {
                position: relative;
                z-index: 1;
            }
            .welcome-title { color: #fff !important; }
            .welcome-text { color: rgba(255,255,255,0.9) !important; }
        }
        .welcome-title {
            font-size: 2rem !important;
            font-weight: 700 !important;
            margin-bottom: 8px !important;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .welcome-text {
            font-size: 1rem !important;
            opacity: 0.9;
            max-width: 500px;
            margin-bottom: 25px !important;
        }
        .welcome-search-box {
            background: #fff !important;
            border: 1px solid rgba(0,0,0,0.1) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
            max-width: 550px !important;
            padding: 6px 12px !important;
            border-radius: 8px !important; /* Less rounded, more clean */
        }
        .welcome-search-input {
            color: #333 !important;
            font-size: 0.95rem !important; /* Smaller font */
        }
        .welcome-search-input::placeholder {
            color: #888 !important;
        }
        .welcome-search-icon {
            filter: brightness(0) opacity(0.5) !important; /* Dark icon */
            width: 18px !important;
            height: 18px !important;
        }

        /* Library Section Empty State */
        .library-empty-msg {
            color: #888;
            padding: 20px;
            text-align: center;
            font-size: 1.1rem;
            width: 100%;
        }
        @media (max-width: 768px) {
            .library-empty-msg {
                font-size: 0.9rem;
            }
        }

        /* Mobile Hero Search Bar Improvements */
        @media (max-width: 768px) {
            .hero-search-wrapper {
                background: #ffffff !important;
                border: 1px solid rgba(0,0,0,0.1) !important;
                box-shadow: 0 4px 20px rgba(0,0,0,0.25) !important;
                padding: 12px 15px !important;
                border-radius: 14px !important;
            }
            .hero-search-wrapper input {
                color: #222 !important;
                font-size: 1rem !important;
            }
            .hero-search-wrapper input::placeholder {
                color: #777 !important;
            }
            .hero-search-icon {
                width: 28px !important;
                height: 28px !important;
                stroke: #444 !important;
                min-width: 28px !important;
            }
            .hero-search-actions .hero-icon-btn:not(.ai-gen-btn) img, 
            .hero-search-actions .hero-icon-btn:not(.ai-gen-btn) svg {
                filter: brightness(0.2) !important;
            }
            .hero-search-actions .hero-icon-btn:not(.ai-gen-btn) svg path {
                fill: #444 !important;
            }
        }

    </style>
    <link rel="stylesheet" href="/static/home.css">
    <!-- Performance: Inline Critical CSS (Variables & Layout Skeleton) -->
  
</head>

<body>
    <!-- Initial Splash Screen -->
    <div id="app-splash">
        <div class="splash-brand">wallp<span style="-webkit-text-fill-color: #ff0000;">E</span>persphere</div>
    </div>
    <script>
        (function() {
            var splash = document.getElementById('app-splash');
            var css = document.querySelector('link[href*="home.css"]');
            
            function removeSplash() {
                splash.classList.add('hidden');
                // Stop animation to prevent lag
                var brand = splash.querySelector('.splash-brand');
                if(brand) brand.style.animation = 'none';
            }

            // 1. Monitor CSS Load (Sensitive Check)
            if (css) {
                if (css.sheet) removeSplash();
                else { css.onload = removeSplash; css.onerror = removeSplash; }
            }
            
            // 2. Safety Fallbacks
            document.addEventListener('DOMContentLoaded', removeSplash);
            window.addEventListener('load', removeSplash);
        })();
    </script>

    <div class="page-loader"></div>
    {% include 'theme_loader.html' %}
    <script>
        // Mobile Optimization: Critical Path
        // Runs immediately to manage section visibility and prevent resource waste
        if ('scrollRestoration' in history) history.scrollRestoration = 'manual';
    </script>
    
    <div class="sidebar-overlay"></div>

    <!-- CONNECTION TOAST -->
    <div class="connection-toast" id="connectionToast">
        <div class="connection-icon" id="connectionIcon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>
        </div>
        <span id="connectionText">{{ t('No Internet Connection') }}</span>
        <button class="connection-retry-btn" id="connectionRetryBtn">{{ t('Retry') }}</button>
    </div>
    
    <!-- UPLOAD MODAL CONTAINER -->
    <div id="uploadModal" class="upload-overlay">
        <!-- Content will be injected here via JS -->
    </div>

    <!-- GENERIC ERROR MODAL -->
    <div class="modal-overlay" id="generalErrorModal" style="z-index: 20001;">
        <div class="auth-card" style="border-top: 4px solid #ffae44; text-align: center; max-width: 400px;">
            <div class="close-trigger" onclick="this.parentElement.parentElement.classList.remove('active')">✕</div>
            <div style="width: 70px; height: 70px; background: rgba(255, 174, 68, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#ffae44" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
            </div>
            <h2 style="margin-top: 0; margin-bottom: 10px; color: #ffae44; font-size: 1.5rem;" data-i18n="Oops!">Oops!</h2>
            <p style="color: #ccc; margin-bottom: 25px; font-size: 0.95rem; line-height: 1.5;" id="generalErrorMessage">
                An unexpected error occurred.
            </p>
            <button class="auth-btn" onclick="this.parentElement.parentElement.classList.remove('active')" style="background: #2a2a2a; border: 1px solid #444; color: white;" data-i18n="I Understand">I Understand</button>
        </div>
    </div>

    <!-- EDITOR MODAL CONTAINER -->
    <div id="editorModal" class="upload-overlay" style="z-index: 10001;">
        <!-- Content will be injected here via JS -->
    </div>

    <!-- IMAGE VIEWER POPUP -->
    <div class="popup-overlay" id="imageViewerModal" tabindex="-1" style="outline: none;">
        <div class="viewer-card">
            
            <div class="exit-btn" id="closeViewerBtn" title="{{ t('Close') }}">✕</div>

            <div class="viewer-left">
                <div class="viewer-header mobile-view" style="position: absolute; top: 20px; left: 20px; z-index: 20; width: calc(100% - 80px);">
                    <div class="account-circle">
                        <img src="https://via.placeholder.com/50" alt="Avatar" id="viewerAvatarMobile" width="50" height="50">
                    </div>
                    <div class="user-info-group">
                        <span class="user-name" id="viewerUsernameMobile">PixelArtist</span>
                        <span class="user-status">{{ t('Pro Member') }}</span>
                    </div>
                    <button class="viewer-follow-btn" id="viewerFollowBtnMobile" style="margin-left: auto; padding: 6px 12px; border-radius: 20px; border: none; background: var(--primary); color: white; font-weight: 600; cursor: pointer; display: none; align-items: center; gap: 6px; font-size: 0.8rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        <span>{{ t('Follow') }}</span>
                    </button>
                </div>
                <div class="viewer-scroll-view">
                    <p class="quality-text">{{ t('Download image to see best quality') }}</p>
                    <img src="" class="main-image" id="viewerImage" width="800" height="600" alt="Viewed Image">
                    <div id="viewerRelatedSearches" class="related-searches-container"></div>
                    <div class="similar-grid gallery-grid" id="similarGrid"></div>
                </div>
                <div class="expand-btn desktop-view" id="expandViewerBtn"><img src="/static/icons/expand.png" style="width: 20px;" width="20" height="20" alt="Expand"></div>
            </div>

            <div class="viewer-right">
                
                <div class="viewer-header desktop-view">
                    <div class="account-circle">
                        <img src="https://via.placeholder.com/50" alt="Avatar" id="viewerAvatar" width="50" height="50">
                    </div>
                    <div class="user-info-group">
                        <span class="user-name" id="viewerUsername">PixelArtist</span>
                        <span class="user-status">{{ t('Pro Member') }}</span>
                    </div>
                    <button class="viewer-follow-btn" id="viewerFollowBtn" style="margin-left: auto; padding: 6px 14px; border-radius: 20px; border: none; background: var(--primary); color: white; font-weight: 600; cursor: pointer; display: none; align-items: center; gap: 6px; font-size: 0.85rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        <span>{{ t('Follow') }}</span>
                    </button>
                </div>

                <div class="details-container">
                    <div class="description-box">
                        <h3>{{ t('File Information') }}</h3>
                        <p><strong>{{ t('Title') }}:</strong> <span id="viewerTitle">Image</span></p>
                        <p><strong>{{ t('Description') }}:</strong> <span id="viewerDescription"></span></p>
                        <p><strong>{{ t('Quality') }}:</strong> <span id="viewerQuality">Unknown</span></p>
                        <p><strong>{{ t('Resolution') }}:</strong> <span id="viewerRes">Original</span></p>
                        <div style="display: flex; align-items: center; gap: 6px; margin-top: 12px; color: #4caf50; font-size: 0.9rem; font-weight: 500;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            <span>{{ t('License: Free for Personal Use') }}</span>
                        </div>
                    </div>
                    <div class="nav-controls" style="margin-top: 20px; justify-content: center;">
                        <button class="nav-btn" id="prevImageBtn"><img src="/static/icons/back.png" style="width: 24px;" width="24" height="24" alt="Previous"></button>
                        <button class="nav-btn" id="nextImageBtn"><img src="/static/icons/next.png" style="width: 24px;" width="24" height="24" alt="Next"></button>
                    </div>
                </div>

                <div class="download-wrapper">
                    <button class="btn-download secondary" id="editImageBtn" style="display: none;" disabled>
                        <span class="material-icons" style="font-size: 20px;">edit</span>
                        <span class="btn-text">{{ t('EDIT IMAGE') }}</span>
                    </button>
                    <button class="btn-download secondary" id="shareImageBtn">
                        <img src="/static/icons/share.png" style="width: 20px; filter: brightness(0) invert(1);" alt="Share" width="20" height="20">
                        <!-- Icon only -->
                    </button>
                    <button class="btn-download secondary" id="reportImageBtn" title="{{ t('Report Content') }}" aria-label="{{ t('Report Content') }}" data-i18n="Report Content" data-i18n-attr="title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </button>
                    <button class="btn-download secondary mobile-view" id="expandViewerBtnMobile" aria-label="{{ t('Expand') }}">
                        <img src="/static/icons/expand.png" style="width: 20px; filter: brightness(0) invert(1);" width="20" height="20" alt="Expand">
                    </button>
                    <button class="btn-download" id="downloadImageBtn">
                        <img src="/static/icons/download.png" style="width: 20px;" width="20" height="20" alt="Download">
                        <span class="btn-text">{{ t('DOWNLOAD') }}</span>
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- CATEGORY MODAL -->
    <div class="category-modal" id="categoryModal">
        <div class="category-content">
            <div class="close-trigger" id="closeCategoryBtn" style="top: 20px; right: 20px;" title="{{ t('Close') }}">✕</div>
            
            <div class="category-scroll">
                <h2 style="margin-top: 0; margin-bottom: 10px; color: #fff;">{{ t('Explore Categories') }}</h2>
                <p style="color: #888; margin-bottom: 20px;">{{ t('Browse through our extensive collection') }}</p>

                <!-- Filter Tools (Resolution & Size) -->
                <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <p class="section-title" style="margin-left: 0; margin-bottom: 10px; opacity: 1; height: auto;">{{ t('Resolution') }}</p>
                            <div class="btn-grid" id="modalResGrid" style="grid-template-columns: repeat(4, 1fr);">
                                <button class="filter-btn" data-value="4K">4K</button>
                                <button class="filter-btn" data-value="HD">HD</button>
                                <button class="filter-btn" data-value="2K">2K</button>
                                <button class="filter-btn" data-value="8K">8K</button>
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <p class="section-title" style="margin-left: 0; margin-bottom: 10px; opacity: 1; height: auto;">{{ t('Size') }}</p>
                            <div class="btn-grid icons" id="modalSizeGrid" style="grid-template-columns: repeat(3, 1fr);">
                                <button class="filter-btn icon-btn" data-value="Horizontal"><img src="/static/icons/horizontal.png" class="sidebar-icon" alt="Horizontal"><span>monitor</span></button>
                                <button class="filter-btn icon-btn" data-value="Vertical"><img src="/static/icons/vertical.png" class="sidebar-icon" alt="Vertical"><span>mobile</span></button>
                                <button class="filter-btn icon-btn" data-value="Square"><img src="/static/icons/stop-square.png" class="sidebar-icon" alt="Square"><span>tablet</span></button>
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <p class="section-title" style="margin-left: 0; margin-bottom: 10px; opacity: 1; height: auto;">{{ t('Sort By') }}</p>
                            <div class="btn-grid" id="modalSortGrid" style="grid-template-columns: repeat(3, 1fr);">
                                <button class="filter-btn selected" data-value="newest">{{ t('Newest') }}</button>
                                <button class="filter-btn" data-value="popular">{{ t('Popular') }}</button>
                                <button class="filter-btn" data-value="downloads">{{ t('Downloads') }}</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="category-grid" id="categoryGrid">
                    <!-- Injected via JS -->
                </div>
            </div>
            
            <div class="category-footer">
                <button class="apply-btn" id="applyFiltersBtn">{{ t('Apply Filters') }}</button>
            </div>
        </div>
    </div>

    <!-- SIGNUP MODAL -->
    <div class="modal-overlay" id="signupModal">
        <div class="auth-card">
            <div class="close-trigger" id="closeSignupBtn" title="{{ t('Close') }}">✕</div>
            <h2 id="authTitle" style="margin-top: 0; margin-bottom: 10px;">{{ t('Create Account') }}</h2>
            <p style="color: #888; margin-bottom: 30px; font-size: 0.95rem;">{{ t('Join our community of creators') }}</p>
            
            <form class="auth-form" id="signupForm">
                <div class="input-group" id="nameInputGroup">
                    <label>{{ t('Full Name') }}</label>
                    <input type="text" placeholder="John Doe" required>
                </div>
                <div class="input-group">
                    <label>{{ t('Email Address') }}</label>
                    <input type="email" placeholder="john@example.com" required>
                </div>
                <div class="input-group">
                    <label>{{ t('Password') }}</label>
                    <input type="password" placeholder="••••••••" required>
                </div>
                <div id="authErrorMessage" style="display: none; color: #ff5f56; font-size: 0.9rem; margin-bottom: 15px; text-align: left;"></div>
                
                <button type="submit" class="auth-btn" id="authSubmitBtn">{{ t('Sign Up') }}</button>

                <div style="display: flex; align-items: center; gap: 15px; margin: 20px 0;">
                    <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                    <span style="color: #888; font-size: 0.9rem;">OR</span>
                    <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                </div>

                <a href="/login/google" class="auth-btn google-btn">
                    <img src="https://www.google.com/images/branding/googleg/1x/googleg_standard_color_28dp.png" alt="Google" style="width: 20px; height: 20px;">
                    Sign in with Google
                </a>
            </form>
            
            <p style="margin-top: 24px; color: #888; font-size: 0.9rem;">
                <span id="authPromptText">{{ t('Already have an account?') }}</span> <a href="#" id="authToggleLink" style="color: var(--primary); text-decoration: none; font-weight: 500;">{{ t('Log In') }}</a>
            </p>
        </div>
    </div>

    <!-- SECURITY ALERT MODAL -->
    <div class="modal-overlay" id="securityModal" style="z-index: 20000;">
        <div class="auth-card" style="border-top: 4px solid #ff4444; text-align: center; max-width: 400px;">
            <div class="close-trigger" id="closeSecurityBtn" title="{{ t('Close') }}">✕</div>
            <div style="width: 70px; height: 70px; background: rgba(255, 68, 68, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#ff4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            </div>
            <h2 style="margin-top: 0; margin-bottom: 10px; color: #ff4444; font-size: 1.5rem;">{{ t('Security Alert') }}</h2>
            <p style="color: #ccc; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.5;" id="securityMessage">
                {{ t('Content flagged.') }}
            </p>
            <a href="https://support.google.com/contributionpolicy" target="_blank" style="color: #ff4444; text-decoration: underline; font-size: 0.9rem; display: block; margin-bottom: 25px; font-weight: 500;">{{ t('Learn more about Safety Policies') }}</a>
            
            <button class="auth-btn" id="ackSecurityBtn" style="background: #2a2a2a; border: 1px solid #444; color: white;">{{ t('I Understand') }}</button>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="settings-overlay" id="settingsModal">
        <!-- Content injected via JS -->
    </div>

    <!-- REPORT MODAL -->
    {% include 'report_modal.html' %}

    <aside class="sidebar">

    <!-- FIXED TOP -->
    <div class="sidebar-fixed top">
        <a href="{% if session.get('user_id') %}/user-library/{{ session.get('user_id') }}{% else %}#{% endif %}" class="sidebar-btn top" id="sidebarProfileBtn" aria-label="{{ t('My Profile') }}">
            {% if session.get('avatar') %}
                <img src="{{ session.get('avatar') if session.get('avatar').startswith('/static/') else '/static/avatars/' + session.get('avatar') }}" alt="User" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" width="44" height="44">
            {% else %}
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: white;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            {% endif %}
            {% if has_unread %}
            <div class="notification-dot"></div>
            {% endif %}
        </a>
    </div>

    <!-- SCROLLABLE CONTENT -->
    <div class="sidebar-scroll">

        <!-- SECTION: RESOLUTION -->
        <div class="sidebar-section">
            <p class="section-title" data-i18n="Resolution">{{ t('Resolution') }}</p>
            <div class="btn-grid" id="sidebarResGrid">
                <button class="filter-btn" data-value="4K">4K</button>
                <button class="filter-btn" data-value="HD">HD</button>
                <button class="filter-btn" data-value="2K">2K</button>
                <button class="filter-btn" data-value="8K">8K</button>
            </div>
        </div>

        <!-- SECTION: CATEGORY -->
        <div class="sidebar-section">
            <p class="section-title" data-i18n="Category">{{ t('Category') }}</p>
            <div class="btn-grid icons">
                <button class="filter-btn icon-btn sidebar-nav-btn" data-target="section-home">
                    <img src="/static/icons/home.png" class="sidebar-icon" alt="Home" width="24" height="24" data-i18n="Home" data-i18n-attr="alt">
                    <span data-i18n="Home">{{ t('Home') }}</span>
                </button>
                <button class="filter-btn icon-btn sidebar-nav-btn" data-target="section-images">
                    <img src="/static/icons/picture.png" class="sidebar-icon" alt="Images" width="24" height="24" data-i18n="Images" data-i18n-attr="alt">
                    <span data-i18n="Images">{{ t('Images') }}</span>
                </button>
                <button class="filter-btn icon-btn sidebar-nav-btn ai-gen-btn" data-target="section-generator">
                    <svg class="sidebar-icon ai-sparkle-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L14.4 8.6L21 11L14.4 13.4L12 20L9.6 13.4L3 11L9.6 8.6L12 2Z" fill="white"/></svg>
                    <span data-i18n="Generate">Generate</span>
                </button>
            </div>
        </div>

        <!-- SECTION: SIZE -->
        <div class="sidebar-section">
            <p class="section-title" data-i18n="Size">{{ t('Size') }}</p>
            <div class="btn-grid icons" id="sidebarSizeGrid">
                <button class="filter-btn icon-btn" data-value="Horizontal">
                    <img src="/static/icons/horizontal.png" class="sidebar-icon" alt="Horizontal" width="24" height="24">
                    <span>desktop</span>
                </button>
                <button class="filter-btn icon-btn" data-value="Vertical">
                    <img src="/static/icons/vertical.png" class="sidebar-icon" alt="Vertical" width="24" height="24">
                    <span>mobile</span>
                </button>
                <button class="filter-btn icon-btn" data-value="Square">
                    <img src="/static/icons/stop-square.png" class="sidebar-icon" alt="Square" width="24" height="24">
                    <span>tablet</span>
                </button>
            </div>
        </div>

        <a href="#" class="sidebar-btn filter-trigger">
            <img src="/static/icons/filter.png" class="sidebar-icon" alt="Filter" width="24" height="24" data-i18n="Filter" data-i18n-attr="alt">
            <span class="sidebar-text" data-i18n="Filter">{{ t('Filter') }}</span>
        </a>

        <a href="#" class="sidebar-btn" id="savedBtn">
            <img src="/static/icons/bookmark.png" class="sidebar-icon" alt="Saved" width="24" height="24" data-i18n="Saved" data-i18n-attr="alt">
            <span class="sidebar-text" data-i18n="Saved">{{ t('Saved') }}</span>
        </a>

    </div>

    <!-- FIXED BOTTOM -->
    <div class="sidebar-fixed bottom">
        <a href="#" class="sidebar-btn" id="settingsBtn">
            <img src="/static/icons/settings.png" class="sidebar-icon" alt="Settings" width="24" height="24" data-i18n="Settings" data-i18n-attr="alt">
            <span class="sidebar-text" data-i18n="Settings">{{ t('Settings') }}</span>
        </a>
    </div>

    </aside>

    <aside class="right-sidebar">
        <div class="right-header">
            <h3 style="margin:0; font-size:1.1rem;" data-i18n="Menu">{{ t('Menu') }}</h3>
            <button class="menu-toggle" id="closeRight" style="display:flex; margin:0;" title="{{ t('Close') }}">&times;</button>
        </div>
        <div class="right-content">
            <!-- Language Switcher -->
            <div class="language-selector" style="padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px;">
                <select id="languageSelect" onchange="translationSystem.setLanguage(this.value)" style="width: 100%; padding: 8px; background: #333; color: white; border: 1px solid #444; border-radius: 6px;">
                    <option value="en">English</option>
                    <option value="fr">Français</option>
                    <option value="es">Español</option>
                    <option value="de">Deutsch</option>
                    <option value="pt">Português</option>
                </select>
            </div>

            <a href="#" class="right-link" id="myProfileBtn" data-i18n="My Profile">{{ t('My Profile') }}</a>
            {% if session.get('role') == 'admin' %}
            <a href="/admin" class="right-link" style="color: var(--primary);">{{ t('Admin Dashboard') }}</a>
            {% endif %}
            <a href="#" class="right-link filter-trigger" data-i18n="Filter">{{ t('Filter') }}</a>
            <a href="#" class="right-link settings-trigger" data-i18n="Settings">{{ t('Settings') }}</a>
            <a href="#" class="right-link" onclick="openSettings('support'); return false;" data-i18n="Help & Support">{{ t('Help & Support') }}</a>
        </div>
        <div class="right-footer">
            {% if not session.get('user_id') %}
            <a href="#" class="nav-btn signup-trigger" data-i18n="Join Community">{{ t('Join Community') }}</a>
            <a href="#" class="nav-btn secondary login-trigger" data-i18n="Login">{{ t('Login') }}</a>
            {% else %}
            <a href="/logout" class="nav-btn secondary" data-i18n="Logout" onclick="localStorage.removeItem('user_session');">{{ t('Logout') }}</a>
            {% endif %}
        </div>
    </aside>

    <nav class="navbar">
        <button class="menu-toggle" type="button" aria-label="{{ t('Toggle menu') }}">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <a href="/" class="logo">
            <img src="/static/wallpeperspheredark.jpg" alt="Logo" class="nav-logo-img" width="38" height="38">
            <!-- Brand name is spelled 'wallpepersphere' with an 'e', not 'wallpapersphere' -->
            <span class="brand-text">wallp<span id="animE">e</span>persphere</span>
        </a>
        <div class="nav-actions">
            <button class="mobile-search-btn" id="mobileSearchBtn" type="button" aria-label="{{ t('Search') }}">
                <svg class="sidebar-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>
            <div class="search-wrapper">
                <div class="search-category-wrapper">
                    <button class="search-category-btn" id="searchCatBtn" type="button">
                        <span class="search-category-text">{{ t('All') }}</span> <span class="material-icons" style="font-size: 18px;">arrow_drop_down</span>
                    </button>
                    <div class="search-category-dropdown" id="searchCatDropdown">
                        <!-- Options injected via JS -->
                    </div>
                </div>
                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" class="search-input" placeholder="{{ t('Search images...') }}" data-i18n="Search images..." data-i18n-attr="placeholder">
                <button class="search-action-btn filter-trigger" title="{{ t('Filter') }}" data-i18n="Filter" data-i18n-attr="title">
                    <img src="/static/icons/filter.png" style="width: 20px; filter: brightness(0) invert(1);" alt="Filter" width="20" height="20">
                </button>
            </div>
            <!-- Share Search Results Button (PC Only) -->
            <div id="shareSearchResultsContainer" style="position: relative; display: none;">
                <button id="shareSearchResultsBtn" class="icon-nav-btn" title="Share Results" data-i18n="Share Results" data-i18n-attr="title">
                    <span class="material-icons" style="font-size: 20px;">share</span>
                </button>
            </div>
            <button class="icon-nav-btn right-menu-btn" id="rightMenuToggle" type="button" aria-label="{{ t('User menu') }}">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
            </button>
            {% if not session.get('user_id') %}
            <a href="#" class="nav-btn signup-trigger" data-i18n="Join">{{ t('Join') }}</a>
            {% else %}
            <button class="nav-btn" id="uploadNavBtn" type="button" style="display:  flex; width: 125px; align-items: center; gap: 8px; cursor: pointer;">
                <img src="/static/icons/upload.png" style="width: 20px; filter: brightness(0) invert(1);" alt="Upload" width="20" height="20">
                <span data-i18n="Upload">{{ t('Upload') }}</span>
            </button>
            {% endif %}
        </div>
    </nav>

    <div class="nav-tabs-container" id="navTabsContainer">
        <!-- Injected via JS -->
    </div>
    <button class="nav-tab-plus-btn" id="navPlusBtn" aria-label="{{ t('More categories') }}">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>
    <div class="nav-tab-dropdown" id="navTabDropdown"></div>

    <div class="layout-wrapper">
        <!-- Background Shapes (PC Only) -->
        <div class="background-shapes desktop-view" aria-hidden="true">
            <svg class="shape shape-triangle" width="40" height="40" viewBox="0 0 40 40"><path d="M20 5 L35 35 L5 35 Z" fill="none" stroke="var(--primary)" stroke-width="2" opacity="0.5"/></svg>
            <svg class="shape shape-circle" width="30" height="30" viewBox="0 0 30 30"><circle cx="15" cy="15" r="12" fill="none" stroke="var(--text-secondary)" stroke-width="2" opacity="0.5"/></svg>
            <svg class="shape shape-cross" width="30" height="30" viewBox="0 0 30 30"><path d="M10 10 L20 20 M20 10 L10 20" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" opacity="0.5"/></svg>
            <svg class="shape shape-driver" width="60" height="60" viewBox="0 0 60 60"><rect x="15" y="15" width="30" height="30" rx="8" fill="none" stroke="var(--text-secondary)" stroke-width="2" stroke-dasharray="4 4"/></svg>
            <svg class="shape shape-squiggle" width="50" height="50" viewBox="0 0 50 50"><path d="M10 25 Q 25 10 40 25 T 70 25" fill="none" stroke="var(--primary)" stroke-width="2" opacity="0.4"/></svg>
        </div>
        <main class="main-content">
            <!-- HOME SECTION -->
            <div id="section-home" class="content-section" {% if search_query or current_page > 1 %}style="display: none;"{% endif %}>
                <!-- Integrated Hero Section -->
                <div class="hero-section">
                    <img src="/static/hero.webp" alt="" class="hero-bg-image desktop-view" fetchpriority="high">
                    <!-- Hero Animation Shapes (PC Only) -->
                    <div class="hero-floating-shapes desktop-view">
                        <div class="hero-shape shape-orb"></div>
                        <div class="hero-shape shape-diamond"></div>
                        <div class="hero-shape shape-ring"></div>
                    </div>
                    <div class="banner-deco mobile-view" aria-hidden="true">
                        <svg class="deco-shape deco-1" width="80" height="80" viewBox="0 0 80 80"><circle cx="40" cy="40" r="30" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="6"/></svg>
                        <svg class="deco-shape deco-2" width="60" height="60" viewBox="0 0 60 60"><rect x="10" y="10" width="40" height="40" transform="rotate(15 30 30)" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="4"/></svg>
                    </div>
                    <div class="hero-left">
                        <h1 class="hero-title-box">{{ t('Free 4K Wallpapers & High Quality Backgrounds') }}</h1>
                        <div class="hero-subtitle-box">
                            {{ t('Download the best HD and Ultra HD wallpapers for desktop, mobile, and tablets.') }}<br>
                            {{ t('Explore our curated collection of aesthetic, nature, and abstract images.') }}
                            
                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 20px; color: #4caf50; font-weight: 600; font-size: 1rem;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                <span>{{ t('100% Free for Personal Use') }}</span>
                            </div>
                        </div>
                        <div class="hero-search-wrapper">
                            <svg class="hero-search-icon" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <input type="text" placeholder="{{ t('Search wallpapers...') }}" data-i18n="Search wallpapers..." data-i18n-attr="placeholder" />
                            <div class="hero-search-actions">
                                <div class="hero-icon-btn filter-trigger" title="{{ t('Filter') }}" data-i18n="Filter" data-i18n-attr="title"><img src="/static/icons/filter.png" style="width: 20px; filter: brightness(0) invert(1);" alt="Filter" width="20" height="20"></div>
                                <div class="hero-icon-btn desktop-view" title="{{ t('More options') }}" data-i18n="More options" data-i18n-attr="title" onclick="document.querySelector('.sidebar-nav-btn[data-target=\'section-images\']').click()"><img src="/static/icons/apps.png" style="width: 20px; filter: brightness(0) invert(1);" alt="Options" width="20" height="20"></div>
                                <div class="hero-icon-btn sidebar-nav-btn ai-gen-btn" data-target="section-generator" title="AI Generate" style="cursor: pointer;">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L14.4 8.6L21 11L14.4 13.4L12 20L9.6 13.4L3 11L9.6 8.6L12 2Z" fill="white"/></svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="hero-right">
                        <!-- Server-side rendered hero images for LCP optimization -->
                        {% if seo_assets %}
                            {% for asset in seo_assets[:4] %}
                            <div class="hero-img-box" onclick='openImageViewer({{ asset|tojson }}, 0, [{{ asset|tojson }}])'>
                                <img src="{% if r2_domain %}{{ r2_domain }}/{% else %}/uploads/{% endif %}{{ asset.link_small }}" 
                                     alt="{{ asset.name }}" 
                                     style="width: 100%; height: 100%; object-fit: cover;"
                                     loading="eager">
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <div class="desktop-view">
                    {% include 'libary section.html' %}
                </div>

                <div id="dynamic-sections-container">
                    <!-- Dynamic sections will be loaded here via JavaScript -->
                </div>
                <div id="home-feed-container"></div>

                <!-- SEO: Server-Side Rendered Asset Details -->
                <!-- This ensures crawlers see the content immediately without waiting for JS -->
                {% if view_asset %}
                <noscript>
                <div class="seo-asset-content">
                    <h1>{{ view_asset.name }}</h1>
                    <img src="{{ r2_domain }}/{{ view_asset.link_medium }}" alt="{{ view_asset.name }}">
                    <p>{{ view_asset.description }}</p>
                    <ul>
                        <li>Artist: {{ view_asset.username or 'Community' }}</li>
                        <li>Resolution: {{ view_asset.resolution }}</li>
                        <li>License: Free for Personal Use</li>
                        <li>Category: {{ view_asset.category }}</li>
                        <li>Keywords: {{ view_asset.key_word }}</li>
                    </ul>
                    <a href="/download/{{ view_asset.category_type }}/{{ view_asset.id }}">Download {{ view_asset.name }}</a>
                </div>
                </noscript>
                {% endif %}
            </div>

            <!-- PROFILE SECTION (Injected Here) -->
            <div id="section-profile" class="content-section" style="display: none;"></div>

            <!-- PUBLIC USER PROFILE SECTION -->
            <div id="section-public-profile" class="content-section" style="display: none;">
                <div class="profile-header-banner" style="padding: 40px 20px; text-align: center; background: var(--bg-surface); margin-bottom: 30px; border-radius: 24px; border: 1px solid var(--border-color); position: relative;">
                    <button class="profile-back-btn" id="publicProfileBackBtn" title="{{ t('Back') }}" style="position: absolute; top: 20px; left: 20px; background: var(--hover-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    </button>
                    <button class="copy-link-btn" id="publicProfileCopyBtn" title="{{ t('Profile_Copy_Link') }}" style="position: absolute; top: 20px; right: 20px; background: var(--hover-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                    </button>
                    <div class="profile-avatar-large" style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; margin: 0 auto 20px; border: 4px solid #3d85ff; background: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                        <img id="publicProfileAvatar" src="" style="width: 100%; height: 100%; object-fit: cover;" width="120" height="120" alt="User Avatar">
                    </div>
                    <h2 id="publicProfileName" style="color: var(--text-primary); margin: 0 0 10px 0; font-size: 2.2rem; font-weight: 700;">{{ t('User Name') }}</h2>
                    <p id="publicProfileStats" style="color: var(--text-secondary); margin: 0 auto 15px; font-size: 0.95rem; font-weight: 500;"></p>
                    <p id="publicProfileBio" style="color: var(--text-secondary); margin: 0 auto 20px; max-width: 600px; line-height: 1.6; font-size: 1rem; display: none;"></p>
                    
                    <div id="publicProfileSocials" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                        <!-- Social Links Injected Here -->
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button id="publicProfileFollowBtn" class="nav-btn" style="display: none; width: auto; padding: 0 25px; align-items: center; gap: 8px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            <span>{{ t('Follow') }}</span>
                        </button>
                        <a id="publicProfileContactBtn" href="#" class="nav-btn secondary" style="display: none; width: auto; padding: 0 25px;">{{ t('Contact') }}</a>
                    </div>
                </div>
                <div class="gallery-grid" id="public-profile-grid"></div>
            </div>

            <!-- IMAGES SECTION -->
            <div id="section-images" class="content-section" style="{% if current_page > 1 %}display: block;{% else %}display: none;{% endif %}">
                <div class="welcome-banner">
                    <h2 class="welcome-title">{{ t('Download Free 4K Wallpapers') }}</h2>
                    <p class="welcome-text">
                        {{ t('Browse thousands of high-quality backgrounds for your iPhone, Android, or Desktop.') }}<br>
                    </p>
                    
                    <div class="welcome-search-box">
                        <svg class="welcome-search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" class="welcome-search-input" placeholder="{{ t('Search for free photos') }}" data-i18n="Search for free photos" data-i18n-attr="placeholder">
                        <button type="button" id="welcomeSearchBtn" class="welcome-search-btn" aria-label="{{ t('Search') }}" style="background: transparent; box-shadow: none; border: none;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </button>
                    </div>

                    <div class="welcome-license" style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 25px; color: #4caf50; font-size: 0.95rem; font-weight: 500;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        <span>{{ t('All images are free for personal use') }}</span>
                    </div>
                </div>
                <div class="gallery-grid">
                    <!-- Images will be loaded here dynamically -->
                    <!-- SEO: Fallback for Crawlers -->
                    <noscript>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                        {% for asset in seo_assets %}
                            <div class="static-card">
                                <a href="{{ asset.view_url }}">
                                    <img src="{{ r2_domain }}/{{ asset.link_small }}" alt="{{ asset.name }}" style="width: 100%; height: auto;">
                                    <h3>{{ asset.name }}</h3>
                                </a>
                            </div>
                        {% endfor %}
                        </div>
                        {% if seo_assets|length >= 20 %}
                        <div class="pagination"><a href="?page={{ current_page + 1 }}">Next Page &raquo;</a></div>
                        {% endif %}
                    </noscript>
                </div>
            </div>

            <!-- SAVED SECTION -->
            <div id="section-saved" class="content-section" style="display: none;">
                <div class="section-header" style="padding: 0 0 20px 0;">
                    <h2 style="margin: 0; font-size: 1.5rem;">{{ t('Saved Items') }}</h2>
                </div>
                <div class="gallery-grid" id="saved-grid">
                    <!-- Saved items will be loaded here -->
                </div>
                <div class="empty-state" id="saved-empty" style="display: none;">
                    <h2>{{ t('No saved items yet') }}</h2>
                    <p>{{ t('Bookmark items to see them here.') }}</p>
                </div>
            </div>

            <!-- SEARCH SECTION -->
            <div id="section-search" class="content-section" style="{% if search_query %}display: block;{% else %}display: none;{% endif %}">
                <div class="section-header" style="padding: 0 0 20px 0;">
                    <h2 style="margin: 0; font-size: 1.5rem;" id="search-header-title">
                        {% if search_query %}
                            {{ search_query|capitalize }} <span style="color: #888; font-size: 1rem; font-weight: 400; margin-left: 10px;">{{ result_count }} results</span>
                        {% else %}
                            {{ t('Search Results') }}
                        {% endif %}
                    </h2>
                </div>
                <div class="gallery-grid">
                    <!-- Search results will be loaded here -->
                </div>
            </div>

            <!-- GENERATOR SECTION -->
            <div id="section-generator" class="content-section" style="display: none;"></div>

            <!-- SETTINGS SECTION -->
            <div id="section-settings" class="content-section" style="display: none;">
            </div>
        </main>
    </div>
 <script>
        // R2 Domain for JS
        const R2_DOMAIN = "{{ r2_domain }}";

        // Check if we should force-open a viewer
        if(window.SERVER_CONFIG && window.SERVER_CONFIG.viewAsset){
            const style = document.createElement('style');
                style.textContent = 'html, body { overflow: hidden !important; }';
                style.id = 'temp-lock-css';
                (document.head || document.documentElement).appendChild(style);
        }

    
    

        // State flags for lazy loading
        let homeLoaded = false;
        let savedLoaded = false;
        
        window.refreshSavedAssets = function() {
            savedLoaded = false;
            const savedSection = document.getElementById('section-saved');
            if (savedSection && savedSection.style.display === 'block') {
                loadSavedAssets();
            }
        };

        // Image Gallery State
        let imageState = {
            offset: (window.SERVER_CONFIG && window.SERVER_CONFIG.currentPage > 1) ? (window.SERVER_CONFIG.currentPage - 1) * 20 : 0,
            loading: false,
            hasMore: true,
            loaded: false
        };

        // Search State
        let searchState = {
            offset: 0,
            loading: false,
            hasMore: true,
            currentParams: null
        };

        // Public Profile State
        let publicProfileState = {
            offset: 0,
            loading: false,
            hasMore: true,
            loaded: false,
            currentUserId: null
        };
        let profileImages = [];

        // Home Feed State
        let homeFeedState = {
            loading: false,
            error: false,
            currentConfig: null,
            queue: [
                { type: 'size', value: 'Vertical', title: 'Mobile Wallpapers', icon: 'vertical.png' },
                { type: 'size', value: 'Horizontal', title: 'Desktop Backgrounds', icon: 'horizontal.png' },
                { type: 'size', value: 'Square', title: 'Social & Tablet', icon: 'stop-square.png' }
            ],
            categoryIndex: 0
        };

     // Helper to get dimensions from resolution string
     function getDimensions(resolution) {
         if (!resolution) return { w: 800, h: 600 };
         const parts = resolution.toLowerCase().split('x');
         if (parts.length === 2) {
             const w = parseInt(parts[0]);
             const h = parseInt(parts[1]);
             if (!isNaN(w) && !isNaN(h)) return { w, h };
         }
         return { w: 800, h: 600 };
     }

     // Helper for image URL logic (PC = Small, Mobile = Tiny)
     function getGridImageUrl(asset) {
         const isMobile = window.innerWidth <= 768;
         const domain = (typeof R2_DOMAIN !== 'undefined' && R2_DOMAIN) ? R2_DOMAIN : '/uploads';
         const prefix = domain.endsWith('/') ? domain : domain + '/';
         
         // Define available sources with fallbacks
         const tiny = asset.link_tiny ? `${prefix}${asset.link_tiny}` : null;
         const small = asset.link_small ? `${prefix}${asset.link_small}` : null;
         const medium = asset.link_medium ? `${prefix}${asset.link_medium}` : null;
         const original = asset.link_original ? `${prefix}${asset.link_original}` : null;

         if (isMobile) {
             // Mobile: Tiny -> Small -> Medium -> Original
             return tiny || small || medium || original || '';
         } else {
             // Desktop: Small -> Medium -> Tiny -> Original
             return small || medium || tiny || original || '';
         }
     }
     window.getGridImageUrl = getGridImageUrl;

        // Pagination State
        const connectionText = document.getElementById('connectionText');
        const connectionRetryBtn = document.getElementById('connectionRetryBtn');
        const connectionIcon = document.getElementById('connectionIcon');
        let isOffline = !navigator.onLine;

        function updateConnectionStatus() {
            if (navigator.onLine) {
                if (isOffline) {
                    // Back Online
                }
                isOffline = false;
            } else {
                isOffline = true;
            }
        }

        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        
        connectionRetryBtn.addEventListener('click', () => {
            if (navigator.onLine) updateConnectionStatus();
        });

        // --- ERROR TRANSLATION HELPER ---
        function getTranslatedError(errorCode, defaultMessage = "An unexpected error occurred.") {
            if (!errorCode) return defaultMessage;
            
            // Handle special security alert format from backend
            if (typeof errorCode === 'string' && errorCode.startsWith('SECURITY ALERT:')) {
                const reason = errorCode.split('SECURITY ALERT:')[1].trim();
                // Use a specific translation key for the base security alert message
                const baseText = window.translationSystem.t('ERR_SECURITY_ALERT_BASE', "Upload blocked. The image was flagged for: {reason}.");
                return baseText.replace('{reason}', reason);
            }

            const key = `ERR_${errorCode}`;
            // Use the translation system's 't' function, which should be globally available
            const translated = window.translationSystem.t(key, null);

            // If translation exists and is not the key itself, use it. Otherwise, use the default.
            return (translated && translated !== key) ? translated : defaultMessage;
        }

        // --- ERROR CARD HELPER ---
        function createErrorCard(container, errorCode, retryFn) {
            const message = getTranslatedError(errorCode, "{{ t('We could not load the content. Please check your internet connection.') }}");
            container.innerHTML = `
                <div class="error-state-card">
                    <div class="error-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                    </div>
                    <h3 data-i18n="Oops!">{{ t('Oops!') }}</h3>
                    <p>${message}</p>
                    ${retryFn ? `<button class="retry-btn" data-i18n="Try Again">${"{{ t('Try Again') }}"}</button>` : ''}
                </div>
            `;
            // Re-apply translations for the newly created elements
            if (window.translationSystem) window.translationSystem.applyTranslations(window.translationSystem.currentLang);
            
            const btn = container.querySelector('.retry-btn');
            if(btn && retryFn) btn.onclick = retryFn;
        }

        // --- GLOBAL ERROR DISPLAY ---
        window.showGlobalError = function(errorCode) {
            const modal = document.getElementById('generalErrorModal');
            const msgEl = document.getElementById('generalErrorMessage');
            if (modal && msgEl) {
                msgEl.textContent = getTranslatedError(errorCode, "An unexpected error occurred. Please try again.");
                modal.classList.add('active');
            } else {
                // Fallback to alert if modal isn't ready
                alert(getTranslatedError(errorCode, "An unexpected error occurred. Please try again."));
            }
        }

        // --- MOBILE PERFORMANCE HELPER ---
        let lastScrollPosition = 0;
        function toggleMobileBackground(show) {
            if (window.innerWidth > 768) return;
            
            const body = document.body;
            if (show) {
                lastScrollPosition = window.scrollY;
                body.classList.add('mobile-modal-open');
            } else {
                body.classList.remove('mobile-modal-open');
                // Small timeout to allow DOM to reappear before scrolling
                setTimeout(() => {
                    window.scrollTo(0, lastScrollPosition);
                }, 50);
            }
        }

        const CATEGORIES_DB = {
            "en": ["Abstract", "Aesthetic", "AI Art", "Airplanes", "Animals", "Anime", "Architecture", "Art", "Astronomy", "Backgrounds", "Beach", "Biology", "Business", "Cars", "Cartoons", "Celebrities", "City", "Cityscape", "Clouds", "Computers", "Concept Art", "Creative", "Cyberpunk", "Dark", "Design", "Digital Art", "Education", "Fantasy", "Fashion", "Film", "Flowers", "Food", "Forest", "Futuristic", "Gaming", "Geometric", "Gradients", "Graphics", "Health", "Holidays", "Home", "Icons", "Illustrations", "Industrial", "Interiors", "Landscape Photography", "Landscapes", "Lifestyle", "Love", "Macro", "Minimal", "Mountains", "Music", "Nature", "Neon", "Night", "Ocean", "Patterns", "People", "Pets", "Photography", "Portraits", "Quotes", "Retro", "Robotics", "Sci-Fi", "Seasons", "Sky", "Social Media", "Space", "Sports", "Street", "Street Photography", "Surreal", "Technology", "Textures", "Time-lapse", "Travel", "Typography", "Underwater", "Urban", "Vector", "Vehicles", "Vintage", "Water", "Waterfalls", "Weather", "Wildlife", "Winter", "Woods", "Zen"],
            "fr": ["Abstrait", "Esthétique", "Art IA", "Avions", "Animaux", "Anime", "Architecture", "Art", "Astronomie", "Arrière-plans", "Plage", "Biologie", "Affaires", "Voitures", "Dessins animés", "Célébrités", "Ville", "Paysage urbain", "Nuages", "Ordinateurs", "Art conceptuel", "Créatif", "Cyberpunk", "Sombre", "Design", "Art numérique", "Éducation", "Fantaisie", "Mode", "Film", "Fleurs", "Nourriture", "Forêt", "Futuriste", "Jeu vidéo", "Géométrique", "Dégradés", "Graphisme", "Santé", "Vacances", "Maison", "Icônes", "Illustrations", "Industriel", "Intérieurs", "Photographie de paysage", "Paysages", "Style de vie", "Amour", "Macro", "Minimaliste", "Montagnes", "Musique", "Nature", "Néons", "Nuit", "Océan", "Motifs", "Gens", "Animaux de compagnie", "Photographie", "Portraits", "Citations", "Rétro", "Robotique", "Science-fiction", "Saisons", "Ciel", "Réseaux sociaux", "Espace", "Sports", "Rue", "Photographie de rue", "Surréaliste", "Technologie", "Textures", "Time-lapse", "Voyage", "Typographie", "Sous-marin", "Urbain", "Vecteur", "Véhicules", "Vintage", "Eau", "Cascades", "Météo", "Faune", "Hiver", "Bois", "Zen"],
            "es": ["Abstracto", "Estético", "Arte IA", "Aviones", "Animales", "Anime", "Arquitectura", "Arte", "Astronomía", "Fondos", "Playa", "Biología", "Negocios", "Coches", "Dibujos animados", "Celebridades", "Ciudad", "Paisaje urbano", "Nubes", "Ordenadores", "Arte conceptual", "Creativo", "Cyberpunk", "Oscuro", "Diseño", "Arte digital", "Educación", "Fantasía", "Moda", "Cine", "Flores", "Comida", "Bosque", "Futurista", "Gaming", "Geométrico", "Degradados", "Gráficos", "Salud", "Vacaciones", "Hogar", "Iconos", "Ilustraciones", "Industrial", "Interiores", "Fotografía de paisaje", "Paisajes", "Estilo de vida", "Amor", "Macro", "Minimalista", "Montañas", "Música", "Naturaleza", "Neón", "Noche", "Océano", "Patrones", "Gente", "Mascotas", "Fotografía", "Retratos", "Citas", "Retro", "Robótica", "Ciencia ficción", "Estaciones", "Cielo", "Redes sociales", "Espacio", "Deportes", "Calle", "Fotografía callejera", "Surrealista", "Tecnología", "Texturas", "Time-lapse", "Viajes", "Tipografía", "Submarino", "Urbano", "Vector", "Vehículos", "Vintage", "Agua", "Cascadas", "Clima", "Vida silvestre", "Invierno", "Bosque", "Zen"],
            "de": ["Abstrakt", "Ästhetisch", "KI-Kunst", "Flugzeuge", "Tiere", "Anime", "Architektur", "Kunst", "Astronomie", "Hintergründe", "Strand", "Biologie", "Geschäft", "Autos", "Cartoons", "Prominente", "Stadt", "Stadtbild", "Wolken", "Computer", "Konzeptkunst", "Kreativ", "Cyberpunk", "Dunkel", "Design", "Digitale Kunst", "Bildung", "Fantasie", "Mode", "Film", "Blumen", "Essen", "Wald", "Futuristisch", "Gaming", "Geometrisch", "Farbverläufe", "Grafiken", "Gesundheit", "Feiertage", "Zuhause", "Symbole", "Illustrationen", "Industriell", "Innenräume", "Landschaftsfotografie", "Landschaften", "Lebensstil", "Liebe", "Makro", "Minimal", "Berge", "Musik", "Natur", "Neon", "Nacht", "Ozean", "Muster", "Menschen", "Haustiere", "Fotografie", "Porträts", "Zitate", "Retro", "Robotik", "Sci-Fi", "Jahreszeiten", "Himmel", "Soziale Medien", "Weltraum", "Sport", "Straße", "Straßenfotografie", "Surreal", "Technologie", "Texturen", "Zeitraffer", "Reisen", "Typografie", "Unterwasser", "Urban", "Vektor", "Fahrzeuge", "Vintage", "Wasser", "Wasserfälle", "Wetter", "Tierwelt", "Winter", "Wald", "Zen"],
            "pt": ["Abstrato", "Estético", "Arte IA", "Aviões", "Animais", "Anime", "Arquitetura", "Arte", "Astronomia", "Planos de Fundo", "Praia", "Biologia", "Negócios", "Carros", "Desenhos", "Celebridades", "Cidade", "Paisagem Urbana", "Nuvens", "Computadores", "Arte Conceitual", "Criativo", "Cyberpunk", "Escuro", "Design", "Arte Digital", "Educação", "Fantasia", "Moda", "Filme", "Flores", "Comida", "Floresta", "Futurista", "Jogos", "Geométrico", "Degradês", "Gráficos", "Saúde", "Feriados", "Casa", "Ícones", "Ilustrações", "Industrial", "Interiores", "Fotografia de Paisagem", "Paisagens", "Estilo de Vida", "Amor", "Macro", "Minimalista", "Montanhas", "Música", "Natureza", "Neon", "Noite", "Oceano", "Padrões", "Pessoas", "Animais de Estimação", "Fotografia", "Retratos", "Citações", "Retrô", "Robótica", "Ficção Científica", "Estações", "Céu", "Redes Sociais", "Espaço", "Esportes", "Rua", "Fotografia de Rua", "Surreal", "Tecnologia", "Texturas", "Time-lapse", "Viagem", "Tipografia", "Subaquático", "Urbano", "Vetor", "Veículos", "Vintage", "Água", "Cachoeiras", "Clima", "Vida Selvagem", "Inverno", "Bosque", "Zen"]
        };

        let categoriesList = CATEGORIES_DB['en'];

        // Function to re-render all category-dependent UI elements
        function renderCategoryWidgets() {
            // 1. Re-init Search Dropdown
            initSearchDropdown();
            
            // 2. Re-init Nav Tabs
            initNavTabs();
            
            // 3. Clear Category Modal Grid so it regenerates with new language on next open
            const grid = document.getElementById('categoryGrid');
            if(grid) grid.innerHTML = '';
        }

        let selectedRes = null;
        let selectedSize = null;
        let selectedCat = null;
        let selectedSort = 'newest';

        function initSearchDropdown() {
            const searchCatBtn = document.getElementById('searchCatBtn');
            const searchCatDropdown = document.getElementById('searchCatDropdown');

            if(searchCatBtn && searchCatDropdown) {
                // Generate Options: Wallpaper, 4K Images, + 4 Random
                const fixedOptions = ['Wallpaper', '4K Images'];
                const randomPool = categoriesList.filter(c => !fixedOptions.includes(c));
                const randomOptions = [];
                for(let i=0; i<4; i++) {
                    if(randomPool.length === 0) break;
                    const randomIndex = Math.floor(Math.random() * randomPool.length);
                    randomOptions.push(randomPool[randomIndex]);
                    randomPool.splice(randomIndex, 1);
                }
                const dropdownOptions = [...fixedOptions, ...randomOptions];

                // Clear and Populate
                searchCatDropdown.innerHTML = '';
                dropdownOptions.forEach(opt => {
                    const div = document.createElement('div');
                    div.className = 'cat-option';
                    div.textContent = opt;
                    div.addEventListener('click', () => {
                        const searchInput = document.querySelector('.search-input');
                        if(searchInput) {
                            searchInput.value = opt;
                            selectedCat = null;
                            updateFilterActiveState();
                            window.performSearch();
                        }
                        searchCatDropdown.classList.remove('active');
                    });
                    searchCatDropdown.appendChild(div);
                });

                if (searchCatBtn.dataset.hasListener) return;
                searchCatBtn.dataset.hasListener = 'true';

                searchCatBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    searchCatDropdown.classList.toggle('active');
                });

                document.addEventListener('click', (e) => {
                    if (!searchCatBtn.contains(e.target) && !searchCatDropdown.contains(e.target)) {
                        searchCatDropdown.classList.remove('active');
                    }
                });
            }
        }
            

        document.addEventListener('DOMContentLoaded', () => {
            let lastSearchParams = '';

            // --- SEARCH LOGIC ---
            const searchInput = document.querySelector('.search-input');
            
            // Deep Linking: Initialize filters from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('category')) selectedCat = urlParams.get('category');
            if (urlParams.has('resolution')) selectedRes = urlParams.get('resolution');
            if (urlParams.has('size')) selectedSize = urlParams.get('size');
            if (urlParams.has('sort')) selectedSort = urlParams.get('sort');
            lastSearchParams = urlParams.toString();
            
            // Update UI to reflect active filters
            if (typeof updateFilterActiveState === 'function') updateFilterActiveState();

            // --- SHARE SEARCH LOGIC ---
            const shareBtnContainer = document.getElementById('shareSearchResultsContainer');
            const shareBtn = document.getElementById('shareSearchResultsBtn');

            // Robust Copy Function (Works on HTTP and HTTPS)
            async function copyToClipboard(text) {
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(text);
                    } else {
                        // Fallback for HTTP/Older Browsers
                        const textArea = document.createElement("textarea");
                        textArea.value = text;
                        textArea.style.position = "fixed";
                        textArea.style.left = "-9999px";
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        try {
                            document.execCommand('copy');
                        } catch (err) {
                            console.error('Fallback copy failed', err);
                            prompt("Copy this link:", text);
                            return;
                        }
                        document.body.removeChild(textArea);
                    }
                    
                    // Visual Feedback
                    if (shareBtn) {
                        const originalColor = shareBtn.style.color;
                        shareBtn.style.color = '#4caf50';
                        const icon = shareBtn.querySelector('.material-icons');
                        if(icon) icon.textContent = 'check';
                        
                        setTimeout(() => {
                            if (shareBtn) shareBtn.style.color = originalColor;
                            if (icon) icon.textContent = 'share';
                        }, 2000);
                    }
                } catch (err) {
                    console.error('Failed to copy', err);
                    prompt("Copy this link:", text);
                }
            }

            if (shareBtnContainer && shareBtn) {
                const shareHandler = () => {
                    // Ensure we have params
                    if (!lastSearchParams && searchInput) {
                         const rawQuery = searchInput.value.trim();
                         if(rawQuery) lastSearchParams = `q=${encodeURIComponent(rawQuery)}`;
                    }
                    
                    const shareUrl = `${window.location.origin}/search?${lastSearchParams}`;
                    copyToClipboard(shareUrl);
                };

                // Direct Click
                shareBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    shareHandler();
                });
            }

            // Check for server-side search query
            const serverQuery = window.SERVER_CONFIG ? window.SERVER_CONFIG.searchQuery : null;
            if (serverQuery && searchInput) {
                searchInput.value = serverQuery;
                // Trigger search to load grid (client-side fetch)
                setTimeout(() => {
                    if (typeof window.performSearch === 'function') window.performSearch(false);
                }, 100);
            }

            const heroSearchInput = document.querySelector('.hero-search-wrapper input');

            if (heroSearchInput) {
                heroSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (searchInput) {
                            searchInput.value = heroSearchInput.value;
                            window.performSearch();
                        }
                    }
                });
                heroSearchInput.addEventListener('input', (e) => {
                    if (searchInput) searchInput.value = e.target.value;
                });
            }
            
            const welcomeSearchInput = document.querySelector('.welcome-search-input');
            if (welcomeSearchInput) {
                welcomeSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (searchInput) {
                            searchInput.value = welcomeSearchInput.value;
                            window.performSearch();
                        }
                    }
                });
            }

            const welcomeSearchBtn = document.getElementById('welcomeSearchBtn');
            if (welcomeSearchBtn && welcomeSearchInput) {
                welcomeSearchBtn.addEventListener('click', () => {
                    if (searchInput) {
                        searchInput.value = welcomeSearchInput.value;
                        window.performSearch();
                    }
                });
            }

            // Helper: Levenshtein Distance for fuzzy matching (Orthography)
            function getLevenshteinDistance(a, b) {
                if (a.length === 0) return b.length;
                if (b.length === 0) return a.length;
                const matrix = [];
                for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
                for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
                for (let i = 1; i <= b.length; i++) {
                    for (let j = 1; j <= a.length; j++) {
                        if (b.charAt(i - 1) === a.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1));
                        }
                    }
                }
                return matrix[b.length][a.length];
            }

            function findClosestMatch(word, options) {
                let bestMatch = null;
                let minDistance = Infinity;
                // Allow 1 typo for short words, 2 for longer
                const threshold = word.length > 4 ? 2 : 1; 
                
                options.forEach(opt => {
                    const dist = getLevenshteinDistance(word.toLowerCase(), opt.toLowerCase());
                    if (dist < minDistance && dist <= threshold) {
                        minDistance = dist;
                        bestMatch = opt;
                    }
                });
                return bestMatch;
            }

            // Helper: Get English Category for API
            function getEnglishCategory(term) {
                if (!term) return '';
                const lang = window.translationSystem ? window.translationSystem.currentLang : 'en';
                if (CATEGORIES_DB[lang]) {
                    const index = CATEGORIES_DB[lang].indexOf(term);
                    if (index !== -1 && CATEGORIES_DB['en'][index]) {
                        return CATEGORIES_DB['en'][index];
                    }
                }
                return term;
            }

            window.performSearch = function(pushToHistory = true) {
                if (!searchInput) return;
                let rawQuery = searchInput.value.trim();

                // Reset Search State
                searchState = {
                    offset: 0,
                    loading: false,
                    hasMore: true,
                    currentParams: null
                };
                
                // Mobile Optimization: Dismiss keyboard and scroll to top for immediate view
                if(searchInput) searchInput.blur();
                window.scrollTo(0, 0);
                
                // Define known filters
                const knownResolutions = ['4K', '8K', '2K', 'HD', 'FHD'];
                const knownSizes = ['Vertical', 'Horizontal', 'Square'];
                
                let detectedRes = selectedRes;
                let detectedSize = selectedSize;
                let detectedCat = selectedCat;

                // The rawQuery is now sent directly. The backend handles analysis.
                // Build Query Params
                const params = new URLSearchParams();
                if(rawQuery) params.append('q', rawQuery);
                if(detectedCat) params.append('category', getEnglishCategory(detectedCat));
                if(detectedRes) params.append('resolution', detectedRes);
                if(detectedSize) params.append('size', detectedSize);
                if(selectedSort) params.append('sort', selectedSort);

                // Store base params for pagination
                searchState.currentParams = new URLSearchParams(params);

                // Add pagination for first fetch (10 items)
                params.append('limit', 10);
                params.append('offset', 0);

                lastSearchParams = params.toString();

                // Update URL bar to reflect search state (Deep Linking)
                if (pushToHistory) {
                    const newUrl = `${window.location.pathname}?${lastSearchParams}`;
                    window.history.pushState({path: newUrl, isSearch: true}, '', newUrl);
                }

                // Show/Hide Share Button
                const shareBtnContainer = document.getElementById('shareSearchResultsContainer');
                if (shareBtnContainer) {
                    const hasQueryOrFilters = rawQuery || detectedCat || detectedRes || detectedSize;
                    shareBtnContainer.style.display = hasQueryOrFilters ? 'block' : 'none';
                }
                
                // Switch to search section to show results
                document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
                const searchSection = document.getElementById('section-search');
                searchSection.style.display = 'block';

                const grid = searchSection.querySelector('.gallery-grid');
                // Clear any existing gallery intervals from previous search
                grid.querySelectorAll('.user-search-card').forEach(card => {
                    if (card.dataset.galleryIntervalId) {
                        clearInterval(parseInt(card.dataset.galleryIntervalId));
                    }
                });
                
                grid.innerHTML = ''; // Clear current content
                grid.classList.remove('masonry-active');
                
                // Show loader
                grid.innerHTML = `
                    <div style="width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 0;">
                        <div class="surface-spinner" style="position: relative; width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                        <p style="margin-top: 15px; color: var(--text-secondary); font-size: 1rem; font-weight: 500;">{{ t('Searching...') }}</p>
                    </div>
                `;
                
                fetch(`/api/search?${params.toString()}`)
                    .then(r => r.json())
                    .then(data => {
                        grid.innerHTML = ''; // Clear loader
                        
                        if(data.success) {
                            // Update Search Header with query and count
                            const searchHeader = document.getElementById('search-header-title');
                            if (searchHeader) {
                                let displayTitle = rawQuery || detectedCat || "{{ t('Search Results') }}";
                                displayTitle = displayTitle.charAt(0).toUpperCase() + displayTitle.slice(1);
                                
                                searchHeader.innerHTML = '';
                                searchHeader.appendChild(document.createTextNode(displayTitle));
                                
                                const countSpan = document.createElement('span');
                                countSpan.style.cssText = "color: #888; font-size: 1rem; font-weight: 400; margin-left: 10px;";
                                countSpan.textContent = `${data.assets.length} results`;
                                searchHeader.appendChild(countSpan);

                                // Check for random results (only for assets)
                                const assetResults = data.assets.filter(a => a.type !== 'user');
                                const allRandom = data.assets.length > 0 && data.assets.every(a => a.is_random);
                                if (allRandom) {
                                     const suggestionSpan = document.createElement('div');
                                     suggestionSpan.style.fontSize = "1rem";
                                     suggestionSpan.style.color = "var(--primary)";
                                     suggestionSpan.style.marginTop = "5px";
                                     suggestionSpan.textContent = "{{ t('No exact matches found. Suggested for you:') }}";
                                     searchHeader.appendChild(suggestionSpan);
                                }
                            }

                            if(data.assets.length === 0) {
                                grid.innerHTML = '<div class="empty-state"><h2>{{ t("No results found") }}</h2><p>{{ t("Try different keywords or filters.") }}</p></div>';
                                return;
                            }
                            
                            // Update state
                            if (data.assets.length < 10) searchState.hasMore = false;
                            searchState.offset += data.assets.length;

                            setupMasonryGrid(grid);
                            
                            // Reuse the existing rendering logic by setting the global galleryImages
                            galleryImages = data.assets.filter(item => item.type !== 'user');
                            
                            // Instant Load Logic (Parallel)
                            data.assets.forEach((asset, index) => {
                                let card;
                                if (asset.type === 'user') {
                                    card = createUserCard(asset);
                                } else {
                                    // Fix: Pass the filtered galleryImages list to the viewer, not the mixed data.assets list
                                    // We also need to find the correct index in the filtered list
                                    const filteredIndex = galleryImages.indexOf(asset);
                                    card = createImageCard(asset, filteredIndex, galleryImages);
                                }
                                
                                // Distribute to shortest column based on HEIGHT
                                // User cards will also be placed in the masonry layout
                                const cols = grid.querySelectorAll('.gallery-col');
                                if (cols.length > 0) {
                                    let target = cols[0];
                                    cols.forEach(col => {
                                        if (col.offsetHeight < target.offsetHeight) target = col;
                                    });
                                    target.appendChild(card);
                                } else {
                                    grid.appendChild(card);
                                }
                            });
                        }
                    })
                    .catch(err => {
                        grid.innerHTML = '';
                        console.error(err);
                        if (!navigator.onLine) updateConnectionStatus();
                        createErrorCard(grid, "NETWORK_ERROR", () => window.performSearch());
                    });
            };

        function loadMoreSearchResults() {
            const grid = document.querySelector('#section-search .gallery-grid');
            if (!grid || searchState.loading || !searchState.hasMore) return;
            
            searchState.loading = true;
            
            const params = new URLSearchParams(searchState.currentParams);
            params.append('limit', 10);
            params.append('offset', searchState.offset);
            
            fetch(`/api/search?${params.toString()}`)
                .then(r => r.json())
                .then(data => {
                    searchState.loading = false;
                    if (data.success) {
                        if (data.assets.length < 10) searchState.hasMore = false;
                        searchState.offset += data.assets.length;
                        
                        if (data.assets.length > 0) {
                            // Append to global galleryImages for viewer navigation
                            const newImages = data.assets.filter(item => item.type !== 'user');
                            galleryImages.push(...newImages);

                            data.assets.forEach((asset) => {
                                let card;
                                if (asset.type === 'user') {
                                    card = createUserCard(asset);
                                } else {
                                    const filteredIndex = galleryImages.indexOf(asset);
                                    card = createImageCard(asset, filteredIndex, galleryImages);
                                }
                                
                                const cols = grid.querySelectorAll('.gallery-col');
                                if (cols.length > 0) {
                                    let target = cols[0];
                                    cols.forEach(col => {
                                        if (col.offsetHeight < target.offsetHeight) target = col;
                                    });
                                    target.appendChild(card);
                                } else {
                                    grid.appendChild(card);
                                }
                            });
                        }
                    } else {
                        searchState.hasMore = false;
                    }
                })
                .catch(e => {
                    searchState.loading = false;
                });
        }

            // POPSTATE LISTENER FOR BROWSER BACK BUTTON
            window.addEventListener('popstate', (event) => {
                const urlParams = new URLSearchParams(window.location.search);
                const query = urlParams.get('q');
                
                // If we have search params, restore search view
                if (query || urlParams.has('category') || urlParams.has('resolution') || urlParams.has('size')) {
                    if (searchInput) {
                        searchInput.value = query || '';
                        selectedCat = urlParams.get('category');
                        selectedRes = urlParams.get('resolution');
                        selectedSize = urlParams.get('size');
                        selectedSort = urlParams.get('sort') || 'newest';
                        
                        if (typeof updateFilterActiveState === 'function') updateFilterActiveState();
                        window.performSearch(false); // Don't push state again
                    }
                } else {
                    // No search params - Restore Previous Section
                    if (searchInput) searchInput.value = '';
                    selectedCat = null;
                    selectedRes = null;
                    selectedSize = null;
                    if (typeof updateFilterActiveState === 'function') updateFilterActiveState();
                    
                    // Hide all sections
                    document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
                    
                    // Determine which section to show
                    let targetId = 'section-home'; // Default
                    if (event.state && event.state.section) {
                        targetId = event.state.section;
                    }
                    
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) targetSection.style.display = 'block';
                    
                    // Re-trigger load if needed
                    if (targetId === 'section-home' && typeof loadHomeContent === 'function') loadHomeContent();
                    if (targetId === 'section-images' && typeof loadImagesContent === 'function') loadImagesContent();
                }
            });

            if(searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if(e.key === 'Enter') window.performSearch();
                });
            }

            // --- INFINITE SCROLL LISTENER ---
            window.addEventListener('scroll', () => {
                // Check if near bottom (increased threshold for smoother infinite scroll)
                const scrollHeight = document.documentElement.scrollHeight;
                const scrollTop = window.scrollY || document.documentElement.scrollTop;
                const clientHeight = document.documentElement.clientHeight;

                if (scrollTop + clientHeight >= scrollHeight - 500) {
                    const imagesSection = document.getElementById('section-images');
                    const publicProfileSection = document.getElementById('section-public-profile');
                    const homeSection = document.getElementById('section-home');
                    const searchSection = document.getElementById('section-search');
                    
                    if (homeSection && homeSection.style.display !== 'none') {
                        loadNextHomeFeedSection();
                    }
                    
                    if (imagesSection.style.display !== 'none') {
                        loadGalleryImages();
                    } else if (publicProfileSection && publicProfileSection.style.display !== 'none') {
                        loadPublicProfileImages();
                    } else if (searchSection && searchSection.style.display !== 'none') {
                        loadMoreSearchResults();
                    }
                }
            }); // <-- This was missing
        });

        function createLoadMoreButton(container, onClick) {
            if (document.getElementById('galleryLoadMoreBtn')) return;
            
            const btnWrapper = document.createElement('div');
            btnWrapper.id = 'galleryLoadMoreWrapper';
            btnWrapper.style.width = '100%';
            btnWrapper.style.display = 'flex';
            btnWrapper.style.justifyContent = 'center';
            btnWrapper.style.padding = '30px 0 50px';
            btnWrapper.style.clear = 'both';
            
            const btn = document.createElement('button');
            btn.id = 'galleryLoadMoreBtn';
            btn.textContent = "{{ t('Next') }}";
            btn.style.background = 'var(--primary)';
            btn.style.color = '#fff';
            btn.style.border = 'none';
            btn.style.padding = '12px 40px';
            btn.style.borderRadius = '30px';
            btn.style.fontSize = '1rem';
            btn.style.fontWeight = '600';
            btn.style.cursor = 'pointer';
            btn.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
            
            btn.onclick = () => {
                btnWrapper.remove();
                onClick();
            };
            
            btnWrapper.appendChild(btn);
            container.appendChild(btnWrapper);
        }

        function loadGeneratorContent() {
            const container = document.getElementById('section-generator');
            if (!container || container.innerHTML.trim() !== "") return;

            container.innerHTML = '<div style="display:flex;justify-content:center;padding:50px;"><div class="surface-spinner" style="width:40px;height:40px;border:3px solid rgba(255,255,255,0.1);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite;"></div></div>';

            fetch('/image-generator-template')
                .then(response => response.text())
                .then(html => {
                    container.innerHTML = html;
                    // Execute scripts in the template
                    const scripts = container.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });
                    if (window.translationSystem) window.translationSystem.applyTranslations(window.translationSystem.currentLang);
                })
                .catch(err => {
                    console.error("Failed to load generator", err);
                    createErrorCard(container, "Failed to load generator.", () => { container.innerHTML=""; loadGeneratorContent(); });
                });
        }

        function loadImagesContent() {
            if (imageState.loaded) return;
            imageState.loaded = true;
            loadGalleryImages();
        }

        function loadHomeContent() {
            if (homeLoaded) return;
            homeLoaded = true;
            
            loadHeroImages();

            // Ensure feed loads on mobile/desktop initially
            loadNextHomeFeedSection();

            const sectionsContainer = document.getElementById('dynamic-sections-container');
            if (!sectionsContainer) return;

            // Mobile Optimization: Skip fetching desktop-only sections
            if (window.innerWidth <= 768) {
                return;
            }

            fetch('/home-sections')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.sections) {
                        sectionsContainer.innerHTML = ''; // Clear container
                        let combinedHTML = '';
                        data.sections.forEach(section => {
                            combinedHTML += section.html;
                        });
                        sectionsContainer.innerHTML = combinedHTML;

                        // Execute scripts found in the injected HTML
                        sectionsContainer.querySelectorAll('script').forEach(oldScript => {
                            const newScript = document.createElement('script');
                            Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });

                        // Load random images into the featured section
                        loadFeaturedImages();
                    } else {
                        console.error('Failed to load home page sections:', data.message);
                    }
                })
                .catch(error => {
                    if (!navigator.onLine) updateConnectionStatus();
                    createErrorCard(sectionsContainer, "NETWORK_ERROR", () => loadHomeContent());
                });
        }

        function calculateHomeFeedLimit(gridElement) {
            const colWidth = 280; 
            const gap = 24;
            const containerWidth = gridElement.clientWidth || (window.innerWidth - 40);
            let cols = Math.floor((containerWidth + gap) / (colWidth + gap));
            if (cols < 1) cols = 1;
            if (window.innerWidth <= 768) cols = 1; 
            
            return cols * 4; // 4 lines
        }

        function loadNextHomeFeedSection() {
            if (homeFeedState.loading || homeFeedState.error) return;
            
            const container = document.getElementById('home-feed-container');
            if (!container) return;

            // Determine next section config
            let config = homeFeedState.currentConfig;
            
            if (!config) {
                if (homeFeedState.queue.length > 0) {
                    config = homeFeedState.queue.shift();
                } else {
                    // Generate from categoriesList
                    if (typeof categoriesList !== 'undefined' && homeFeedState.categoryIndex < categoriesList.length) {
                        // Shuffle categories on first run if index is 0
                        if (homeFeedState.categoryIndex === 0) {
                            categoriesList.sort(() => 0.5 - Math.random());
                        }
                        const cat = categoriesList[homeFeedState.categoryIndex];
                        config = { type: 'category', value: cat, title: cat, icon: 'picture.png' };
                        homeFeedState.categoryIndex++;
                    } else {
                        return; // No more content
                    }
                }
                homeFeedState.currentConfig = config;
            }

            homeFeedState.loading = true;

            // Create Section Structure
            const section = document.createElement('div');
            section.className = 'home-feed-section fade-in';
            section.style.marginBottom = '40px';
            
            // Header
            const header = document.createElement('div');
            header.className = 'feed-header';
            header.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 0 20px 20px; margin-top: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px;';
            
            const iconUrl = `/static/icons/${config.icon}`;
            header.innerHTML = `
                <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <img src="${iconUrl}" style="width: 20px; height: 20px; filter: brightness(0) invert(1);" width="20" height="20" alt="">
                </div>
                <h2 style="margin: 0; font-size: 1.4rem; font-weight: 700; color: var(--text-primary);">${config.title}</h2>
            `;
            section.appendChild(header);

            // Grid
            const grid = document.createElement('div');
            grid.className = 'gallery-grid';
            section.appendChild(grid);
            container.appendChild(section);

            // Calculate Limit (4 lines)
            const limit = 10;
            
            // Setup Masonry
            setupMasonryGrid(grid);
            
            // Build API URL
            let url = `/api/search?limit=${limit}`;
            if (config.type === 'size') url += `&size=${config.value}`;
            else if (config.type === 'category') url += `&category=${encodeURIComponent(config.value)}&sort=random`;

            fetch(url)
                .then(r => r.json())
                .then(data => {
                    homeFeedState.loading = false;
                    
                    if (data.success && data.assets.length > 0) {
                        homeFeedState.currentConfig = null;
                        data.assets.slice(0, 10).forEach((asset, index) => {
                            // Reuse card creation logic
                            const card = createImageCard(asset, index, data.assets);
                            
                            // Masonry append logic
                            const cols = grid.querySelectorAll('.gallery-col');
                            if (cols.length > 0) {
                                let target = cols[0];
                                cols.forEach(col => { if (col.offsetHeight < target.offsetHeight) target = col; });
                                target.appendChild(card);
                            } else {
                                grid.appendChild(card);
                            }
                            
                            card.addEventListener('click', () => {
                                if(typeof openImageViewer === 'function') openImageViewer(asset, index, data.assets);
                            });
                        });
                    } else {
                        section.remove();
                        homeFeedState.currentConfig = null;
                        loadNextHomeFeedSection(); // Try next if empty
                    }
                })
                .catch(e => {
                    homeFeedState.loading = false;
                    homeFeedState.error = true;
                    
                    grid.innerHTML = '';
                    createErrorCard(grid, "NETWORK_ERROR", () => {
                        homeFeedState.error = false;
                        section.remove();
                        loadNextHomeFeedSection();
                    });
                });
        }

        function getDynamicLimit() {
            // Flexible logic: Calculate items needed to cover the viewport + buffer
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            let columns = 1;
            let avgHeight = 300;

            if (viewportWidth <= 768) {
                // Mobile: 2 Columns, height depends on width
                columns = 2;
                avgHeight = 220; 
            } else {
                // Desktop: Masonry (approx 304px per item including gap)
                // Sidebar (64px) + Padding (~48px)
                const availableWidth = viewportWidth - 112; 
                columns = Math.floor(availableWidth / 304); 
                if (columns < 1) columns = 1;
                avgHeight = 280; // Average height of masonry items
            }

            // Calculate items to fill one screen
            const itemsPerScreen = Math.ceil((viewportHeight / avgHeight) * columns);
            
            // Request 3 screens worth of content to ensure smooth scrolling and avoid gaps
            return Math.max(columns * 3, itemsPerScreen * 3 + 8);
        }

        // --- MASONRY SETUP ---
        function setupMasonryGrid(grid) {
            if (grid.classList.contains('masonry-active')) return;
            
            // Mobile Grid Mode (CSS Grid)
            if (window.innerWidth <= 768) {
                grid.classList.add('mobile-grid');
                grid.classList.add('masonry-active');
                return;
            }

            // Calculate columns based on width (approx 280px per col + gap)
            const colWidth = 280;
            const gap = 12;
            let numCols = Math.floor((grid.clientWidth + gap) / (colWidth + gap));
            if (numCols < 1) numCols = 1;
            if (window.innerWidth <= 768) numCols = 2; // Force 2 cols on mobile

            for (let i = 0; i < numCols; i++) {
                const col = document.createElement('div');
                col.className = 'gallery-col';
                grid.appendChild(col);
            }
            grid.classList.add('masonry-active');
        }

        // --- ASPECT RATIO HELPER ---
        function getAspectRatioStyle(resolution) {
            if (!resolution) return '';
            const parts = resolution.toLowerCase().split('x');
            if (parts.length === 2) {
                const w = parseFloat(parts[0]);
                const h = parseFloat(parts[1]);
                if (!isNaN(w) && !isNaN(h) && h !== 0) return `aspect-ratio: ${w}/${h};`;
            }
            return '';
        }

        // --- SKELETON LOADING HELPERS ---
        function loadGalleryImages() {
            const grid = document.querySelector('#section-images .gallery-grid');
            if (!grid || grid.querySelector('.error-state-card')) return;

            if (imageState.loading || !imageState.hasMore) return;
            
            imageState.loading = true;

            // --- HYDRATION LOGIC (SEO) ---
            // If we have server-rendered assets for this page, use them immediately
            if (window.SERVER_CONFIG.seoAssets && window.SERVER_CONFIG.seoAssets.length > 0) {
                const assets = window.SERVER_CONFIG.seoAssets;
                window.SERVER_CONFIG.seoAssets = null; // Consume them so we don't re-use
                
                setupMasonryGrid(grid);
                
                // Render assets
                assets.forEach((asset, index) => {
                    const card = createImageCard(asset, imageState.offset + index);
                    const cols = grid.querySelectorAll('.gallery-col');
                    if (cols.length > 0) {
                        let target = cols[0];
                        cols.forEach(col => {
                            if (col.offsetHeight < target.offsetHeight) target = col;
                        });
                        target.appendChild(card);
                    } else {
                        grid.appendChild(card);
                    }
                });
                
                imageState.offset += assets.length;
                imageState.loading = false;
                
                // If we are on page > 1, we assume the user wants to see these images, so we don't need skeletons
                return;
            }

            const mobileSurfaceLoader = document.getElementById('mobileSurfaceLoader');
            if (window.innerWidth <= 768 && mobileSurfaceLoader) mobileSurfaceLoader.classList.add('active');

            const limit = 10;
            setupMasonryGrid(grid);
            
            // Inject Skeletons
            const skeletons = [];
            const cols = grid.querySelectorAll('.gallery-col');
            
            for(let i=0; i<limit; i++) {
                const skel = document.createElement('div');
                skel.className = 'skeleton-card fade-in';
                
                // Responsive height calculation
                let minH = 200, maxH = 350;
                if (window.innerWidth <= 768) {
                    minH = 150; maxH = 280; // Smaller cards on mobile
                }

                // Random height for masonry feel
                const h = Math.floor(Math.random() * (maxH - minH + 1)) + minH;
                skel.style.height = h + 'px';
                skel.style.minHeight = h + 'px';
                skel.style.borderRadius = '12px';
                skel.style.overflow = 'hidden';
                skel.innerHTML = `<div style="width: 100%; height: 100%; background: linear-gradient(90deg, #2c2c2e 25%, #3a3a3c 50%, #2c2c2e 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite;"></div>`;
                
                if (cols.length > 0) {
                    let target = cols[0];
                    cols.forEach(col => {
                        if (col.offsetHeight < target.offsetHeight) target = col;
                    });
                    target.appendChild(skel);
                } else {
                    grid.appendChild(skel);
                }
                skeletons.push(skel);
            }

            fetch(`/api/assets/image?offset=${imageState.offset}&limit=${limit}`)
                .then(r => r.json())
                .then(data => {
                    if (mobileSurfaceLoader) mobileSurfaceLoader.classList.remove('active');

                    if (data.success) {
                        if (data.assets.length < limit) imageState.hasMore = false;
                        
                        // Keep a reference to the global list for the viewer
                        if (imageState.offset === 0) galleryImages = data.assets;
                        else galleryImages.push(...data.assets);

                        // Remove page skeletons immediately
                        skeletons.forEach(s => s.remove());

                        // Append cards immediately (they have internal skeletons)
                        data.assets.forEach((asset, index) => {
                            const card = createImageCard(asset, imageState.offset + index);
                            const cols = grid.querySelectorAll('.gallery-col');
                            if (cols.length > 0) {
                                let target = cols[0];
                                cols.forEach(col => {
                                    if (col.offsetHeight < target.offsetHeight) target = col;
                                });
                                target.appendChild(card);
                            } else {
                                grid.appendChild(card);
                            }
                        });
                        
                        if (data.assets.length > 0) imageState.offset += data.assets.length;
                        
                        // If no assets returned, remove skeletons immediately
                        if (data.assets.length === 0) {
                            skeletons.forEach(s => s.remove());
                            imageState.loading = false;
                        }

                    } else {
                        skeletons.forEach(s => s.remove());
                        imageState.loading = false;
                    }
                })
                .catch(() => {
                    skeletons.forEach(s => s.remove());
                    imageState.loading = false;
                    if (mobileSurfaceLoader) mobileSurfaceLoader.classList.remove('active');
                    if (!navigator.onLine) updateConnectionStatus();
                    createErrorCard(grid, "NETWORK_ERROR", () => loadGalleryImages());
                });
        }

        function loadSimilarImages(assetCategory, assetId) {
            const similarGrid = document.getElementById('similarGrid');
            if (!similarGrid) return;

            // Clear previous results and show loader
            similarGrid.innerHTML = `
                <div style="grid-column: 1 / -1; display: flex; justify-content: center; padding: 30px;">
                    <div style="width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                </div>
            `;

            // Fetch enough items to support "Load More" functionality
            const fetchLimit = 24;
            fetch(`/api/similar/${assetCategory}/${assetId}?limit=${fetchLimit}`)
                .then(response => response.json())
                .then(data => {
                    similarGrid.innerHTML = ''; // Clear loader
                    if (data.success && data.assets.length > 0) {
                        
                        setupMasonryGrid(similarGrid);
                        
                        const isMobile = window.innerWidth <= 768;
                        // On mobile show 6 initially, on desktop show all
                        const initialRenderCount = isMobile ? 6 : fetchLimit;
                        
                        const assetsToRender = data.assets.slice(0, initialRenderCount);
                        const remainingAssets = data.assets.slice(initialRenderCount);

                        const appendAsset = (asset, idx) => {
                            const card = createImageCard(asset, idx, data.assets);
                            const cols = similarGrid.querySelectorAll('.gallery-col');
                            if (cols.length > 0) {
                                let target = cols[0];
                                cols.forEach(col => {
                                    if (col.offsetHeight < target.offsetHeight) target = col;
                                });
                                target.appendChild(card);
                            } else {
                                similarGrid.appendChild(card);
                            }
                        };

                        assetsToRender.forEach((asset, index) => {
                            appendAsset(asset, index);
                        });

                        if (remainingAssets.length > 0) {
                            const btnContainer = document.createElement('div');
                            btnContainer.style.gridColumn = '1 / -1';
                            btnContainer.style.display = 'flex';
                            btnContainer.style.justifyContent = 'center';
                            btnContainer.style.padding = '20px 0';
                            btnContainer.style.width = '100%';
                            
                            const loadMoreBtn = document.createElement('button');
                            loadMoreBtn.textContent = 'Load More';
                            loadMoreBtn.className = 'btn-download secondary';
                            loadMoreBtn.style.width = 'auto';
                            loadMoreBtn.style.minWidth = '120px';
                            loadMoreBtn.style.height = '40px';
                            loadMoreBtn.style.fontSize = '0.9rem';
                            
                            loadMoreBtn.onclick = () => {
                                btnContainer.remove();
                                remainingAssets.forEach((asset, index) => {
                                    appendAsset(asset, initialRenderCount + index);
                                });
                            };
                            
                            btnContainer.appendChild(loadMoreBtn);
                            similarGrid.appendChild(btnContainer);
                        }
                    } else {
                        similarGrid.innerHTML = '<p style="text-align:center; color:#888;">No similar images found.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching similar images:', error);
                    similarGrid.innerHTML = '<p style="text-align:center; color:red;">Could not load similar images.</p>';
                });
        }

        // --- Extracted Card Creation ---
        // Helper function to generate a random color
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // ================= CONTEXT MENU LOGIC =================
        let activeContextMenu = null;

        function showCardContextMenu(e, asset, index, list) {
            if (activeContextMenu) activeContextMenu.remove();
            e.preventDefault();
            e.stopPropagation();

            const menu = document.createElement('div');
            menu.className = 'card-context-menu';
            
            // Icons (Using existing assets)
            const shareIcon = '<img src="/static/icons/share.png">';
            const downloadIcon = '<img src="/static/icons/download.png">';
            const likeIcon = asset.is_liked ? '<img src="/static/icons/heart.png">' : '<img src="/static/icons/heart2.png">';
            const saveIcon = asset.is_saved ? '<img src="/static/icons/bookmark.png">' : '<img src="/static/icons/bookmark2.png">';
            
            // SVGs for Open and Similar
            const openSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>';
            const similarSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>';

            menu.innerHTML = `
                <div class="ctx-item" onclick="openImageViewer(window.currentContextAsset, window.currentContextIndex, window.currentContextList); closeContextMenu();">${openSvg} <span>Open</span></div>
                <div class="ctx-item" onclick="handleCtxShare()">${shareIcon} <span>Share</span></div>
                <div class="ctx-item" onclick="window.location.href='/download/${asset.category_type || 'image'}/${asset.id}'; closeContextMenu();">${downloadIcon} <span>Download</span></div>
                <div class="ctx-item" onclick="handleCtxSimilar()">${similarSvg} <span>Similar Images</span></div>
                <div class="ctx-item" onclick="handleCtxLike()">${likeIcon} <span>${asset.is_liked ? 'Unlike' : 'Like'}</span></div>
                <div class="ctx-item" onclick="handleCtxSave()">${saveIcon} <span>${asset.is_saved ? 'Unsave' : 'Save'}</span></div>
            `;

            // Store context data globally
            window.currentContextAsset = asset;
            window.currentContextIndex = index;
            window.currentContextList = list;

            document.body.appendChild(menu);
            activeContextMenu = menu;

            // Positioning logic (Beside card)
            const card = e.currentTarget;
            const rect = card.getBoundingClientRect();
            const menuWidth = 180; 
            const menuHeight = 260; 

            let left = rect.right + 10;
            let top = rect.top;

            // If not enough space on right, put on left
            if (left + menuWidth > window.innerWidth) {
                left = rect.left - menuWidth - 10;
            }
            
            // If not enough space on left (mobile?), center it
            if (left < 0) {
                left = window.innerWidth / 2 - menuWidth / 2;
                top = rect.top + 50;
            }

            // Check bottom edge
            if (top + menuHeight > window.innerHeight) {
                top = window.innerHeight - menuHeight - 10;
            }

            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;

            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', closeContextMenu, { once: true });
                window.addEventListener('scroll', closeContextMenu, { once: true });
            }, 10);
        }

        function closeContextMenu() {
            if (activeContextMenu) {
                activeContextMenu.remove();
                activeContextMenu = null;
            }
        }

        // Context Menu Handlers
        window.handleCtxShare = function() {
            const asset = window.currentContextAsset;
            if(!asset) return;
            const shareData = {
                title: asset.name || 'Image',
                text: `Check out this image by ${asset.username || 'User'}`,
                url: window.location.origin + `/view/${asset.category_type || 'image'}/${asset.id}/${(asset.name || 'image').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '')}`
            };
            if (navigator.share) navigator.share(shareData).catch(console.error);
            else {
                navigator.clipboard.writeText(shareData.url).then(() => alert("{{ t('Link copied to clipboard!') }}"));
            }
            closeContextMenu();
        };

        window.handleCtxSimilar = function() {
            const asset = window.currentContextAsset;
            if (asset && asset.category) {
                const searchInput = document.querySelector('.search-input');
                if (searchInput) {
                    searchInput.value = asset.category;
                    // Reset filters to ensure a fresh search
                    if (typeof updateFilterActiveState === 'function') updateFilterActiveState();
                    if (typeof window.performSearch === 'function') window.performSearch();
                }
            }
            closeContextMenu();
        };

        window.handleCtxLike = function() {
            const asset = window.currentContextAsset;
            const btn = document.querySelector(`.like-btn[data-id="${asset.id}"]`);
            if(btn) btn.click();
            closeContextMenu();
        };

        window.handleCtxSave = function() {
            const asset = window.currentContextAsset;
            const btn = document.querySelector(`.save-btn[data-id="${asset.id}"]`);
            if(btn) btn.click();
            closeContextMenu();
        };

        function createUserCard(user) {
            const card = document.createElement('a');
            card.href = `/profile/${user.id}`;
            card.className = 'user-search-card';
            card.style.textDecoration = 'none';
            card.style.color = 'inherit';
            card.style.display = 'block';

            const isFollowing = user.is_following;
            const followBtnText = isFollowing ? "{{ t('Following') }}" : "{{ t('Follow') }}";
            const followBtnClass = isFollowing ? 'secondary' : '';

            // Determine avatar URL
            const avatarUrl = user.avatar ? (user.avatar.startsWith('/static/') ? user.avatar : `/static/avatars/${user.avatar}`) : 'https://via.placeholder.com/60';

            let galleryHtml = '';
            if (user.recent_images && user.recent_images.length > 0) {
                const galleryWidth = user.recent_images.length * 100;
                const imageWidth = 100 / user.recent_images.length;

                const imagesHtml = user.recent_images.map(imgLink => `
                    <div class="user-gallery-img" style="width: ${imageWidth}%">
                        <img src="${R2_DOMAIN ? R2_DOMAIN + '/' + imgLink : '/uploads/' + imgLink}" alt="${user.username}'s image">
                    </div>
                `).join('');

                galleryHtml = `
                    <div class="user-card-gallery">
                        <div class="user-gallery-inner" style="width: ${galleryWidth}%">
                            ${imagesHtml}
                        </div>
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="user-card-header">
                    <img src="${avatarUrl}" alt="${user.username}" class="user-card-avatar">
                    <div class="user-card-info">
                        <h4 class="user-card-name">${user.username}</h4>
                        <p class="user-card-stats">${user.followers} {{ t('Followers') }}</p>
                    </div>
                    <div class="user-card-follow-btn ${followBtnClass}" role="button" onclick="event.preventDefault(); event.stopPropagation(); toggleFollow(${user.id}, this)">
                        ${followBtnText}
                    </div>
                </div>
                ${galleryHtml}
            `;

            // Gallery animation logic
            if (user.recent_images && user.recent_images.length > 1) {
                const galleryInner = card.querySelector('.user-gallery-inner');
                let currentIndex = 0;
                const intervalId = setInterval(() => {
                    currentIndex = (currentIndex + 1) % user.recent_images.length;
                    galleryInner.style.transform = `translateX(-${currentIndex * (100 / user.recent_images.length)}%)`;
                }, 3000); // Change image every 3 seconds
                card.dataset.galleryIntervalId = intervalId;
            }
            card.addEventListener('click', (e) => {
                if (e.metaKey || e.ctrlKey) return;
                e.preventDefault();
                openUserProfile(user.id, user.username, user.avatar);
            });
            return card;
        }

        function createImageCard(asset, globalIndex, listOverride) {
            const smallUrl = window.getGridImageUrl(asset);
            const arStyle = getAspectRatioStyle(asset.resolution);
            const dims = getDimensions(asset.resolution);
            
            // Detect wide image for mobile span (Aspect Ratio > 1.5)
            const isWide = dims.w > (dims.h * 1.5);

            // Random Badge
            const randomBadge = asset.is_random ? `<div style="position:absolute; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.6); color:#fff; padding:4px 10px; border-radius:12px; font-size:0.7rem; backdrop-filter:blur(4px); border:1px solid rgba(255,255,255,0.2); z-index:5;">{{ t('Suggested') }}</div>` : '';

            // Use <a> tag for SEO (Image Landing Page System)
            const card = document.createElement('a');
            // Use server-provided view_url or construct it
            card.href = asset.view_url || `/view/${asset.category_type || 'image'}/${asset.id}`;
            
            card.className = 'image-card fade-in';
            if (isWide) card.classList.add('wide-span');

            card.style.textDecoration = 'none';
            card.style.color = 'inherit';
            card.style.display = 'block';

            // Internal Skeleton Overlay
            const skeletonOverlay = `<div class="card-skeleton-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background: linear-gradient(90deg, #2c2c2e 25%, #3a3a3c 50%, #2c2c2e 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite;"></div>`;

            card.innerHTML = `
                ${randomBadge}
                <div class="card-img-wrapper" style="${arStyle} position: relative; background-color: ${getRandomColor()};">
                    ${skeletonOverlay}
                    <img src="${smallUrl}" alt="${asset.name || 'Image'}" width="${dims.w}" height="${dims.h}" style="width: 100%; height: 100%; display: block; opacity: 0; transition: opacity 0.4s ease;" onload="this.style.opacity='1'; if(this.previousElementSibling) this.previousElementSibling.remove();" onerror="if(this.previousElementSibling) this.previousElementSibling.remove();">
                </div>
                <div class="card-action-btn like-btn top-left ${asset.is_liked ? 'active' : ''}" role="button" data-id="${asset.id}" data-category="${asset.category_type}" aria-label="{{ t('Like') }}" onclick="event.preventDefault(); event.stopPropagation(); toggleLike(this)"></div>
                <div class="card-action-btn save-btn top-right ${asset.is_saved ? 'active' : ''}" role="button" data-id="${asset.id}" data-category="${asset.category_type}" aria-label="{{ t('Save') }}" onclick="event.preventDefault(); event.stopPropagation(); toggleSave(this)"></div>
                <div class="card-overlay">
                    <h3 class="card-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">${asset.name || 'Image'}</h3>
                    <p style="font-size: 0.8rem; color: #ddd; margin: 4px 0 0; font-weight: 400;">${asset.category || ''}</p>
                    <div class="card-actions">
                        <div class="download-icon-btn" role="button" aria-label="{{ t('Download') }}" onclick="event.preventDefault(); event.stopPropagation(); window.location.href='/download/${asset.category_type || 'image'}/${asset.id}'" title="{{ t('Download') }}">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        </div>
                    </div>
                </div>
                <div class="mobile-card-footer">
                    <div class="mobile-user-info" onclick="event.preventDefault(); event.stopPropagation(); openUserProfile(this.dataset.uid, this.dataset.uname, this.dataset.uavatar)" data-uid="${asset.user_id}" data-uname="${asset.username}" data-uavatar="${asset.avatar}">
                        <img src="${asset.avatar ? (asset.avatar.startsWith('/static/') ? asset.avatar : '/static/avatars/' + asset.avatar) : 'https://via.placeholder.com/32'}" class="mobile-avatar" alt="User" width="32" height="32">
                        <span class="mobile-username">${asset.username || 'User'}</span>
                    </div>
                    <span style="font-size: 0.75rem; color: #888;">${asset.resolution || ''}</span>
                    <div class="mobile-download-btn" role="button" aria-label="{{ t('Download') }}" onclick="event.preventDefault(); event.stopPropagation(); window.location.href='/download/${asset.category_type || 'image'}/${asset.id}'" title="{{ t('Download') }}">
                        <img src="/static/icons/download.png" style="width: 16px;" width="16" height="16" alt="Download">
                    </div>
                </div>
            `;
            
            card.addEventListener('contextmenu', (e) => {
                showCardContextMenu(e, asset, globalIndex, listOverride || galleryImages);
            });

            card.addEventListener('click', (e) => {
                // Allow default navigation (new tab) if Ctrl/Cmd is pressed
                if (e.metaKey || e.ctrlKey) return;
                e.preventDefault(); // Stop navigation for normal clicks to open modal
                openImageViewer(asset, globalIndex, listOverride || galleryImages);
            });

            return card;
        }

        function loadHeroImages() {
            // Optimization: Do not load hero images on mobile to save bandwidth
            // if (window.innerWidth <= 768) return; // Restriction removed

            const container = document.querySelector('.hero-right');
            // LCP Optimization: If content is already loaded (SSR), do not fetch again
            if (!container || container.children.length > 0) return;

            // Hero section is small, 20 is sufficient
            fetch('/api/assets/image?limit=20&offset=0')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.assets.length > 0) {
                        
                        const shuffled = [...data.assets].sort(() => 0.5 - Math.random());
                        
                        // Calculate optimal number of images for hero grid to prevent gaps
                        let limit = 8;
                        if (container) {
                            const w = container.clientWidth || (window.innerWidth > 900 ? window.innerWidth * 0.45 : window.innerWidth);
                            const h = container.clientHeight || 400;
                            const cols = Math.floor(w / 212); // 200px min + 12px gap
                            const rows = Math.floor(h / 200);
                            limit = Math.max(8, Math.min(16, (cols || 2) * (rows || 2)));
                        }
                        const items = shuffled.slice(0, limit);
                        
                        items.forEach((asset, index) => {
                            const box = document.createElement('a');
                            box.href = asset.view_url || `/view/${asset.category_type || 'image'}/${asset.id}`;
                            box.className = 'hero-img-box';
                            const imgUrl = window.getGridImageUrl(asset);
                            const dims = getDimensions(asset.resolution);
                            box.innerHTML = `<img src="${imgUrl}" alt="${asset.name || 'Hero Image'}" width="${dims.w}" height="${dims.h}">`;
                            container.appendChild(box);
                            
                            box.addEventListener('click', (e) => {
                                if (e.metaKey || e.ctrlKey) return;
                                e.preventDefault();
                                openImageViewer(asset, index, items);
                            });
                        });
                    }
                })
                .catch(() => {
                    if (!navigator.onLine) updateConnectionStatus();
                    createErrorCard(container, "NETWORK_ERROR", () => loadHeroImages());
                });
        }

        // --- PUBLIC PROFILE LOGIC ---
        window.openUserProfile = function(userId, username, avatar) {
            if (!userId || userId === 'undefined') return;
            
            // Capture previous section for Back button logic
            let activeSection = 'section-images'; // Default fallback
            document.querySelectorAll('.content-section').forEach(el => {
                if (el.style.display !== 'none' && el.id !== 'section-public-profile') {
                    activeSection = el.id;
                }
            });
            window.lastActiveSection = activeSection;

            // Switch section
            document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
            const profileSection = document.getElementById('section-public-profile');
            if(profileSection) profileSection.style.display = 'block';
            
            // Initial Header Update (Fast)
            const nameEl = document.getElementById('publicProfileName');
            const avatarEl = document.getElementById('publicProfileAvatar');
            const statsEl = document.getElementById('publicProfileStats');
            const bioEl = document.getElementById('publicProfileBio');
            const socialsContainer = document.getElementById('publicProfileSocials');
            const contactBtn = document.getElementById('publicProfileContactBtn');
            const followBtn = document.getElementById('publicProfileFollowBtn');
            const copyBtn = document.getElementById('publicProfileCopyBtn');
            const backBtn = document.getElementById('publicProfileBackBtn');

            if(nameEl) nameEl.textContent = username || 'User';
            if(avatarEl) avatarEl.src = avatar && avatar !== 'null' && avatar !== 'undefined' ? (avatar.startsWith('/static/') ? avatar : `/static/avatars/${avatar}`) : 'https://via.placeholder.com/100';
            if(statsEl) statsEl.textContent = '';
            
            // Reset Extended Info
            if(bioEl) { bioEl.textContent = ''; bioEl.style.display = 'none'; }
            if(socialsContainer) socialsContainer.innerHTML = '';
            if(contactBtn) contactBtn.style.display = 'none';
            if(followBtn) followBtn.style.display = 'none';
            
            if(copyBtn) {
                copyBtn.onclick = (e) => {
                    e.stopPropagation();
                    copyProfileLink(userId, copyBtn);
                };
            }

            if (backBtn) {
                backBtn.onclick = (e) => {
                    e.stopPropagation();
                    document.getElementById('section-public-profile').style.display = 'none';
                    const targetId = window.lastActiveSection || 'section-images';
                    document.getElementById(targetId).style.display = 'block';
                };
            }
            
            // Reset State
            publicProfileState = { offset: 0, loading: false, hasMore: true, loaded: false, currentUserId: userId };
            profileImages = [];
            const grid = document.getElementById('public-profile-grid');
            if(grid) grid.innerHTML = '';
            
            // Fetch Full Details
            fetch(`/api/user/${userId}/details`)
                .then(r => r.json())
                .then(data => {
                    if(data.success && data.user) {
                        const u = data.user;
                        
                        if(statsEl) {
                            statsEl.textContent = (u.followers || 0) + " {{ t('Followers') }}";
                        }

                        if(bioEl && u.bio) {
                            bioEl.textContent = u.bio;
                            bioEl.style.display = 'block';
                        }
                        
                        // Render Socials
                        if(socialsContainer) {
                            const createLink = (url, icon, label) => {
                                if(!url || typeof url !== 'string' || !url.trim()) return;
                                const cleanUrl = url.startsWith('http') ? url : `https://${url}`;
                                const a = document.createElement('a');
                                a.href = cleanUrl;
                                a.target = "_blank";
                                a.className = "nav-btn secondary";
                                a.style.width = "auto";
                                a.style.padding = "0 15px";
                                a.style.fontSize = "0.9rem";
                                // Icons are black, invert for dark button background
                                a.innerHTML = `<img src="/static/icons/${icon}" style="width:16px; margin-right:8px; filter: brightness(0) invert(1);" width="16" height="16" alt=""> ${label}`;
                                socialsContainer.appendChild(a);
                            };
                            
                            if(u.website && typeof u.website === 'string') createLink(u.website, 'domain.png', 'Website');
                            if(u.instagram && typeof u.instagram === 'string') createLink(`https://instagram.com/${u.instagram.replace('@','')}`, 'instagram.png', 'Instagram');
                            if(u.twitter && typeof u.twitter === 'string') createLink(`https://twitter.com/${u.twitter.replace('@','')}`, 'twitter.png', 'Twitter');
                            
                            // Hide container if no links were added
                            if (socialsContainer.children.length === 0) {
                                socialsContainer.style.display = 'none';
                            } else {
                                socialsContainer.style.display = 'flex';
                            }
                        }

                        if(contactBtn && u.contact_email) {
                            contactBtn.href = `mailto:${u.contact_email}`;
                            contactBtn.style.display = 'inline-flex';                            
                            contactBtn.innerHTML = `<img src="/static/icons/email.png" style="width:16px; margin-right:8px; filter: brightness(0) invert(1);" width="16" height="16" alt=""> Contact`;
                        }

                        // NEW: Handle Follow button
                        if (followBtn) {
                            const sessionData = localStorage.getItem('user_session');
                            const loggedInUserId = sessionData ? JSON.parse(sessionData).user_id : null;
                            
                            // Show for guests or if not own profile
                            if (!loggedInUserId || (loggedInUserId && String(loggedInUserId) !== String(u.id))) {
                                followBtn.style.display = 'inline-flex';
                                
                                // Default state for guests is "Follow" (false)
                                const isFollowing = loggedInUserId ? u.is_following : false;

                                followBtn.textContent = isFollowing ? "{{ t('Following') }}" : "{{ t('Follow') }}";
                                const plusIcon = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
                                const checkIcon = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                                
                                followBtn.innerHTML = isFollowing ? `${checkIcon} <span>{{ t('Following') }}</span>` : `${plusIcon} <span>{{ t('Follow') }}</span>`;
                                if (isFollowing) {
                                    followBtn.classList.add('secondary');
                                    followBtn.style.background = '';
                                    followBtn.style.color = '';
                                } else {
                                    followBtn.classList.remove('secondary');
                                    followBtn.style.background = 'var(--primary)';
                                    followBtn.style.color = 'white';
                                }
                                
                                followBtn.onclick = () => {
                                    toggleFollow(u.id, followBtn);
                                };
                            } else {
                                followBtn.style.display = 'none';
                            }
                        }
                    }
                });

            loadPublicProfileImages();
            window.scrollTo(0, 0);
        };

        window.copyProfileLink = function(userId, btn) {
            if (!userId) return;
            const link = window.location.origin + '/profile/' + userId;
            
            const showSuccess = () => {
                if (btn) {
                    const originalContent = btn.innerHTML;
                    const originalStyle = btn.getAttribute('style');
                    
                    btn.style.background = '#4caf50';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#4caf50';
                    btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                    
                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        if (originalStyle) btn.setAttribute('style', originalStyle);
                        else {
                            btn.style.background = '';
                            btn.style.color = '';
                            btn.style.borderColor = '';
                        }
                    }, 2000);
                }
            };

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(link).then(showSuccess).catch(err => {
                    console.error('Clipboard API failed, using fallback', err);
                    fallbackCopy(link);
                });
            } else {
                fallbackCopy(link);
            }

            function fallbackCopy(text) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; // Avoid scrolling to bottom
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) showSuccess();
                    else prompt("Copy this link:", text);
                } catch (err) {
                    console.error('Fallback copy failed', err);
                    prompt("Copy this link:", text);
                }
                document.body.removeChild(textArea);
            }
        }

        async function toggleFollow(targetId, btn) {
            if (!targetId || !btn) return;

            // Client-side auth check
            const sessionData = localStorage.getItem('user_session');
            if (!sessionData) {
                openAuthModal('signup');
                return;
            }

            const originalText = btn.textContent;
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.textContent = '...';
            // btn.textContent = '...';

            try {
                const response = await fetch('/api/follow', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target_id: targetId })
                });
                const data = await response.json();

                if (data.success) {
                    const plusIcon = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
                    const checkIcon = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';

                    if (data.action === 'followed') {
                        if (btn.id === 'publicProfileFollowBtn' || btn.classList.contains('viewer-follow-btn')) {
                            btn.innerHTML = `${checkIcon} <span>{{ t('Following') }}</span>`;
                        } else {
                            btn.textContent = "{{ t('Following') }}";
                        }
                        btn.classList.add('secondary');
                        btn.style.background = '';
                        btn.style.color = '';
                    } else {
                        if (btn.id === 'publicProfileFollowBtn' || btn.classList.contains('viewer-follow-btn')) {
                            btn.innerHTML = `${plusIcon} <span>{{ t('Follow') }}</span>`;
                        } else {
                            btn.textContent = "{{ t('Follow') }}";
                        }
                        btn.classList.remove('secondary');
                        btn.style.background = 'var(--primary)';
                        btn.style.color = 'white';
                    }
                } else {
                    btn.textContent = originalText;
                    btn.innerHTML = originalContent;
                    if (data.message === 'AUTH_REQUIRED') {
                        openAuthModal('login');
                    } else {
                        alert(data.message || 'An error occurred.');
                    }
                }
            } catch (e) {
                btn.textContent = originalText;
                btn.innerHTML = originalContent;
                alert('Network error.');
            } finally {
                btn.disabled = false;
            }
        }

        function loadPublicProfileImages() {
            const grid = document.getElementById('public-profile-grid');
            if (!grid || publicProfileState.loading || !publicProfileState.hasMore) return;
            
            publicProfileState.loading = true;
            const limit = 10;
            setupMasonryGrid(grid);
            
            fetch(`/api/assets/image?user_id=${publicProfileState.currentUserId}&offset=${publicProfileState.offset}&limit=${limit}`)
                .then(r => r.json())
                .then(data => {
                    publicProfileState.loading = false;
                    if (data.success) {
                        if (data.assets.length < limit) publicProfileState.hasMore = false;
                        
                        if (publicProfileState.offset === 0) profileImages = data.assets;
                        else profileImages.push(...data.assets);

                        data.assets.forEach((asset, index) => {
                            const globalIndex = publicProfileState.offset + index;
                            const card = createImageCard(asset, globalIndex, profileImages);
                            
                            const cols = grid.querySelectorAll('.gallery-col');
                            if (cols.length > 0) {
                                let target = cols[0];
                                cols.forEach(col => {
                                    if (col.offsetHeight < target.offsetHeight) target = col;
                                });
                                target.appendChild(card);
                            } else {
                                grid.appendChild(card);
                            }
                        });
                        if (data.assets.length > 0) publicProfileState.offset += data.assets.length;
                    }
                })
                .catch(e => {
                    publicProfileState.loading = false;
                });
        }

        function loadFeaturedImages() {
            if (window.innerWidth <= 768) return;

            const container = document.querySelector('.portfolio-container');
            // If container exists, clear it
            if (container) {
                container.innerHTML = '';
            }

            // Featured section (Home tab) - Load dynamic amount to fill screen
            fetch(`/api/assets/image?limit=${getDynamicLimit()}&offset=0`)
                .then(r => r.json())
                .then(data => {
                    
                    if (data.success && data.assets.length > 0) {
                        if (!container) return;
                        

                        // Shuffle the images array to get random selection
                        const shuffled = [...data.assets].sort(() => 0.5 - Math.random());
                        
                        // --- DYNAMIC CALCULATION ---
                        // Calculate items needed to fill the grid (columns * rows)
                        const containerWidth = container.clientWidth || window.innerWidth;
                        const availableWidth = containerWidth - 30; // Subtract padding
                        const minColWidth = 232; // 220px card + 12px gap
                        
                        let columns = Math.floor(availableWidth / minColWidth);
                        if (columns < 1) columns = 1;

                        // Adapt rows: 3 lines for normal, 4-5 for ultra-wide screens
                        let rows = 3;
                        if (window.innerWidth > 1900) rows = 4;
                        if (window.innerWidth > 2800) rows = 5;

                        let itemCount = columns * rows;
                        // Adjust for large feature (2x2) on desktop: takes 4 slots, counts as 1 item (-3 total)
                        if (window.innerWidth > 640) itemCount -= 3;
                        
                        const featuredList = shuffled.slice(0, Math.max(1, itemCount));
                        
                        featuredList.forEach((asset, index) => {
                            const smallUrl = window.getGridImageUrl(asset);
                            const dims = getDimensions(asset.resolution);

                            // Create the card element
                            const card = document.createElement('a');
                            card.href = asset.view_url || `/view/${asset.category_type || 'image'}/${asset.id}`;
                            card.className = 'grid-box';
                            if (window.innerWidth > 640 && index === 0) {
                                card.classList.add('large');
                            }
                            
                            card.innerHTML = `<img src="${smallUrl}" alt="${asset.name || 'Featured Image'}" width="${dims.w}" height="${dims.h}">`;

                            // Add click event
                            card.addEventListener('click', (e) => {
                                if (e.metaKey || e.ctrlKey) return;
                                e.preventDefault();
                                openImageViewer(asset, index, featuredList);
                            });

                            container.appendChild(card);
                        });
                        
                    }
                })
                .catch(e => {});
        }

        // LOADING ANIMATION
        const loader = document.querySelector('.page-loader');
        const logo = document.querySelector('.logo');

        function animateLoader(callback) {
            // Reset
            loader.style.width = '0';
            loader.style.opacity = '1';
            loader.style.transition = 'none';
            
            // Force reflow
            void loader.offsetWidth;

            // Animate to 80%
            loader.style.transition = 'width 1.5s cubic-bezier(0.2, 0.8, 0.2, 1)';
            loader.style.width = '80%';

            // Finish animation (simulated)
            setTimeout(() => {
                loader.style.width = '100%';
                setTimeout(() => {
                    loader.style.opacity = '0';
                    if (callback && typeof callback === 'function') {
                        callback();
                    }
                }, 200);
            }, 1000);
        }

        // SIDEBAR NAV BUTTONS LOGIC
        const sidebarNavButtons = document.querySelectorAll('.sidebar-nav-btn');
        sidebarNavButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetId = e.currentTarget.getAttribute('data-target');
                if(!targetId) return;

                // Fix: Remove mobile optimization style if it exists to prevent layout locking
                const mobileStyle = document.getElementById('mobile-opt-style');
                if (mobileStyle) mobileStyle.remove();

                // Push State for Back Button Support
                window.history.pushState({section: targetId}, '', window.location.pathname);

                // Direct section switch
                animateLoader(() => {
                    window.scrollTo(0, 0);
                    document.querySelectorAll('.content-section').forEach(sec => {
                        sec.style.display = 'none';
                    });
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                    }

                    // Lazy load content based on target
                    if (targetId === 'section-home') {
                        loadHomeContent();
                        if (typeof gtag === 'function') gtag('event', 'page_view', { page_title: 'Home', page_path: '/' });
                    }
                    if (targetId === 'section-images') {
                        loadImagesContent();
                        if (typeof gtag === 'function') gtag('event', 'page_view', { page_title: 'Gallery', page_path: '/gallery' });
                    }
                    if (targetId === 'section-generator') loadGeneratorContent();

                    if(window.innerWidth <= 768) closeAllMenus();
                });
            });
        });

        logo.addEventListener('click', (e) => {
            e.preventDefault();
            const homeBtn = document.querySelector('.sidebar-nav-btn[data-target="section-home"]');
            if(homeBtn) {
                homeBtn.click();
            } else {
                animateLoader(); // Fallback if home button not found
            }
        });

        // MOBILE MENU TOGGLE
        const leftMenuToggle = document.querySelector('.menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        
        // RIGHT MENU TOGGLE
        const rightMenuToggle = document.getElementById('rightMenuToggle');
        const rightSidebar = document.querySelector('.right-sidebar');
        const closeRightBtn = document.getElementById('closeRight');

        // MOBILE SEARCH TRANSFORMATION
        const mobileSearchBtn = document.getElementById('mobileSearchBtn');
        const navbar = document.querySelector('.navbar');
        const searchInput = document.querySelector('.search-input');
        const searchWrapper = document.querySelector('.search-wrapper');

        if (mobileSearchBtn) {
            mobileSearchBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                navbar.classList.add('search-active');
                setTimeout(() => searchInput.focus(), 100);
            });
        }
        
        document.addEventListener('click', (e) => {
            if (navbar.classList.contains('search-active') && !searchWrapper.contains(e.target)) {
                navbar.classList.remove('search-active');
            }
        });

        const overlay = document.querySelector('.sidebar-overlay');

        // ================= UPLOAD MODAL LOGIC =================
        const uploadNavBtn = document.getElementById('uploadNavBtn');
        const uploadModal = document.getElementById('uploadModal');

        function closeUploadModal() {
            uploadModal.classList.remove('active');
            toggleMobileBackground(false);
            if (typeof gtag === 'function') gtag('event', 'page_view', { page_title: 'Home', page_path: '/' });
            setTimeout(() => {
                uploadModal.style.display = 'none';
            }, 300);
        }

        if (uploadNavBtn) {
            uploadNavBtn.addEventListener('click', () => {
            // Show loader
            animateLoader();
            
            toggleMobileBackground(true);
            // Check if already loaded
            if (uploadModal.querySelector('.uploader-template-wrapper')) {
                uploadModal.style.display = 'flex';
                setTimeout(() => uploadModal.classList.add('active'), 10);
                return;
            }

            // Fetch the upload template
            fetch('/uploader-template') 
                .then(response => response.text())
                .then(html => {
                    uploadModal.innerHTML = html;
                    
                    // Add Exit Button to the wrapper
                    const wrapper = uploadModal.querySelector('.uploader-template-wrapper');
                    const exitBtn = document.createElement('button');
                    exitBtn.className = 'upload-close-btn';
                    exitBtn.innerHTML = '&times;';
                    exitBtn.onclick = closeUploadModal;
                    
                    if (wrapper) {
                        wrapper.style.maxHeight = '90vh';
                        wrapper.style.maxWidth = '1200px';
                        wrapper.style.width = '95%';
                        wrapper.style.boxShadow = '0 40px 80px rgba(0,0,0,0.6)';
                        wrapper.style.position = 'relative';
                        wrapper.appendChild(exitBtn);
                    } else {
                        uploadModal.appendChild(exitBtn);
                    }

                    // Show Modal
                    uploadModal.style.display = 'flex';
                    setTimeout(() => {
                        uploadModal.classList.add('active');
                    }, 10);

                    // Execute Scripts inside the template
                    const scripts = uploadModal.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });
                    
                    // Apply translations after injecting the HTML
                    if (window.translationSystem) {
                        window.translationSystem.applyTranslations(window.translationSystem.currentLang);
                    }
                })
                .catch(err => console.error('Failed to load upload form', err));
            });
        }

        // ================= EDITOR MODAL LOGIC =================
        const editorModal = document.getElementById('editorModal');

        function closeEditorModal() {
            editorModal.classList.remove('active');
            toggleMobileBackground(false);
            if (typeof gtag === 'function') gtag('event', 'page_view', { page_title: 'Home', page_path: '/' });
            setTimeout(() => {
                editorModal.style.display = 'none';
                editorModal.innerHTML = '';
            }, 300);
        }

        function openEditorModal(asset) {
            animateLoader();
            toggleMobileBackground(true);
            // Make asset available to the editor script
            window.currentEditingAsset = asset;

            fetch('/image-editor-template')
                .then(response => response.text())
                .then(html => {
                    editorModal.innerHTML = html;
                    
                    // Add Close Button
                    const exitBtn = document.createElement('button');
                    exitBtn.className = 'upload-close-btn';
                    exitBtn.innerHTML = '&times;';
                    exitBtn.onclick = closeEditorModal;
                    
                    // Append to the first child (wrapper) if exists, else to modal
                    if (editorModal.firstElementChild) {
                        editorModal.firstElementChild.appendChild(exitBtn);
                    } else {
                        editorModal.appendChild(exitBtn);
                    }

                    editorModal.style.display = 'flex';
                    setTimeout(() => editorModal.classList.add('active'), 10);

                    // Execute Scripts
                    const scripts = editorModal.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });

                    // Initialize the editor using the function defined in the loaded template
                    if (typeof window.launchImageEditor === 'function') {
                        window.launchImageEditor(asset);
                    }

                    // Ensure the editor's Cancel button closes the modal completely
                    const editorCancelBtn = document.getElementById('editorCancelBtn');
                    if (editorCancelBtn) {
                        editorCancelBtn.onclick = closeEditorModal;
                    }
                })
                .catch(err => console.error('Failed to load editor', err));
        }

        // ================= PROFILE VIEW LOGIC =================
        const myProfileBtn = document.getElementById('myProfileBtn');
        const profileSection = document.getElementById('section-profile');

        if (myProfileBtn) {
            myProfileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (typeof closeAllMenus === 'function') closeAllMenus();

                // Hide all other sections
                document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
                document.getElementById('section-home').style.display = 'none'; // Ensure home is hidden
                
                // Show Profile Section
                profileSection.style.display = 'block';

                // Check if already loaded
                if (profileSection.innerHTML.trim() !== "") {
                    return;
                }

                // Fetch Template
                fetch('/profile-template?t=' + Date.now())
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status} - Route not found`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        profileSection.innerHTML = html;
                        
                        // Execute Scripts inside the template
                        const scripts = profileSection.querySelectorAll('script');
                        scripts.forEach(oldScript => {
                            const newScript = document.createElement('script');
                            Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });

                    })
                    .catch(err => {
                        console.error('Error loading profile:', err);
                        alert("{{ t('Failed to load profile. Ensure the backend route /profile-template exists.') }}");
                    });
            });
        }

        window.openReportSettings = function(id, category) {
            if (typeof openReportModal === 'function') openReportModal(id, category);
        };

        // ================= SETTINGS LOGIC =================
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsTriggers = document.querySelectorAll('.settings-trigger');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');

        function openSettings(targetTab = null) {
            if (typeof closeAllMenus === 'function') closeAllMenus();
            toggleMobileBackground(true);
            
            // Fetch Settings Template
            fetch('/settings-template')
                .then(response => response.text())
                .then(html => {
                    settingsModal.innerHTML = html;
                    settingsModal.classList.add('active');
                    
                    // Execute Scripts inside the template
                    const scripts = settingsModal.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });

                    // Switch tab if requested
                    if (targetTab && typeof window.switchSettingsTab === 'function') {
                        setTimeout(() => window.switchSettingsTab(targetTab), 50);
                    }
                })
                .catch(err => console.error('Failed to load settings', err));
        }

        function closeSettings() {
            settingsModal.classList.remove('active');
            toggleMobileBackground(false);
            if (typeof gtag === 'function') gtag('event', 'page_view', { page_title: 'Home', page_path: '/' });
        }

        if (settingsBtn) settingsBtn.addEventListener('click', (e) => { e.preventDefault(); openSettings(); });
        settingsTriggers.forEach(btn => btn.addEventListener('click', (e) => { e.preventDefault(); openSettings(); }));
        if (closeSettingsBtn) closeSettingsBtn.addEventListener('click', closeSettings);
        if (settingsModal) settingsModal.addEventListener('click', (e) => { if(e.target === settingsModal) closeSettings(); });

        // Settings Tabs
        window.switchSettingsTab = function(tabName) {
            // Update Nav
            document.querySelectorAll('.settings-nav-item').forEach(btn => {
                if(btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(tabName)) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            
            // Update Content
            document.querySelectorAll('.settings-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            const targetSection = document.getElementById('settings-tab-' + tabName);
            if (targetSection) {
                targetSection.classList.add('active');
            } else if (tabName !== 'general') {
                const general = document.getElementById('settings-tab-general');
                if (general) general.classList.add('active');
            }
            
            // Update Title
            const titles = { 'general': 'General Settings', 'appearance': 'Appearance', 'account': 'Account Settings', 'support': 'Help & Support' };
            const titleEl = document.getElementById('settingsTitle');
            if (titleEl) titleEl.textContent = titles[tabName] || 'Settings';
        };

        // ================= TRANSLATION SYSTEM =================
        class TranslationSystem {
            constructor() {
                this.currentLang = localStorage.getItem('app_lang') || 'en';
                this.translations = {};
                
                // Initialize selector if exists
                const selector = document.getElementById('languageSelect');
                if(selector) selector.value = this.currentLang;

                // Always load the current language to ensure data is available
                this.loadLanguage(this.currentLang);
            }

            async setLanguage(lang) {
                if(lang === this.currentLang) return;
                await this.loadLanguage(lang);
            }

            async loadLanguage(lang) {
                // Check cache
                if (this.translations[lang]) {
                    this.applyTranslations(lang);
                    return;
                }

                try {
                    // Fetch JSON from static folder (You must move your JSON files to /static/locales/)
                    // Mapping: en -> english.json, fr -> french.json, etc.
                    // Fetch JSON from static folder
                    const fileMap = { 'en': 'english', 'fr': 'fr', 'es': 'espagnol', 'de': 'german', 'pt': 'Brazilian Portuguese' };
                    const filename = fileMap[lang] || 'english';
                    
                    const response = await fetch(`/static/locales/${filename}.json`);
                    if(!response.ok) throw new Error('Language file not found');
                    
                    const data = await response.json();
                    this.translations[lang] = data;
                    this.currentLang = lang;
                    
                    // Update Categories List and Re-render UI
                    if (CATEGORIES_DB[lang]) categoriesList = CATEGORIES_DB[lang];
                    renderCategoryWidgets();
                    
                    localStorage.setItem('app_lang', lang);
                    this.applyTranslations(lang);
                } catch (e) {
                    console.error('Translation failed:', e);
                }
            }

            t(key, defaultText) {
                const data = this.translations[this.currentLang];
                if (data && data[key]) {
                    return data[key];
                }
                return defaultText;
            }

            applyTranslations(lang) {
                const data = this.translations[lang];
                if (!data) return;

                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (data[key]) {
                        // Handle attributes like placeholder
                        const targetAttr = el.getAttribute('data-i18n-attr');
                        if (targetAttr) {
                            el.setAttribute(targetAttr, data[key]);
                        } else {
                            // Handle text content
                            // If element has children (like icons), we might need to be careful
                            // For now, we assume simple text replacement or span wrapping
                            if(el.children.length === 0) {
                                el.textContent = data[key];
                            } else {
                                // If it has children, try to find a text node or just replace text content if it's safe
                                // Ideally, wrap text in spans in HTML. 
                                // Fallback:
                                el.childNodes.forEach(node => {
                                    if(node.nodeType === 3 && node.nodeValue.trim() !== '') {
                                        node.nodeValue = data[key];
                                    }
                                });
                            }
                        }
                    }
                });
            }
        }

        // Initialize
        window.translationSystem = new TranslationSystem();

        // Theme Switcher
        window.setTheme = function(color, el) {
            document.documentElement.style.setProperty('--primary', color);
            document.documentElement.style.setProperty('--primary-dark', color);
            
            document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
            el.classList.add('active');
            
            // Save to local storage
            localStorage.setItem('theme-color', color);
            
            // Save to Backend
            fetch('/api/user/preferences', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ theme_color: color })
            }).catch(e => console.error('Failed to save theme', e));
        };

        // Theme Mode Toggle
        window.toggleThemeMode = function(checkbox) {
            const mode = checkbox.checked ? 'light' : 'dark';
            const metaThemeColor = document.querySelector('meta[name="theme-color"]');
            if (mode === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                if (metaThemeColor) metaThemeColor.setAttribute('content', '#f2f2f7');
            } else {
                document.documentElement.removeAttribute('data-theme');
                if (metaThemeColor) metaThemeColor.setAttribute('content', '#0c0f16');
            }
            
            localStorage.setItem('theme-mode', mode);
            
            fetch('/api/user/preferences', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ theme_mode: mode })
            }).catch(e => console.error('Failed to save mode', e));
        };

        // Initialize Toggle State
        const currentMode = document.documentElement.getAttribute('data-theme');
        const modeToggle = document.getElementById('themeModeToggle');
        if(modeToggle) modeToggle.checked = (currentMode === 'light');

        // Custom Color Picker Logic
        const themeColorInput = document.getElementById('themeColorInput');
        const customColorSwatch = document.getElementById('customColorSwatch');

        if (themeColorInput && customColorSwatch) {
            themeColorInput.addEventListener('input', (e) => {
                const color = e.target.value;
                document.documentElement.style.setProperty('--primary', color);
                document.documentElement.style.setProperty('--primary-dark', color);
                
                // Visual feedback
                document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
                customColorSwatch.classList.add('active');
                customColorSwatch.style.background = color;
                customColorSwatch.querySelector('span').style.display = 'none';
            });

            themeColorInput.addEventListener('change', (e) => {
                const color = e.target.value;
                setTheme(color, customColorSwatch);
            });
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme-color');
        if(savedTheme) {
            document.documentElement.style.setProperty('--primary', savedTheme);
            const swatches = document.querySelectorAll('.theme-swatch');
            let foundPreset = false;
            swatches.forEach(s => {
                const onclick = s.getAttribute('onclick');
                if(onclick && onclick.includes(savedTheme)) {
                    s.classList.add('active');
                    foundPreset = true;
                }
                else s.classList.remove('active');
            });
            
            if (!foundPreset && customColorSwatch) {
                customColorSwatch.classList.add('active');
                customColorSwatch.style.background = savedTheme;
                if(themeColorInput) themeColorInput.value = savedTheme;
                const icon = customColorSwatch.querySelector('span');
                if(icon) icon.style.display = 'none';
            }
        }

        // ================= SAVED ITEMS LOGIC =================
        const savedBtn = document.getElementById('savedBtn');
        if (savedBtn) {
            savedBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (typeof closeAllMenus === 'function') closeAllMenus();
                
                // Switch Section
                document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
                const savedSection = document.getElementById('section-saved');
                savedSection.style.display = 'block';
                
                animateLoader();
                if (!savedLoaded) {
                    savedLoaded = true;
                    loadSavedAssets();
                }
            });
        }

        function loadSavedAssets() {
            const grid = document.getElementById('saved-grid');
            const emptyState = document.getElementById('saved-empty');
            
            fetch('/api/user/saved')
            .then(r => {
                if(r.status === 401) {
                    if (typeof openAuthModal === 'function') openAuthModal('signup');
                    else if (document.querySelector('.signup-trigger')) document.querySelector('.signup-trigger').click();
                    throw new Error('Auth required');
                }
                return r.json();
            })
            .then(data => {
                if(data.success) {
                    grid.innerHTML = '';
                    if(data.assets.length === 0) {
                        emptyState.style.display = 'block';
                        return;
                    }
                    emptyState.style.display = 'none';
                    
                    data.assets.forEach((asset, index) => {
                        const card = createImageCard(asset, index, data.assets);
                        grid.appendChild(card);
                    });
                }
            })
            .catch(e => {
                console.log(e);
                if (!navigator.onLine) updateConnectionStatus();
            });
        }

        function closeAllMenus() {
            sidebar.classList.remove('active');
            if (rightSidebar) rightSidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        function toggleLeftMenu() {
            if (sidebar.classList.contains('active')) closeAllMenus();
            else {
                closeAllMenus();
                sidebar.classList.add('active');
                overlay.classList.add('active');
            }
        }

        function toggleRightMenu() {
            if (rightSidebar) {
                if (rightSidebar.classList.contains('active')) closeAllMenus();
                else {
                    closeAllMenus();
                    rightSidebar.classList.add('active');
                    overlay.classList.add('active');
                }
            }
        }

        leftMenuToggle.addEventListener('click', toggleLeftMenu);
        if (rightMenuToggle) {
            rightMenuToggle.addEventListener('click', toggleRightMenu);
        }
        if (closeRightBtn) {
            closeRightBtn.addEventListener('click', closeAllMenus);
        }
        overlay.addEventListener('click', closeAllMenus);

        // ================= IMAGE VIEWER LOGIC =================
        const imageViewerModal = document.getElementById('imageViewerModal');
        const closeViewerBtn = document.getElementById('closeViewerBtn');
        const viewerImage = document.getElementById('viewerImage');
        const viewerTitle = document.getElementById('viewerTitle');
        const expandViewerBtn = document.getElementById('expandViewerBtn');
        const similarGrid = document.getElementById('similarGrid');
        const relatedSearchesContainer = document.getElementById('viewerRelatedSearches');
        const viewerUsernameMobile = document.getElementById('viewerUsernameMobile');
        const viewerAvatarMobile = document.getElementById('viewerAvatarMobile');
        const expandViewerBtnMobile = document.getElementById('expandViewerBtnMobile');
        const prevImageBtn = document.getElementById('prevImageBtn');
        const nextImageBtn = document.getElementById('nextImageBtn');
        const shareImageBtn = document.getElementById('shareImageBtn');

        const viewerFollowBtn = document.getElementById('viewerFollowBtn');
        const viewerFollowBtnMobile = document.getElementById('viewerFollowBtnMobile');
        let galleryImages = [];
        let currentViewerList = [];
        let currentImageIndex = 0;

        // --- SPECIAL SEARCH LIBRARY ---
        const SPECIAL_SEARCH_LIBRARY = {
            "Anime": [
                "Anime Fight", "Anime Portrait", "Cyberpunk City", "Fantasy World", "Anime Warrior",
                "Studio Ghibli", "Manga Style", "Anime Girl", "Anime Boy", "Mecha", "Kawaii", "Anime Scenery",
                "Dark Anime", "Anime School", "Samurai", "Ninja", "Demon Slayer", "Dragon Ball"
            ],
            "Nature": [
                "Mountain Lake", "Mystical Forest", "Macro Leaf", "Ocean Sunset", "River Aerial",
                "Waterfall", "Desert Dunes", "Snowy Peaks", "Tropical Beach", "Autumn Woods", "Spring Flowers", "Rainforest",
                "Northern Lights", "Canyon", "Island", "Volcano", "Thunderstorm", "Sunrise"
            ],
            "Cyberpunk": [
                "Neon Street", "Cyborg Portrait", "Sci-Fi City", "Neon Alley", "Hacker Room",
                "Futuristic Car", "Night City", "Cybernetic", "Blade Runner Style", "Synthwave", "Retrowave", "Glitch Art",
                "Robot", "Neon Rain", "Tokyo Night", "Dystopian", "High Tech", "Virtual Reality"
            ],
            "Abstract": [
                "Fluid Art", "3D Geometric", "Dark Glow", "Fractal Patterns", "Minimalist",
                "Smoke Effect", "Liquid Metal", "Neon Lines", "Colorful Swirls", "Glassmorphism", "Low Poly", "Digital Waves",
                "Texture", "Gradient", "Bokeh", "Light Leak", "Motion Blur", "Vaporwave"
            ],
            "Cars": [
                "Sports Car", "JDM Racing", "Vintage Muscle", "Concept Car", "Rally Drift",
                "Supercar", "Classic Car", "Luxury Interior", "Formula 1", "Street Racing", "Off-road 4x4", "Motorcycle",
                "Drifting", "Neon Car", "Porsche", "Ferrari", "Lamborghini", "BMW"
            ],
            "Space": [
                "Deep Nebula", "Astronaut", "Alien Planet", "Galaxy Spiral", "Space Station",
                "Black Hole", "Milky Way", "Star Field", "Rocket Launch", "Moon Surface", "Solar System", "Cosmic Art",
                "Mars", "Earth from Space", "Interstellar", "Stardust", "Comet", "Eclipse"
            ],
            "Animals": [
                "Wild Lion", "Cute Cat", "Wolf Portrait", "Eagle Eye", "Underwater Fish",
                "Tropical Bird", "Horse Running", "Panda Bear", "Fox Snow", "Tiger Face", "Puppy Dog", "Butterfly",
                "Deer", "Owl", "Leopard", "Shark", "Whale", "Jellyfish"
            ],
            "Architecture": [
                "Modern Skyscraper", "Gothic Cathedral", "Minimalist House", "Urban Bridge", "Ancient Ruins",
                "City Skyline", "Interior Design", "Glass Building", "Spiral Staircase", "Castle", "Street View", "Night Lights",
                "Paris", "New York", "Tokyo", "London", "Dubai", "Futuristic Building"
            ],
            "Gaming": [
                "Gaming Setup", "Fantasy RPG", "FPS Action", "Retro Console", "Pixel Art",
                "Esports Arena", "Character Design", "Game World", "Virtual Reality", "Arcade", "Strategy Map", "Boss Fight",
                "Minecraft", "Cyberpunk Game", "Zelda Style", "Elden Ring Style", "Controller", "Neon Gaming"
            ]
        };

        function getSpecialPrompts(category) {
            if (!category) category = "Abstract";
            
            // Check library first (Exact match)
            if (SPECIAL_SEARCH_LIBRARY[category]) return SPECIAL_SEARCH_LIBRARY[category];
            
            // Check library (Case-insensitive match)
            const lowerCat = category.toLowerCase();
            const key = Object.keys(SPECIAL_SEARCH_LIBRARY).find(k => k.toLowerCase() === lowerCat);
            if (key) return SPECIAL_SEARCH_LIBRARY[key];
            
            // Fallback Generator for other categories
            return [
                `${category} Wallpaper`,
                `Aesthetic ${category}`,
                `Creative ${category}`,
                `Minimalist ${category}`,
                `Futuristic ${category}`,
                `Dark ${category}`,
                `Neon ${category}`,
                `High Quality ${category}`,
                `${category} Background`,
                `Best ${category}`,
                `Cinematic ${category}`,
                `4K ${category}`
            ];
        }

        function openImageViewer(asset, index = -1, list = null) {
            if (!imageViewerModal.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
                toggleMobileBackground(true);
            }

            // Track View
            fetch('/api/track/view', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({asset_id: asset.id, category: asset.category || 'image'})
            }).catch(e => {});
            
            const viewerLeft = document.querySelector('#imageViewerModal .viewer-left');
            const viewerScroll = document.querySelector('#imageViewerModal .viewer-scroll-view');
            // Reset scroll to top every time viewer opens
            if (viewerLeft) {
                viewerLeft.scrollTop = 0;
            }
            if (viewerScroll) {
                viewerScroll.scrollTop = 0;
            }

            if (window.innerWidth <= 768 && viewerLeft) {
                viewerLeft.classList.add('skeleton');
            }

            const mediumUrl = asset.link_medium ? `/uploads/${asset.link_medium}` : `/uploads/${asset.link_small}`;
            
            // Progressive Loading: Use cached low-res first
            const lowResUrl = asset.link_tiny ? `/uploads/${asset.link_tiny}` : `/uploads/${asset.link_small}`;
            
            // 1. Show low res immediately (likely cached)
            viewerImage.src = lowResUrl;
            viewerImage.dataset.currentAssetId = asset.id; // Track current asset to prevent race conditions

            // 2. Load high res in background
            const highResImg = new Image();
            highResImg.src = mediumUrl;
            highResImg.onload = () => {
                // Only swap if user hasn't navigated away
                if (viewerImage.dataset.currentAssetId === String(asset.id)) {
                    viewerImage.src = mediumUrl;
                    if (viewerLeft) viewerLeft.classList.remove('skeleton');
                }
            };
            highResImg.onerror = () => { if (viewerLeft) viewerLeft.classList.remove('skeleton'); };

            viewerTitle.textContent = asset.name || 'Image';
            const viewerDesc = document.getElementById('viewerDescription');
            if (viewerDesc) viewerDesc.textContent = asset.description || 'No description available';
            document.getElementById('viewerRes').textContent = asset.resolution || 'Unknown';
            document.getElementById('viewerQuality').textContent = asset.quality || 'Unknown';
            
            // Update User Info
            const viewerUsername = document.getElementById('viewerUsername');
            const viewerAvatar = document.getElementById('viewerAvatar');
            
            if (viewerUsername) {
                viewerUsername.textContent = asset.username || 'Unknown Artist';
            }
            
            // Make viewer user info clickable
            const viewerUserElements = document.querySelectorAll('#imageViewerModal .user-info-group, #imageViewerModal .account-circle');
            viewerUserElements.forEach(el => {
                el.onclick = (e) => { 
                    e.stopPropagation();
                    closeImageViewer(); 
                    openUserProfile(asset.user_id, asset.username, asset.avatar); 
                };
                el.style.cursor = 'pointer';
            });

            if (viewerUsernameMobile) {
                viewerUsernameMobile.textContent = asset.username || 'Unknown Artist';
            }
            if (viewerAvatar) {
                viewerAvatar.src = asset.avatar ? (asset.avatar.startsWith('/static/') ? asset.avatar : `/static/avatars/${asset.avatar}`) : 'https://via.placeholder.com/50';
            }
            if (viewerAvatarMobile) {
                viewerAvatarMobile.src = asset.avatar ? (asset.avatar.startsWith('/static/') ? asset.avatar : `/static/avatars/${asset.avatar}`) : 'https://via.placeholder.com/50';
            }

            // Render Related Search Buttons
            if (relatedSearchesContainer) {
                relatedSearchesContainer.innerHTML = '';
                const prompts = getSpecialPrompts(asset.category || 'Abstract');
                prompts.forEach(prompt => {
                    const btn = document.createElement('button');
                    btn.className = 'search-chip';
                    btn.textContent = prompt;
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        closeImageViewer();
                        const searchInput = document.querySelector('.search-input');
                        if(searchInput) { searchInput.value = prompt; window.performSearch(); }
                    };
                    relatedSearchesContainer.appendChild(btn);
                });
            }

            // Reset Follow Buttons
            const followBtns = [viewerFollowBtn, viewerFollowBtnMobile];
            const plusIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
            const checkIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';

            const sessionData = localStorage.getItem('user_session');
            const loggedInUserId = sessionData ? JSON.parse(sessionData).user_id : null;

            followBtns.forEach(btn => {
                if(btn) {
                    // Show for guests or if not own image
                    if (!loggedInUserId || (loggedInUserId && String(loggedInUserId) !== String(asset.user_id))) {
                        btn.style.display = 'flex';
                    } else {
                        btn.style.display = 'none';
                    }
                    
                    btn.classList.remove('secondary');
                    btn.style.background = 'var(--primary)';
                    btn.style.color = 'white';
                    btn.innerHTML = `${plusIcon} <span>{{ t('Follow') }}</span>`;
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        toggleFollow(asset.user_id, btn);
                    };
                }
            });

            // Check Follow Status (Only if logged in)
            if (loggedInUserId && asset.user_id && loggedInUserId != asset.user_id) {
                fetch(`/api/user/${asset.user_id}/details`)
                    .then(r => r.json())
                    .then(data => {
                        if(data.success && data.user) {
                            const isFollowing = data.user.is_following;
                            followBtns.forEach(btn => {
                                if(btn) {
                                    btn.innerHTML = isFollowing ? `${checkIcon} <span>{{ t('Following') }}</span>` : `${plusIcon} <span>{{ t('Follow') }}</span>`;
                                    if(isFollowing) {
                                        btn.classList.add('secondary');
                                        btn.style.background = '';
                                        btn.style.color = '';
                                    }
                                }
                            });
                        }
                    });
            }

            const editBtn = document.getElementById('editImageBtn');
            if (editBtn) {
                editBtn.onclick = () => {
                    openEditorModal(asset);
                };
            }

            // Share Button Logic
            if (shareImageBtn) {
                shareImageBtn.onclick = () => {
                    const shareData = {
                        title: asset.name || 'Image',
                        text: `Check out this image by ${asset.username || 'User'}`,
                        url: window.location.origin + `/view/${asset.category_type || 'image'}/${asset.id}/${(asset.name || 'image').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '')}`
                    };
                    
                    if (navigator.share) {
                        navigator.share(shareData).catch(console.error);
                    } else {
                        navigator.clipboard.writeText(shareData.url).then(() => alert("{{ t('Link copied to clipboard!') }}"));
                    }
                };
            }

            // Report Button Logic
            const reportBtn = document.getElementById('reportImageBtn');
            if (reportBtn) {
                reportBtn.onclick = () => {
                    openReportSettings(asset.id, asset.category_type || 'image');
                };
            }

            // Download Button Logic
            const downloadBtn = document.getElementById('downloadImageBtn');
            if (downloadBtn) {
                downloadBtn.onclick = () => {
                    window.location.href = `/download/${asset.category_type || 'image'}/${asset.id}`;
                };
            }
            
            if (list) {
                currentViewerList = list;
            } else {
                currentViewerList = galleryImages;
            }
            if (index !== -1) currentImageIndex = index;
            imageViewerModal.classList.add('active');
            imageViewerModal.focus();

            loadSimilarImages(asset.category_type, asset.id);
        }

        // Global Keydown Listener for Viewer Scrolling
        document.addEventListener('keydown', (e) => {
            if (!imageViewerModal.classList.contains('active')) return;
            
            const viewerLeft = document.querySelector('#imageViewerModal .viewer-left');
            if (!viewerLeft) return;
            const viewerScroll = document.querySelector('#imageViewerModal .viewer-scroll-view');
            if (!viewerScroll) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                viewerLeft.scrollBy({ top: 150, behavior: 'smooth' });
                viewerScroll.scrollBy({ top: 150, behavior: 'smooth' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                viewerLeft.scrollBy({ top: -150, behavior: 'smooth' });
                viewerScroll.scrollBy({ top: -150, behavior: 'smooth' });
            }
        });

        function closeImageViewer() {
            document.body.style.overflow = '';
            const lockStyle = document.getElementById('temp-lock-css');
            if (lockStyle) lockStyle.remove();
            
            imageViewerModal.classList.remove('active');
            toggleMobileBackground(false);
            setTimeout(() => { viewerImage.src = ''; }, 300);
        }

        closeViewerBtn.addEventListener('click', closeImageViewer);
        imageViewerModal.addEventListener('click', (e) => {
            if (e.target === imageViewerModal) closeImageViewer();
        });

        function toggleFullScreen() {
            if (viewerImage.requestFullscreen) {
                viewerImage.requestFullscreen();
            } else if (viewerImage.webkitRequestFullscreen) { /* Safari */
                viewerImage.webkitRequestFullscreen();
            } else if (viewerImage.msRequestFullscreen) { /* IE11 */
                viewerImage.msRequestFullscreen();
            }
        }

        if(expandViewerBtn) expandViewerBtn.addEventListener('click', toggleFullScreen);
        if(expandViewerBtnMobile) expandViewerBtnMobile.addEventListener('click', toggleFullScreen);

        function updateViewerImage() {
            if (currentViewerList.length === 0) return;
            const asset = currentViewerList[currentImageIndex];
            openImageViewer(asset, currentImageIndex, currentViewerList);
        }

        prevImageBtn.addEventListener('click', () => {
            if (currentViewerList.length === 0) return;
            currentImageIndex = (currentImageIndex - 1 + currentViewerList.length) % currentViewerList.length;
            updateViewerImage();
        });

        nextImageBtn.addEventListener('click', () => {
            if (currentViewerList.length === 0) return;
            currentImageIndex = (currentImageIndex + 1) % currentViewerList.length;
            updateViewerImage();
        });

        // ================= SIGNUP MODAL LOGIC =================
        const signupModal = document.getElementById('signupModal');
        const closeSignupBtn = document.getElementById('closeSignupBtn');
        const signupTriggers = document.querySelectorAll('.signup-trigger');
        const loginTriggers = document.querySelectorAll('.login-trigger');

        function openAuthModal(mode) {
            toggleMobileBackground(true);
            signupModal.classList.add('active');
            if (typeof closeAllMenus === 'function') closeAllMenus();
            
            const toggleLink = document.getElementById('authToggleLink');
            if (toggleLink) {
                if (mode === 'login' && !isLoginMode) toggleLink.click();
                else if (mode === 'signup' && isLoginMode) toggleLink.click();
            }
        }

        signupTriggers.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                openAuthModal('signup');
            });
        });

        loginTriggers.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                openAuthModal('login');
            });
        });

        if(closeSignupBtn) {
            closeSignupBtn.addEventListener('click', () => {
                signupModal.classList.remove('active');
                toggleMobileBackground(false);
            });
        }
        if(signupModal) {
            signupModal.addEventListener('click', (e) => { if (e.target === signupModal) {
                signupModal.classList.remove('active');
                toggleMobileBackground(false);
            }});
        }

        // ================= SECURITY ALERT LOGIC =================
        const securityModal = document.getElementById('securityModal');
        const closeSecurityBtn = document.getElementById('closeSecurityBtn');
        const ackSecurityBtn = document.getElementById('ackSecurityBtn');

        window.triggerSecurityAlert = function(reason) {
            console.warn('Security Alert System Triggered:', reason);
            if(!securityModal) return;
            
            // 1. Close any open upload/editor modals to "shut down process"
            if(typeof closeUploadModal === 'function') closeUploadModal();
            if(typeof closeEditorModal === 'function') closeEditorModal();
            
            // 2. Set Message
            const msgEl = document.getElementById('securityMessage');
            // Extract clean reason if it matches the backend format
            let displayReason = reason;
            if (reason && reason.includes('SECURITY ALERT:')) {
                displayReason = reason.split('SECURITY ALERT:')[1].split('.')[0].trim();
            }
            
            msgEl.textContent = "{{ t('Upload blocked. The image was flagged for:') }} " + (displayReason || "{{ t('Safety Violation') }}") + ".";
            
            // 3. Show Modal
            toggleMobileBackground(true);
            securityModal.classList.add('active');
        }

        function closeSecurityModal() {
            securityModal.classList.remove('active');
            toggleMobileBackground(false);
        }

        if(closeSecurityBtn) closeSecurityBtn.addEventListener('click', closeSecurityModal);
        if(ackSecurityBtn) ackSecurityBtn.addEventListener('click', closeSecurityModal);

     

        // ================= AUTH TOGGLE LOGIC =================
        const authToggleLink = document.getElementById('authToggleLink');
        const authTitle = document.getElementById('authTitle');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const nameInputGroup = document.getElementById('nameInputGroup');
        const authPromptText = document.getElementById('authPromptText');
        let isLoginMode = false;

        if (authToggleLink) {
            authToggleLink.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('authErrorMessage').style.display = 'none';
                isLoginMode = !isLoginMode;
                
                if (isLoginMode) {
                    authTitle.textContent = "{{ t('Welcome Back') }}";
                    authSubmitBtn.textContent = "{{ t('Log In') }}";
                    nameInputGroup.style.display = 'none';
                    nameInputGroup.querySelector('input').removeAttribute('required');
                    authPromptText.textContent = "{{ t("Don't have an account?") }}";
                    authToggleLink.textContent = "{{ t('Join Community') }}";
                } else {
                    authTitle.textContent = "{{ t('Create Account') }}";
                    authSubmitBtn.textContent = "{{ t('Sign Up') }}";
                    nameInputGroup.style.display = 'block';
                    nameInputGroup.querySelector('input').setAttribute('required', 'true');
                    authPromptText.textContent = "{{ t('Already have an account?') }}";
                    authToggleLink.textContent = "{{ t('Log In') }}";
                }
            });
        }

        // Sidebar Profile Button Logic
        const sidebarProfileBtn = document.getElementById('sidebarProfileBtn');
        if (sidebarProfileBtn) {
            sidebarProfileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const myProfileBtn = document.getElementById('myProfileBtn');
                if (myProfileBtn) myProfileBtn.click();
            });
        }

        // ================= AUTH FORM SUBMISSION =================
        const signupForm = document.getElementById('signupForm');
        if (signupForm) {
            signupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const nameInput = document.querySelector('#nameInputGroup input');
                const emailInput = signupForm.querySelector('input[type="email"]');
                const passwordInput = signupForm.querySelector('input[type="password"]');
                const submitBtn = document.getElementById('authSubmitBtn');
                const errorMsg = document.getElementById('authErrorMessage');
                
                const originalBtnText = submitBtn.textContent;
                submitBtn.textContent = "{{ t('Processing...') }}";
                submitBtn.disabled = true;

                let url = isLoginMode ? '/login' : '/register';
                let body = {};

                if (isLoginMode) {
                    body = { username: emailInput.value, password: passwordInput.value };
                } else {
                    body = { username: nameInput.value, email: emailInput.value, password: passwordInput.value };
                }

                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        if (isLoginMode) {
                            // Save user info to browser storage
                            localStorage.setItem('user_session', JSON.stringify({
                                username: data.username,
                                avatar: data.avatar,
                                role: data.role,
                                user_id: data.user_id
                            }));
                            window.location.reload();
                        } else { // On successful registration
                            errorMsg.textContent = "{{ t('Account created! Logging you in...') }}";
                            errorMsg.style.color = '#4caf50';
                            errorMsg.style.display = 'block';
                            
                            // Save session to local storage for consistency
                            localStorage.setItem('user_session', JSON.stringify({
                                username: data.username,
                                avatar: data.avatar,
                                role: data.role,
                                user_id: data.user_id
                            }));

                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        }
                    } else {
                        errorMsg.textContent = getTranslatedError(data.message, "{{ t('An error occurred') }}");
                        errorMsg.style.display = 'block';
                    }
                })
                .catch(err => { 
                    // console.error(err); 
                    errorMsg.textContent = getTranslatedError("NETWORK_ERROR", "{{ t('Network error. Please try again.') }}");
                    errorMsg.style.display = 'block';
                })
                .finally(() => { submitBtn.textContent = originalBtnText; submitBtn.disabled = false; });
            });
        }

        // ================= LIKE FUNCTIONALITY =================
        async function toggleLike(btn) {
            const id = btn.dataset.id;
            const category = btn.dataset.category;
            
            // Optimistic UI update
            btn.classList.toggle('active');
            
            try {
                const res = await fetch('/api/like', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({asset_id: id, category: category})
                });
                const data = await res.json();
                if(!data.success) {
                    btn.classList.toggle('active'); // Revert
                    if(data.message === 'Authentication required') {
                        if (typeof openAuthModal === 'function') openAuthModal('signup');
                        else if (document.querySelector('.signup-trigger')) document.querySelector('.signup-trigger').click();
                    }
                }
            } catch(e) {
                btn.classList.toggle('active'); // Revert
            }
        }

        async function toggleSave(btn) {
            const id = btn.dataset.id;
            const category = btn.dataset.category;
            
            btn.classList.toggle('active');
            
            try {
                const res = await fetch('/api/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({asset_id: id, category: category})
                });
                const data = await res.json();
                if(!data.success && data.message === 'Authentication required') {
                    btn.classList.toggle('active');
                    if (typeof openAuthModal === 'function') openAuthModal('signup');
                    else if (document.querySelector('.signup-trigger')) document.querySelector('.signup-trigger').click();
                }
            } catch(e) {
                btn.classList.toggle('active');
            }
        }

        // ================= CATEGORY MODAL LOGIC =================
        const categoryModal = document.getElementById('categoryModal');
        const filterTriggers = document.querySelectorAll('.filter-trigger');
        const closeCategoryBtn = document.getElementById('closeCategoryBtn');
        const categoryGrid = document.getElementById('categoryGrid');
        const modalResGrid = document.getElementById('modalResGrid');
        const modalSizeGrid = document.getElementById('modalSizeGrid');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const sidebarResGrid = document.getElementById('sidebarResGrid');
        const sidebarSizeGrid = document.getElementById('sidebarSizeGrid');
        const modalSortGrid = document.getElementById('modalSortGrid');

        function setupSelection(container, onSelect) {
            if(!container) return;
            const btns = container.querySelectorAll('.filter-btn');
            btns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.classList.contains('selected')) {
                        btn.classList.remove('selected');
                        onSelect(null);
                    } else {
                        btns.forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        onSelect(btn.dataset.value || btn.textContent.trim());
                    }
                });
            });
        }

        setupSelection(modalResGrid, (val) => selectedRes = val);
        setupSelection(modalSizeGrid, (val) => selectedSize = val);
        setupSelection(modalSortGrid, (val) => selectedSort = val || 'newest');

        // Sidebar Filter Logic (Immediate Search)
        setupSelection(sidebarResGrid, (val) => {
            selectedRes = val;
            window.performSearch();
            updateFilterActiveState();
        });
        setupSelection(sidebarSizeGrid, (val) => {
            selectedSize = val;
            window.performSearch();
            updateFilterActiveState();
        });

        window.updateFilterActiveState = function() {
            const hasFilters = selectedRes || selectedSize || selectedCat;
            document.querySelectorAll('.filter-trigger').forEach(btn => {
                if (hasFilters) btn.classList.add('active-filters');
                else btn.classList.remove('active-filters');
            });
        }

        filterTriggers.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                toggleMobileBackground(true);
                if (typeof closeAllMenus === 'function') closeAllMenus();
                
                // Populate if empty
                if (categoryGrid.children.length === 0) {
                    categoriesList.forEach(cat => {
                        const item = document.createElement('div');
                        item.className = 'category-item';
                        item.textContent = cat;
                        item.onclick = () => {
                            if (item.classList.contains('selected')) {
                                item.classList.remove('selected');
                                selectedCat = null;
                            } else {
                                const allItems = categoryGrid.querySelectorAll('.category-item');
                                allItems.forEach(i => i.classList.remove('selected'));
                                item.classList.add('selected');
                                selectedCat = cat;
                            }
                            
                            window.performSearch();
                            updateFilterActiveState();
                            categoryModal.classList.remove('active');
                            toggleMobileBackground(false);
                        };
                        categoryGrid.appendChild(item);
                    });
                }

                // Sync visual state with current selectedCat
                categoryGrid.querySelectorAll('.category-item').forEach(item => {
                    if (item.textContent === selectedCat) item.classList.add('selected');
                    else item.classList.remove('selected');
                });

                categoryModal.classList.add('active');
            });
        });

        if(applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', () => {
                const requestData = {
                    resolution: selectedRes,
                    size: selectedSize,
                    category: selectedCat,
                    sort: selectedSort
                };
                window.performSearch(); // Trigger search with selected filters
                
                updateFilterActiveState();

                categoryModal.classList.remove('active');
                toggleMobileBackground(false);
            });
        }

        window.initNavTabs = function() {
            const container = document.getElementById('navTabsContainer');
            const dropdown = document.getElementById('navTabDropdown');
            const plusBtn = document.getElementById('navPlusBtn');
            
            if (!container || !dropdown || !plusBtn) return;
            
            // Clear existing items for re-render
            container.innerHTML = '';
            dropdown.innerHTML = '';

            // 1. Add "Featured" first
            const featuredLink = document.createElement('a');
            featuredLink.href = "#";
            featuredLink.className = "nav-tab active";
            featuredLink.textContent = "Featured";
            featuredLink.setAttribute('data-i18n', "Featured");
            featuredLink.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                featuredLink.classList.add('active');
                const searchInput = document.querySelector('.search-input');
                if(searchInput) searchInput.value = '';
                
                selectedCat = null;
                selectedRes = null;
                selectedSize = null;
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('selected'));
                updateFilterActiveState();
                
                const homeBtn = document.querySelector('.sidebar-nav-btn[data-target="section-home"]');
                if(homeBtn) homeBtn.click();
            });
            container.appendChild(featuredLink);

            // 2. Populate Horizontal Bar & Dropdown
            categoriesList.forEach(cat => {
                // Add to horizontal bar
                const tab = document.createElement('a');
                tab.href = "#";
                tab.className = "nav-tab";
                tab.textContent = cat;
                
                tab.addEventListener('click', (e) => {
                    e.preventDefault();

                    if (tab.classList.contains('active')) {
                        // Already active, so deactivate by triggering the 'Featured' tab's logic
                        const featuredLink = document.querySelector('.nav-tab[data-i18n="Featured"]');
                        if (featuredLink) {
                            featuredLink.click();
                        }
                    } else {
                        // Not active, so activate it
                        // Reset other filters to ensure fresh search
                        selectedRes = null;
                        selectedSize = null;
                        document.querySelectorAll('.filter-btn.selected').forEach(b => b.classList.remove('selected'));

                        const searchInput = document.querySelector('.search-input');
                        if(searchInput) {
                            searchInput.value = cat;
                        selectedCat = null;
                            updateFilterActiveState();
                            searchInput.focus();
                            if (window.performSearch) window.performSearch();
                        }
                        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                    }
                });
                container.appendChild(tab);

                // Add to dropdown
                const dropItem = document.createElement('div');
                dropItem.className = "category-item";
                dropItem.textContent = cat;
                dropItem.onclick = () => {
                    // Reset filters
                    selectedRes = null;
                    selectedSize = null;
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('selected'));

                    const searchInput = document.querySelector('.search-input');
                    if(searchInput) {
                        searchInput.value = cat;
                        selectedCat = null;
                        updateFilterActiveState();
                        searchInput.focus();
                        if (window.performSearch) window.performSearch();
                    }
                    dropdown.classList.remove('active');
                    plusBtn.style.transform = 'rotate(0deg)';
                    
                    document.querySelectorAll('.nav-tab').forEach(t => {
                        if (t.textContent === cat) t.classList.add('active');
                        else t.classList.remove('active');
                    });
                };
                dropdown.appendChild(dropItem);
            });

            // 3. Toggle Dropdown
            // Remove old listeners to prevent duplicates if re-run
            const newPlusBtn = plusBtn.cloneNode(true);
            plusBtn.parentNode.replaceChild(newPlusBtn, plusBtn);
            
            newPlusBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('active');
                newPlusBtn.style.transform = dropdown.classList.contains('active') ? 'rotate(45deg)' : 'rotate(0deg)';
            });

            // Close when clicking outside
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target) && !newPlusBtn.contains(e.target)) {
                    dropdown.classList.remove('active');
                    newPlusBtn.style.transform = 'rotate(0deg)';
                }
            });
        };

        if (closeCategoryBtn) {
            closeCategoryBtn.addEventListener('click', () => {
                categoryModal.classList.remove('active');
                toggleMobileBackground(false);
            });
        }
        if (categoryModal) {
            categoryModal.addEventListener('click', (e) => {
                if (e.target === categoryModal) {
                    categoryModal.classList.remove('active');
                    toggleMobileBackground(false);
                }
            });
        }

        // ================= AUTO RELOAD ON VIEW CHANGE =================
        // Reloads page when switching between Mobile, Tablet, and Desktop views
        // to ensure Masonry grids and layout calculations are correct.
        let currentViewMode = getViewMode();

        function getViewMode() {
            const w = window.innerWidth;
            if (w <= 768) return 'mobile';
            if (w <= 1150) return 'tablet';
            return 'desktop';
        }

        let resizeDebounce;
        window.addEventListener('resize', () => {
            clearTimeout(resizeDebounce);
            resizeDebounce = setTimeout(() => {
                const newMode = getViewMode();
                const homeSection = document.getElementById('section-home');
                // Only reload if the view mode changed AND we are currently on the Home section
                if (newMode !== currentViewMode) {
                    if (homeSection && homeSection.style.display !== 'none') {
                        window.location.reload();
                    }
                    currentViewMode = newMode;
                }
            }, 300);
        });

        // Initial Render
        try {
            renderCategoryWidgets();
            
            // Check for pending AI generation (Persistence after Auth)
            if (localStorage.getItem('pending_generated_image')) {
                const genBtn = document.querySelector('.sidebar-nav-btn[data-target="section-generator"]');
                if (genBtn) genBtn.click();
            } 
            else if (window.SERVER_CONFIG.openGenerator) {
                const genBtn = document.querySelector('.sidebar-nav-btn[data-target="section-generator"]');
                if (genBtn) genBtn.click();
            }
            // If we are on page > 1, we are already in the images section
            else if (document.getElementById('section-images').style.display === 'block') {
                loadImagesContent();
            } else {
                loadHomeContent();
            }
            
        } catch (e) {
            console.error("Initialization Error:", e);
            // Fallback to ensure content is visible even if error occurs
            const criticalStyle = document.getElementById('critical-mobile-style');
            if(criticalStyle) criticalStyle.remove();
            document.getElementById('section-images').style.display = 'block';
            loadImagesContent();
        }

        // --- AUTO-OPEN VIEWER FOR SEO LANDING PAGES ---
        // If the server passed a 'view_asset' object, open it immediately
        const serverAsset = window.SERVER_CONFIG ? window.SERVER_CONFIG.viewAsset : null;
        if (serverAsset) {
            // Wait slightly for DOM to be ready
            setTimeout(() => {
                openImageViewer(serverAsset, 0, [serverAsset]);
            }, 500);
        }

        // --- AUTO-OPEN PROFILE FOR SEO LANDING PAGES ---
        const serverProfileUser = window.SERVER_CONFIG ? window.SERVER_CONFIG.viewProfileUser : null;
        if (serverProfileUser) {
            setTimeout(() => {
                openUserProfile(serverProfileUser.id, serverProfileUser.username, serverProfileUser.avatar);
            }, 500);
        }

        // Register Service Worker for Caching
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(reg => {})
                    .catch(err => {});
            });
        }

        // Brand Animation Logic (Transform 'e' to 'E' every minute)
        document.addEventListener('DOMContentLoaded', () => {
            const animE = document.getElementById('animE');
            if (animE) {
                setInterval(() => {
                    animE.classList.add('active');
                    animE.textContent = 'E'; // Transform to Capital E
                    
                    setTimeout(() => {
                        animE.classList.remove('active');
                        animE.textContent = 'e'; // Revert to normal
                    }, 3000); // Lasts for 3 seconds
                }, 60000); // Runs every 60 seconds (1 minute)
            }
        });

 </script>

		
    </body>

</html>
