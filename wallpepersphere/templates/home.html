<!doctype html>
<html lang="{{ current_lang }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title data-i18n="Photo Gallery">
        {% if search_query %}
            {{ search_query|capitalize }} ({{ result_count }}) - {{ t('Photo Gallery') }}
        {% elif view_asset %}
            {{ view_asset.name }} by {{ view_asset.username or 'Artist' }} - wallpepersphere
        {% else %}
            {{ t('Photo Gallery') }}
        {% endif %}
    </title>

    <!-- SEO & Social Media Meta Tags -->
    {% if view_asset %}
    <meta property="og:title" content="{{ view_asset.name }}">
    <meta property="og:description" content="{{ view_asset.description or 'Download high-quality 4K wallpapers and assets.' }}">
    <meta property="og:image" content="{{ r2_domain }}/{{ view_asset.link_medium or view_asset.link_small }}">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    {% else %}
    <meta property="og:title" content="wallpepersphere - Free 4K Wallpapers & Assets">
    <meta property="og:description" content="{{ t('Download free 4K wallpapers and high-quality backgrounds for desktop, iPhone, and Android.') }}">
    <meta property="og:image" content="{{ request.url_root }}static/wallpeperspheredark.jpg">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">
    {% endif %}
    <meta name="description" content="{{ t('Download free 4K wallpapers and high-quality backgrounds for desktop, iPhone, and Android. Explore our curated collection of aesthetic, nature, and abstract images.') }}">

    <!-- Favicon / Website Logo -->
    <link rel="icon" href="/static/wallpeperspherelogo.jpg">
    <link rel="apple-touch-icon" href="/static/wallpeperspheredark.jpg">

    <!-- JSON-LD Structured Data -->
    {% if view_asset %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org/",
      "@type": "ImageObject",
      "contentUrl": "{% if r2_domain %}{{ r2_domain }}/{% else %}{{ request.url_root }}uploads/{% endif %}{{ view_asset.link_original }}",
      "license": "https://creativecommons.org/licenses/by/4.0/",
      "acquireLicensePage": "{{ request.base_url }}",
      "creditText": {{ (view_asset.username or 'Photo Shop User')|tojson }},
      "creator": {
        "@type": "Person",
        "name": {{ (view_asset.username or 'Photo Shop User')|tojson }}
      },
      "copyrightNotice": "Free for personal use",
      "name": {{ view_asset.name|tojson }},
      "description": {{ (view_asset.description or view_asset.name)|tojson }}
    }
    </script>
    {% else %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "wallpepersphere",
      "url": "{{ request.url_root }}",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "{{ request.url_root }}search?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
    </script>
    {% endif %}

    <!-- SEO: Hreflang Tags for Google Indexing -->
    {% for code in supported_languages %}
    <link rel="alternate" hreflang="{{ code }}" href="{{ request.base_url }}?lang={{ code }}" />
    {% endfor %}
    <link rel="alternate" hreflang="x-default" href="{{ request.base_url }}" />

    <link rel="stylesheet" href="/static/home.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* Truncate text in viewer details */
        .description-box p {
            display: flex;
            align-items: center;
            max-width: 100%;
        }
        .description-box p strong {
            flex-shrink: 0;
            margin-right: 5px;
        }
        #viewerTitle, #viewerDescription {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0; /* Required for flexbox truncation */
        }
        @media (max-width: 768px) {
            .welcome-title { font-size: 3.4rem !important; line-height: 3.3 !important; }
            .welcome-text { font-size: 3.3rem !important; line-height: 1.5 !important; }
            .welcome-banner { padding: 25px 15px !important; }
        }
        
    </style>
</head>


<body>
    {% include 'theme_loader.html' %}
    <script>
        // Mobile Optimization: Critical Path
        // Runs immediately to manage section visibility and prevent resource waste
        if ('scrollRestoration' in history) history.scrollRestoration = 'manual';
        (function() {
            if (window.innerWidth <= 768) {
                // Inject critical CSS to hide Home and show Images immediately
                var style = document.createElement('style');
                style.id = 'critical-mobile-style';
                style.innerHTML = '#section-home { display: none !important; } #section-images { display: block !important; }';
                document.head.appendChild(style);
            }
        })();
    </script>
    
    <div class="page-loader"></div>
    <div class="mobile-surface-loader" id="mobileSurfaceLoader">
        <div class="surface-spinner"></div>
    </div>
    <div class="sidebar-overlay"></div>

    <!-- CONNECTION TOAST -->
    <div class="connection-toast" id="connectionToast">
        <div class="connection-icon" id="connectionIcon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>
        </div>
        <span id="connectionText">{{ t('No Internet Connection') }}</span>
        <button class="connection-retry-btn" id="connectionRetryBtn">{{ t('Retry') }}</button>
    </div>
    
    <!-- UPLOAD MODAL CONTAINER -->
    <div id="uploadModal" class="upload-overlay">
        <!-- Content will be injected here via JS -->
    </div>

    <!-- EDITOR MODAL CONTAINER -->
    <div id="editorModal" class="upload-overlay" style="z-index: 10001;">
        <!-- Content will be injected here via JS -->
    </div>

    <!-- IMAGE VIEWER POPUP -->
    <div class="popup-overlay" id="imageViewerModal" tabindex="-1" style="outline: none;">
        <div class="viewer-card">
            
            <div class="exit-btn" id="closeViewerBtn" title="{{ t('Close') }}">✕</div>

            <div class="viewer-left">
                <div class="viewer-header mobile-view" style="position: absolute; top: 20px; left: 20px; z-index: 20; width: auto;">
                    <div class="account-circle">
                        <img src="https://via.placeholder.com/50" alt="Avatar" id="viewerAvatarMobile">
                    </div>
                    <div class="user-info-group">
                        <span class="user-name" id="viewerUsernameMobile">PixelArtist</span>
                        <span class="user-status">{{ t('Pro Member') }}</span>
                    </div>
                </div>
                <button class="similar-btn desktop-view">{{ t('Similar Images') }}</button>
                <img src="" class="main-image" id="viewerImage">
                <p class="quality-text">{{ t('Download image to see best quality') }}</p>
                <div class="expand-btn desktop-view" id="expandViewerBtn"><img src="/static/icons/expand.png" style="width: 20px;"></div>
                <div class="similar-grid" id="similarGrid"></div>
            </div>

            <div class="viewer-right">
                
                <div class="viewer-header desktop-view">
                    <div class="account-circle">
                        <img src="https://via.placeholder.com/50" alt="Avatar" id="viewerAvatar">
                    </div>
                    <div class="user-info-group">
                        <span class="user-name" id="viewerUsername">PixelArtist</span>
                        <span class="user-status">{{ t('Pro Member') }}</span>
                    </div>
                </div>

                <div class="details-container">
                    <div class="description-box">
                        <h3>{{ t('File Information') }}</h3>
                        <p><strong>{{ t('Title') }}:</strong> <span id="viewerTitle">Image</span></p>
                        <p><strong>{{ t('Description') }}:</strong> <span id="viewerDescription"></span></p>
                        <p><strong>{{ t('Quality') }}:</strong> <span id="viewerQuality">Unknown</span></p>
                        <p><strong>{{ t('Resolution') }}:</strong> <span id="viewerRes">Original</span></p>
                        <div style="display: flex; align-items: center; gap: 6px; margin-top: 12px; color: #4caf50; font-size: 0.9rem; font-weight: 500;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            <span>{{ t('License: Free for Personal Use') }}</span>
                        </div>
                    </div>
                    <div class="nav-controls" style="margin-top: 20px; justify-content: center;">
                        <button class="nav-btn" id="prevImageBtn"><img src="/static/icons/back.png" style="width: 24px;"></button>
                        <button class="nav-btn" id="nextImageBtn"><img src="/static/icons/next.png" style="width: 24px;"></button>
                    </div>
                </div>

                <div class="download-wrapper">
                    <button class="btn-download secondary" id="editImageBtn">
                        <span class="material-icons" style="font-size: 20px;">edit</span>
                        <span class="btn-text">{{ t('EDIT IMAGE') }}</span>
                    </button>
                    <button class="btn-download secondary" id="shareImageBtn">
                        <img src="/static/icons/share.png" style="width: 20px; filter: brightness(0) invert(1);" alt="Share">
                        <!-- Icon only -->
                    </button>
                    <button class="btn-download secondary" id="reportImageBtn" title="{{ t('Report Content') }}" data-i18n="Report Content" data-i18n-attr="title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </button>
                    <button class="btn-download secondary mobile-view" id="expandViewerBtnMobile">
                        <img src="/static/icons/expand.png" style="width: 20px; filter: brightness(0) invert(1);">
                    </button>
                    <button class="btn-download" id="downloadImageBtn">
                        <img src="/static/icons/download.png" style="width: 20px;">
                        <span class="btn-text">{{ t('DOWNLOAD') }}</span>
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- NEW ICON/LOGO VIEWER POPUP -->
    <div class="modal-overlay" id="iconViewerModal">
        <div class="asset-viewer-card">
            
            <div class="close-trigger" id="closeIconViewerBtn" title="{{ t('Close') }}">✕</div>

            <div class="viewer-left-col">
                <div class="main-preview-box">
                    <img src="" alt="Main View" id="iconViewerImage">
                    <!-- Moved sub-grid inside main box -->
                    <div class="sub-preview-grid" id="iconViewerSubGrid">
                        <!-- Sub items injected via JS -->
                    </div>
                </div>
            </div>

            <div class="viewer-right-col">
                <div class="header-row">
                    <div class="account-avatar">
                        <img src="https://via.placeholder.com/55" style="width:100%; height:100%; object-fit:cover;" id="iconViewerAvatar">
                    </div>
                    <div class="user-info-text">
                        <span class="user-name-text" id="iconViewerUsername">PixelArtist</span>
                    </div>
                </div>

                <div class="details-box">
                    <p><strong>{{ t('Name') }}:</strong> <span id="iconViewerTitle">Logo</span></p>
                    <p><strong>{{ t('Resolution') }}:</strong> <span id="iconViewerRes">Scalable</span></p>
                </div>

                <div class="nav-controls-under">
                    <button class="nav-btn-icon" id="prevIconBtn"><img src="/static/icons/back.png" style="width: 24px;"></button>
                    <button class="nav-btn-icon" id="nextIconBtn"><img src="/static/icons/next.png" style="width: 24px;"></button>
                </div>

                <div class="download-action-bar" id="iconDownloadBtn">
                    <img src="/static/icons/download.png" style="width: 20px;">
                    {{ t('DOWNLOAD') }}
                </div>

            </div>
        </div>
    </div>

    <!-- CATEGORY MODAL -->
    <div class="category-modal" id="categoryModal">
        <div class="category-content">
            <div class="close-trigger" id="closeCategoryBtn" style="top: 20px; right: 20px;" title="{{ t('Close') }}">✕</div>
            
            <div class="category-scroll">
                <h2 style="margin-top: 0; margin-bottom: 10px; color: #fff;">{{ t('Explore Categories') }}</h2>
                <p style="color: #888; margin-bottom: 20px;">{{ t('Browse through our extensive collection') }}</p>

                <!-- Filter Tools (Resolution & Size) -->
                <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <p class="section-title" style="margin-left: 0; margin-bottom: 10px; opacity: 1; height: auto;">{{ t('Resolution') }}</p>
                            <div class="btn-grid" id="modalResGrid" style="grid-template-columns: repeat(4, 1fr);">
                                <button class="filter-btn" data-value="4K">4K</button>
                                <button class="filter-btn" data-value="HD">HD</button>
                                <button class="filter-btn" data-value="2K">2K</button>
                                <button class="filter-btn" data-value="8K">8K</button>
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <p class="section-title" style="margin-left: 0; margin-bottom: 10px; opacity: 1; height: auto;">{{ t('Size') }}</p>
                            <div class="btn-grid icons" id="modalSizeGrid" style="grid-template-columns: repeat(3, 1fr);">
                                <button class="filter-btn icon-btn" data-value="Horizontal"><img src="/static/icons/horizontal.png" class="sidebar-icon" alt="Horizontal"><span>monitor</span></button>
                                <button class="filter-btn icon-btn" data-value="Vertical"><img src="/static/icons/vertical.png" class="sidebar-icon" alt="Vertical"><span>mobile</span></button>
                                <button class="filter-btn icon-btn" data-value="Square"><img src="/static/icons/stop-square.png" class="sidebar-icon" alt="Square"><span>tablet</span></button>
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <p class="section-title" style="margin-left: 0; margin-bottom: 10px; opacity: 1; height: auto;">{{ t('Sort By') }}</p>
                            <div class="btn-grid" id="modalSortGrid" style="grid-template-columns: repeat(3, 1fr);">
                                <button class="filter-btn selected" data-value="newest">{{ t('Newest') }}</button>
                                <button class="filter-btn" data-value="popular">{{ t('Popular') }}</button>
                                <button class="filter-btn" data-value="downloads">{{ t('Downloads') }}</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="category-grid" id="categoryGrid">
                    <!-- Injected via JS -->
                </div>
            </div>
            
            <div class="category-footer">
                <button class="apply-btn" id="applyFiltersBtn">{{ t('Apply Filters') }}</button>
            </div>
        </div>
    </div>

    <!-- SIGNUP MODAL -->
    <div class="modal-overlay" id="signupModal">
        <div class="auth-card">
            <div class="close-trigger" id="closeSignupBtn" title="{{ t('Close') }}">✕</div>
            <h2 id="authTitle" style="margin-top: 0; margin-bottom: 10px;">{{ t('Create Account') }}</h2>
            <p style="color: #888; margin-bottom: 30px; font-size: 0.95rem;">{{ t('Join our community of creators') }}</p>
            
            <form class="auth-form" id="signupForm">
                <div class="input-group" id="nameInputGroup">
                    <label>{{ t('Full Name') }}</label>
                    <input type="text" placeholder="John Doe" required>
                </div>
                <div class="input-group">
                    <label>{{ t('Email Address') }}</label>
                    <input type="email" placeholder="john@example.com" required>
                </div>
                <div class="input-group">
                    <label>{{ t('Password') }}</label>
                    <input type="password" placeholder="••••••••" required>
                </div>
                <div id="authErrorMessage" style="display: none; color: #ff5f56; font-size: 0.9rem; margin-bottom: 15px; text-align: left;"></div>
                
                <button type="submit" class="auth-btn" id="authSubmitBtn">{{ t('Sign Up') }}</button>
            </form>
            
            <p style="margin-top: 24px; color: #888; font-size: 0.9rem;">
                <span id="authPromptText">{{ t('Already have an account?') }}</span> <a href="#" id="authToggleLink" style="color: var(--primary); text-decoration: none; font-weight: 500;">{{ t('Log In') }}</a>
            </p>
        </div>
    </div>

    <!-- SECURITY ALERT MODAL -->
    <div class="modal-overlay" id="securityModal" style="z-index: 20000;">
        <div class="auth-card" style="border-top: 4px solid #ff4444; text-align: center; max-width: 400px;">
            <div class="close-trigger" id="closeSecurityBtn" title="{{ t('Close') }}">✕</div>
            <div style="width: 70px; height: 70px; background: rgba(255, 68, 68, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#ff4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            </div>
            <h2 style="margin-top: 0; margin-bottom: 10px; color: #ff4444; font-size: 1.5rem;">{{ t('Security Alert') }}</h2>
            <p style="color: #ccc; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.5;" id="securityMessage">
                {{ t('Content flagged.') }}
            </p>
            <a href="https://support.google.com/contributionpolicy" target="_blank" style="color: #ff4444; text-decoration: underline; font-size: 0.9rem; display: block; margin-bottom: 25px; font-weight: 500;">{{ t('Learn more about Safety Policies') }}</a>
            
            <button class="auth-btn" id="ackSecurityBtn" style="background: #2a2a2a; border: 1px solid #444; color: white;">{{ t('I Understand') }}</button>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="settings-overlay" id="settingsModal">
        <!-- Content injected via JS -->
    </div>

    <!-- REPORT MODAL -->
    {% include 'report_modal.html' %}

    <aside class="sidebar">

    <!-- FIXED TOP -->
    <div class="sidebar-fixed top">
        <a href="{% if session.get('user_id') %}/user-library/{{ session.get('user_id') }}{% else %}#{% endif %}" class="sidebar-btn top" id="sidebarProfileBtn">
            {% if session.get('avatar') %}
                <img src="{{ session.get('avatar') if session.get('avatar').startswith('/static/') else '/static/avatars/' + session.get('avatar') }}" alt="User" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
            {% else %}
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: white;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            {% endif %}
            {% if has_unread %}
            <div class="notification-dot"></div>
            {% endif %}
        </a>
    </div>

    <!-- SCROLLABLE CONTENT -->
    <div class="sidebar-scroll">

        <!-- SECTION: RESOLUTION -->
        <div class="sidebar-section">
            <p class="section-title" data-i18n="Resolution">{{ t('Resolution') }}</p>
            <div class="btn-grid" id="sidebarResGrid">
                <button class="filter-btn" data-value="4K">4K</button>
                <button class="filter-btn" data-value="HD">HD</button>
                <button class="filter-btn" data-value="2K">2K</button>
                <button class="filter-btn" data-value="8K">8K</button>
            </div>
        </div>

        <!-- SECTION: CATEGORY -->
        <div class="sidebar-section">
            <p class="section-title" data-i18n="Category">{{ t('Category') }}</p>
            <div class="btn-grid icons">
                <button class="filter-btn icon-btn sidebar-nav-btn" data-target="section-home">
                    <img src="/static/icons/home.png" class="sidebar-icon" alt="Home" data-i18n="Home" data-i18n-attr="alt">
                    <span data-i18n="Home">{{ t('Home') }}</span>
                </button>
                <button class="filter-btn icon-btn sidebar-nav-btn" data-target="section-images">
                    <img src="/static/icons/picture.png" class="sidebar-icon" alt="Images" data-i18n="Images" data-i18n-attr="alt">
                    <span data-i18n="Images">{{ t('Images') }}</span>
                </button>
                <button class="filter-btn icon-btn sidebar-nav-btn" data-target="section-logos">
                    <img src="/static/icons/logo.png" class="sidebar-icon" alt="Logos" data-i18n="Logos" data-i18n-attr="alt">
                    <span data-i18n="Logos">{{ t('Logos') }}</span>
                </button>
            </div>
        </div>

        <!-- SECTION: SIZE -->
        <div class="sidebar-section">
            <p class="section-title" data-i18n="Size">{{ t('Size') }}</p>
            <div class="btn-grid icons" id="sidebarSizeGrid">
                <button class="filter-btn icon-btn" data-value="Horizontal">
                    <img src="/static/icons/horizontal.png" class="sidebar-icon" alt="Horizontal">
                    <span>desktop</span>
                </button>
                <button class="filter-btn icon-btn" data-value="Vertical">
                    <img src="/static/icons/vertical.png" class="sidebar-icon" alt="Vertical" >
                    <span>mobile</span>
                </button>
                <button class="filter-btn icon-btn" data-value="Square">
                    <img src="/static/icons/stop-square.png" class="sidebar-icon" alt="Square">
                    <span>tablet</span>
                </button>
            </div>
        </div>

        <a href="#" class="sidebar-btn filter-trigger">
            <img src="/static/icons/filter.png" class="sidebar-icon" alt="Filter" data-i18n="Filter" data-i18n-attr="alt">
            <span class="sidebar-text" data-i18n="Filter">{{ t('Filter') }}</span>
        </a>

        <a href="#" class="sidebar-btn" id="savedBtn">
            <img src="/static/icons/bookmark.png" class="sidebar-icon" alt="Saved" data-i18n="Saved" data-i18n-attr="alt">
            <span class="sidebar-text" data-i18n="Saved">{{ t('Saved') }}</span>
        </a>

    </div>

    <!-- FIXED BOTTOM -->
    <div class="sidebar-fixed bottom">
        <a href="#" class="sidebar-btn" id="settingsBtn">
            <img src="/static/icons/settings.png" class="sidebar-icon" alt="Settings" data-i18n="Settings" data-i18n-attr="alt">
            <span class="sidebar-text" data-i18n="Settings">{{ t('Settings') }}</span>
        </a>
    </div>

    </aside>

    <aside class="right-sidebar">
        <div class="right-header">
            <h3 style="margin:0; font-size:1.1rem;" data-i18n="Menu">{{ t('Menu') }}</h3>
            <button class="menu-toggle" id="closeRight" style="display:flex; margin:0;" title="{{ t('Close') }}">&times;</button>
        </div>
        <div class="right-content">
            <!-- Language Switcher -->
            <div class="language-selector" style="padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px;">
                <select id="languageSelect" onchange="translationSystem.setLanguage(this.value)" style="width: 100%; padding: 8px; background: #333; color: white; border: 1px solid #444; border-radius: 6px;">
                    <option value="en">English</option>
                    <option value="fr">Français</option>
                    <option value="es">Español</option>
                    <option value="de">Deutsch</option>
                    <option value="pt">Português</option>
                </select>
            </div>

            <a href="#" class="right-link" id="myProfileBtn" data-i18n="My Profile">{{ t('My Profile') }}</a>
            {% if session.get('role') == 'admin' %}
            <a href="/admin" class="right-link" style="color: var(--primary);">{{ t('Admin Dashboard') }}</a>
            {% endif %}
            <a href="#" class="right-link filter-trigger" data-i18n="Filter">{{ t('Filter') }}</a>
            <a href="#" class="right-link settings-trigger" data-i18n="Settings">{{ t('Settings') }}</a>
            <a href="#" class="right-link" onclick="openSettings('support'); return false;" data-i18n="Help & Support">{{ t('Help & Support') }}</a>
        </div>
        <div class="right-footer">
            {% if not session.get('user_id') %}
            <a href="#" class="nav-btn signup-trigger" data-i18n="Join Community">{{ t('Join Community') }}</a>
            <a href="#" class="nav-btn secondary login-trigger" data-i18n="Login">{{ t('Login') }}</a>
            {% else %}
            <a href="/logout" class="nav-btn secondary" data-i18n="Logout">{{ t('Logout') }}</a>
            {% endif %}
        </div>
    </aside>

    <nav class="navbar">
        <button class="menu-toggle" type="button">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <a href="/" class="logo">
            <img src="/static/wallpeperspheredark.jpg" alt="Logo" class="nav-logo-img">
            <span class="brand-text">wallpepersphere</span>
        </a>
        <div class="nav-actions">
            <button class="mobile-search-btn" id="mobileSearchBtn" type="button">
                <img src="/static/icons/search.png" class="sidebar-icon" alt="Search" style="width: 20px; height: 20px;">
            </button>
            <div class="search-wrapper">
                <div class="search-category-wrapper">
                    <button class="search-category-btn" id="searchCatBtn" type="button">
                        <span class="search-category-text">{{ t('All') }}</span> <span class="material-icons" style="font-size: 18px;">arrow_drop_down</span>
                    </button>
                    <div class="search-category-dropdown" id="searchCatDropdown">
                        <!-- Options injected via JS -->
                    </div>
                </div>
                <img src="/static/icons/search.png" class="search-icon" alt="Search">
                <input type="text" class="search-input" placeholder="{{ t('Search images...') }}" data-i18n="Search images..." data-i18n-attr="placeholder">
                <button class="search-action-btn filter-trigger" title="{{ t('Filter') }}" data-i18n="Filter" data-i18n-attr="title">
                    <img src="/static/icons/filter.png" style="width: 20px; filter: brightness(0) invert(1);" alt="Filter">
                </button>
            </div>
            <button class="icon-nav-btn right-menu-btn" id="rightMenuToggle" type="button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
            </button>
            {% if not session.get('user_id') %}
            <a href="#" class="nav-btn signup-trigger" data-i18n="Join">{{ t('Join') }}</a>
            {% else %}
            <button class="nav-btn" id="uploadNavBtn" type="button" style="display:  flex; width: 125px; align-items: center; gap: 8px; cursor: pointer;">
                <img src="/static/icons/upload.png" style="width: 20px; filter: brightness(0) invert(1);" alt="Upload">
                <span data-i18n="Upload">{{ t('Upload') }}</span>
            </button>
            {% endif %}
        </div>
    </nav>

    <div class="nav-tabs-container" id="navTabsContainer">
        <!-- Injected via JS -->
    </div>
    <button class="nav-tab-plus-btn" id="navPlusBtn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>
    <div class="nav-tab-dropdown" id="navTabDropdown"></div>

    <div class="layout-wrapper">
        <main class="main-content">
            <!-- HOME SECTION -->
            <div id="section-home" class="content-section" {% if search_query %}style="display: none;"{% endif %}>
                <!-- Integrated Hero Section -->
                <div class="hero-section">
                    <div class="hero-left">
                        <h1 class="hero-title-box" style="margin: 0 0 15px 0; font-size: 3rem; line-height: 1.2;">{{ t('Free 4K Wallpapers & High Quality Backgrounds') }}</h1>
                        <div class="hero-subtitle-box" style="color: #ffffff;">
                            {{ t('Download the best HD and Ultra HD wallpapers for desktop, mobile, and tablets.') }}<br>
                            {{ t('Explore our curated collection of aesthetic, nature, and abstract images.') }}
                            
                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 20px; color: #4caf50; font-weight: 600; font-size: 1rem;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                <span>{{ t('100% Free for Personal Use') }}</span>
                            </div>
                        </div>
                        <div class="hero-search-wrapper">
                            <img src="/static/icons/search.png" class="hero-search-icon" alt="Search">
                            <input type="text" placeholder="{{ t('Search wallpapers, styles, colors...') }}" data-i18n="Search wallpapers, styles, colors..." data-i18n-attr="placeholder" />
                            <div class="hero-search-actions">
                                <div class="hero-icon-btn filter-trigger" title="{{ t('Filter') }}" data-i18n="Filter" data-i18n-attr="title"><img src="/static/icons/filter.png" style="width: 20px; filter: brightness(0) invert(1);" alt="Filter"></div>
                                <div class="hero-icon-btn" title="{{ t('More options') }}" data-i18n="More options" data-i18n-attr="title" onclick="document.querySelector('.sidebar-nav-btn[data-target=\'section-images\']').click()"><img src="/static/icons/apps.png" style="width: 20px; filter: brightness(0) invert(1);" alt="Options"></div>
                            </div>
                        </div>
                        <div class="hero-logo-section">
                            <div class="hero-logo-grid"></div>
                        </div>
                    </div>
                    <div class="hero-right">
                        <!-- Dynamic Content -->
                    </div>
                </div>

                {% include 'libary section.html' %}

                <div id="dynamic-sections-container">
                    <!-- Dynamic sections will be loaded here via JavaScript -->
                </div>
                <div id="home-feed-container"></div>

                <!-- SEO: Server-Side Rendered Asset Details -->
                <!-- This ensures crawlers see the content immediately without waiting for JS -->
                {% if view_asset %}
                <div class="seo-asset-content" style="position: absolute; left: -9999px; top: -9999px; visibility: hidden;">
                    <h1>{{ view_asset.name }}</h1>
                    <img src="{{ r2_domain }}/{{ view_asset.link_medium }}" alt="{{ view_asset.name }}">
                    <p>{{ view_asset.description }}</p>
                    <ul>
                        <li>Artist: {{ view_asset.username or 'Community' }}</li>
                        <li>Resolution: {{ view_asset.resolution }}</li>
                        <li>License: Free for Personal Use</li>
                        <li>Category: {{ view_asset.category }}</li>
                        <li>Keywords: {{ view_asset.key_word }}</li>
                    </ul>
                    <a href="/download/{{ view_asset.category_type }}/{{ view_asset.id }}">Download {{ view_asset.name }}</a>
                </div>
                {% endif %}
            </div>

            <!-- PROFILE SECTION (Injected Here) -->
            <div id="section-profile" class="content-section" style="display: none;"></div>

            <!-- PUBLIC USER PROFILE SECTION -->
            <div id="section-public-profile" class="content-section" style="display: none;">
                <div class="profile-header-banner" style="padding: 40px 20px; text-align: center; background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)); margin-bottom: 30px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1);">
                    <div class="profile-avatar-large" style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; margin: 0 auto 20px; border: 4px solid #3d85ff; background: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                        <img id="publicProfileAvatar" src="" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <h1 id="publicProfileName" style="color: white; margin: 0 0 10px 0; font-size: 2.2rem; font-weight: 700;">{{ t('User Name') }}</h1>
                    <p id="publicProfileBio" style="color: #aaa; margin: 0 auto 20px; max-width: 600px; line-height: 1.6; font-size: 1rem; display: none;"></p>
                    
                    <div id="publicProfileSocials" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                        <!-- Social Links Injected Here -->
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <a id="publicProfileContactBtn" href="#" class="nav-btn" style="display: none; width: auto; padding: 0 25px; background: white; color: black; font-weight: 600;">{{ t('Contact') }}</a>
                        <button class="nav-btn secondary" onclick="document.getElementById('section-images').style.display='block'; document.getElementById('section-public-profile').style.display='none'; loadImagesContent();" style="display: inline-flex; width: auto; padding: 0 25px;">{{ t('Back to Gallery') }}</button>
                    </div>
                </div>
                <div class="gallery-grid" id="public-profile-grid"></div>
            </div>

            <!-- IMAGES SECTION -->
            <div id="section-images" class="content-section" style="display: none;">
                <div class="welcome-banner">
                    <h1 class="welcome-title">{{ t('Download Free 4K Wallpapers') }}</h1>
                    <p class="welcome-text">
                        {{ t('Browse thousands of high-quality backgrounds for your iPhone, Android, or Desktop.') }}<br>
                        {{ t('Updated daily with the best aesthetic, dark, and nature images.') }}
                    </p>
                    
                    <div class="welcome-search-box">
                        <img src="/static/icons/search.png" class="welcome-search-icon" alt="Search">
                        <input type="text" class="welcome-search-input" placeholder="{{ t('Search for free photos') }}" data-i18n="Search for free photos" data-i18n-attr="placeholder">
                        <button type="button" id="welcomeSearchBtn" class="welcome-search-btn">
                            <img src="/static/icons/search.png" alt="Go">
                        </button>
                    </div>

                    <div class="welcome-license" style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 25px; color: #4caf50; font-size: 0.95rem; font-weight: 500;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        <span>{{ t('All images are free for personal use') }}</span>
                    </div>
                </div>
                <div class="gallery-grid">
                    <!-- Images will be loaded here dynamically -->
                </div>
            </div>

            <!-- LOGOS SECTION -->
            <div id="section-logos" class="content-section" style="display: none;">
                <div class="logo-grid">
                    <!-- Logos will be loaded here dynamically -->
                </div>
            </div>

            <!-- SAVED SECTION -->
            <div id="section-saved" class="content-section" style="display: none;">
                <div class="section-header" style="padding: 0 0 20px 0;">
                    <h2 style="margin: 0; font-size: 1.5rem;">{{ t('Saved Items') }}</h2>
                </div>
                <div class="gallery-grid" id="saved-grid">
                    <!-- Saved items will be loaded here -->
                </div>
                <div class="empty-state" id="saved-empty" style="display: none;">
                    <h2>{{ t('No saved items yet') }}</h2>
                    <p>{{ t('Bookmark items to see them here.') }}</p>
                </div>
            </div>

            <!-- SEARCH SECTION -->
            <div id="section-search" class="content-section" style="{% if search_query %}display: block;{% else %}display: none;{% endif %}">
                <div class="section-header" style="padding: 0 0 20px 0;">
                    <h2 style="margin: 0; font-size: 1.5rem;" id="search-header-title">
                        {% if search_query %}
                            {{ search_query|capitalize }} <span style="color: #888; font-size: 1rem; font-weight: 400; margin-left: 10px;">{{ result_count }} results</span>
                        {% else %}
                            {{ t('Search Results') }}
                        {% endif %}
                    </h2>
                </div>
                <div class="gallery-grid">
                    <!-- Search results will be loaded here -->
                </div>
            </div>

            <!-- SETTINGS SECTION -->
            <div id="section-settings" class="content-section" style="display: none;">
            </div>
        </main>
    </div>


    <script>
        // State flags for lazy loading
        let homeLoaded = false;
        let savedLoaded = false;
        
        // Home Feed State
        let homeFeedState = {
            loading: false,
            queue: [
                { type: 'size', value: 'Vertical', title: 'Mobile Wallpapers', icon: 'vertical.png' },
                { type: 'size', value: 'Horizontal', title: 'Desktop Backgrounds', icon: 'horizontal.png' },
                { type: 'size', value: 'Square', title: 'Social & Tablet', icon: 'stop-square.png' }
            ],
            categoryIndex: 0
        };

        // Pagination State
        let imageState = { offset: 0, loading: false, hasMore: true, loaded: false, limitThreshold: 100 };
        let logoState = { offset: 0, loading: false, hasMore: true, loaded: false };
        let publicProfileState = { offset: 0, loading: false, hasMore: true, loaded: false, currentUserId: null };

        // ================= CONNECTION HANDLING =================
        const connectionToast = document.getElementById('connectionToast');
        const connectionText = document.getElementById('connectionText');
        const connectionRetryBtn = document.getElementById('connectionRetryBtn');
        const connectionIcon = document.getElementById('connectionIcon');
        let isOffline = !navigator.onLine;

        function updateConnectionStatus() {
            if (navigator.onLine) {
                if (isOffline) {
                    connectionText.textContent = "{{ t('Back Online') }}";
                    connectionToast.classList.add('online');
                    connectionIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
                    connectionRetryBtn.style.display = 'none';
                    setTimeout(() => {
                        connectionToast.classList.remove('active');
                        connectionToast.classList.remove('online');
                    }, 3000);
                    
                    // Auto-retry if we were stuck loading
                    const currentSection = document.querySelector('.content-section[style*="block"]');
                    if (currentSection) {
                        if (currentSection.id === 'section-images' && !imageState.loaded) loadGalleryImages();
                        else if (currentSection.id === 'section-logos' && !logoState.loaded) loadLogos();
                    }
                }
                isOffline = false;
            } else { 
                // Went offline
                isOffline = true;
                connectionText.textContent = "{{ t('No Internet Connection') }}";
                connectionIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>';
                connectionToast.classList.remove('online');
                connectionToast.classList.add('active');
                connectionRetryBtn.style.display = 'block';
            }
        }

        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        
        connectionRetryBtn.addEventListener('click', () => {
            if (navigator.onLine) updateConnectionStatus();
            else {
                connectionToast.classList.add('shake');
                setTimeout(() => connectionToast.classList.remove('shake'), 500);
            }
        });

        // --- ENHANCED ERROR HANDLING (SENSITIVE MODE) ---
        function triggerConnectionError(msg) {
            isOffline = true;
            connectionText.textContent = msg || "{{ t('Connection Failed') }}";
            connectionIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>';
            connectionToast.classList.remove('online');
            connectionToast.classList.add('active');
            connectionRetryBtn.style.display = 'block';
        }

        const originalFetch = window.fetch;
        window.fetch = function(input, init) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const url = typeof input === 'string' ? input : input.url;
                init = init || {};
                
                xhr.open(init.method || 'GET', url, true);
                
                if (init.headers) {
                    if (init.headers instanceof Headers) {
                        init.headers.forEach((val, key) => xhr.setRequestHeader(key, val));
                    } else {
                        Object.entries(init.headers).forEach(([key, val]) => xhr.setRequestHeader(key, val));
                    }
                }

                xhr.onload = () => {
                    const headers = new Headers();
                    const headerStr = xhr.getAllResponseHeaders();
                    if (headerStr) {
                        headerStr.trim().split(/[\r\n]+/).forEach(line => {
                            const parts = line.split(': ');
                            const key = parts.shift();
                            const val = parts.join(': ');
                            if (key) headers.append(key, val);
                        });
                    }
                    
                    const response = new Response(xhr.response, {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        headers: headers
                    });
                    
                    if (!response.ok && response.status >= 500) triggerConnectionError("{{ t('Server Error') }}");
                    resolve(response);
                };

                xhr.onerror = () => {
                    triggerConnectionError("{{ t('Network Error') }}");
                    reject(new TypeError("Network request failed"));
                };

                if (init.signal) {
                    init.signal.addEventListener('abort', () => {
                        xhr.abort();
                        reject(new DOMException('Aborted', 'AbortError'));
                    });
                }

                xhr.send(init.body || null);
            });
        };

        // --- ERROR CARD HELPER ---
        function createErrorCard(container, message, retryFn) {
            // Avoid duplicates in the same container
            if (container.querySelector('.error-state-card')) return;

            const card = document.createElement('div');
            card.className = 'error-state-card';
            card.innerHTML = `
                <div class="error-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>
                </div>
                <h3>{{ t('Connection Failed') }}</h3>
                <p>${message || "{{ t('We could not load the content. Please check your internet connection.') }}"}</p>
            `;
            
            const btn = document.createElement('button');
            btn.className = 'retry-btn';
            btn.textContent = "{{ t('Try Again') }}";
            btn.onclick = () => {
                card.remove();
                if (retryFn) retryFn();
            };
            
            card.appendChild(btn);
            container.appendChild(card);
        }

        // --- MOBILE PERFORMANCE HELPER ---
        let lastScrollPosition = 0;
        function toggleMobileBackground(show) {
            if (window.innerWidth > 768) return;
            
            const body = document.body;
            if (show) {
                lastScrollPosition = window.scrollY;
                body.classList.add('mobile-modal-open');
            } else {
                body.classList.remove('mobile-modal-open');
                // Small timeout to allow DOM to reappear before scrolling
                setTimeout(() => {
                    window.scrollTo(0, lastScrollPosition);
                }, 50);
            }
        }

        // Execute immediately to show skeletons ASAP on mobile
        if (window.innerWidth <= 768) {
            const homeSec = document.getElementById('section-home');
            const imgSec = document.getElementById('section-images');
            if (homeSec) homeSec.style.display = 'none';
            if (imgSec) imgSec.style.display = 'block';
            
            // Remove critical style now that JS has taken over to allow section switching
            const criticalStyle = document.getElementById('critical-mobile-style');
            if(criticalStyle) criticalStyle.remove();
            
            loadImagesContent();
        }

        const CATEGORIES_DB = {
            "en": ["Abstract", "Aesthetic", "AI Art", "Airplanes", "Animals", "Anime", "Architecture", "Art", "Astronomy", "Backgrounds", "Beach", "Biology", "Business", "Cars", "Cartoons", "Celebrities", "City", "Cityscape", "Clouds", "Computers", "Concept Art", "Creative", "Cyberpunk", "Dark", "Design", "Digital Art", "Education", "Fantasy", "Fashion", "Film", "Flowers", "Food", "Forest", "Futuristic", "Gaming", "Geometric", "Gradients", "Graphics", "Health", "Holidays", "Home", "Icons", "Illustrations", "Industrial", "Interiors", "Landscape Photography", "Landscapes", "Lifestyle", "Love", "Macro", "Minimal", "Mountains", "Music", "Nature", "Neon", "Night", "Ocean", "Patterns", "People", "Pets", "Photography", "Portraits", "Quotes", "Retro", "Robotics", "Sci-Fi", "Seasons", "Sky", "Social Media", "Space", "Sports", "Street", "Street Photography", "Surreal", "Technology", "Textures", "Time-lapse", "Travel", "Typography", "Underwater", "Urban", "Vector", "Vehicles", "Vintage", "Water", "Waterfalls", "Weather", "Wildlife", "Winter", "Woods", "Zen"],
            "fr": ["Abstrait", "Esthétique", "Art IA", "Avions", "Animaux", "Anime", "Architecture", "Art", "Astronomie", "Arrière-plans", "Plage", "Biologie", "Affaires", "Voitures", "Dessins animés", "Célébrités", "Ville", "Paysage urbain", "Nuages", "Ordinateurs", "Art conceptuel", "Créatif", "Cyberpunk", "Sombre", "Design", "Art numérique", "Éducation", "Fantaisie", "Mode", "Film", "Fleurs", "Nourriture", "Forêt", "Futuriste", "Jeu vidéo", "Géométrique", "Dégradés", "Graphisme", "Santé", "Vacances", "Maison", "Icônes", "Illustrations", "Industriel", "Intérieurs", "Photographie de paysage", "Paysages", "Style de vie", "Amour", "Macro", "Minimaliste", "Montagnes", "Musique", "Nature", "Néons", "Nuit", "Océan", "Motifs", "Gens", "Animaux de compagnie", "Photographie", "Portraits", "Citations", "Rétro", "Robotique", "Science-fiction", "Saisons", "Ciel", "Réseaux sociaux", "Espace", "Sports", "Rue", "Photographie de rue", "Surréaliste", "Technologie", "Textures", "Time-lapse", "Voyage", "Typographie", "Sous-marin", "Urbain", "Vecteur", "Véhicules", "Vintage", "Eau", "Cascades", "Météo", "Faune", "Hiver", "Bois", "Zen"],
            "es": ["Abstracto", "Estético", "Arte IA", "Aviones", "Animales", "Anime", "Arquitectura", "Arte", "Astronomía", "Fondos", "Playa", "Biología", "Negocios", "Coches", "Dibujos animados", "Celebridades", "Ciudad", "Paisaje urbano", "Nubes", "Ordenadores", "Arte conceptual", "Creativo", "Cyberpunk", "Oscuro", "Diseño", "Arte digital", "Educación", "Fantasía", "Moda", "Cine", "Flores", "Comida", "Bosque", "Futurista", "Gaming", "Geométrico", "Degradados", "Gráficos", "Salud", "Vacaciones", "Hogar", "Iconos", "Ilustraciones", "Industrial", "Interiores", "Fotografía de paisaje", "Paisajes", "Estilo de vida", "Amor", "Macro", "Minimalista", "Montañas", "Música", "Naturaleza", "Neón", "Noche", "Océano", "Patrones", "Gente", "Mascotas", "Fotografía", "Retratos", "Citas", "Retro", "Robótica", "Ciencia ficción", "Estaciones", "Cielo", "Redes sociales", "Espacio", "Deportes", "Calle", "Fotografía callejera", "Surrealista", "Tecnología", "Texturas", "Time-lapse", "Viajes", "Tipografía", "Submarino", "Urbano", "Vector", "Vehículos", "Vintage", "Agua", "Cascadas", "Clima", "Vida silvestre", "Invierno", "Bosque", "Zen"],
            "de": ["Abstrakt", "Ästhetisch", "KI-Kunst", "Flugzeuge", "Tiere", "Anime", "Architektur", "Kunst", "Astronomie", "Hintergründe", "Strand", "Biologie", "Geschäft", "Autos", "Cartoons", "Prominente", "Stadt", "Stadtbild", "Wolken", "Computer", "Konzeptkunst", "Kreativ", "Cyberpunk", "Dunkel", "Design", "Digitale Kunst", "Bildung", "Fantasie", "Mode", "Film", "Blumen", "Essen", "Wald", "Futuristisch", "Gaming", "Geometrisch", "Farbverläufe", "Grafiken", "Gesundheit", "Feiertage", "Zuhause", "Symbole", "Illustrationen", "Industriell", "Innenräume", "Landschaftsfotografie", "Landschaften", "Lebensstil", "Liebe", "Makro", "Minimal", "Berge", "Musik", "Natur", "Neon", "Nacht", "Ozean", "Muster", "Menschen", "Haustiere", "Fotografie", "Porträts", "Zitate", "Retro", "Robotik", "Sci-Fi", "Jahreszeiten", "Himmel", "Soziale Medien", "Weltraum", "Sport", "Straße", "Straßenfotografie", "Surreal", "Technologie", "Texturen", "Zeitraffer", "Reisen", "Typografie", "Unterwasser", "Urban", "Vektor", "Fahrzeuge", "Vintage", "Wasser", "Wasserfälle", "Wetter", "Tierwelt", "Winter", "Wald", "Zen"],
            "pt": ["Abstrato", "Estético", "Arte IA", "Aviões", "Animais", "Anime", "Arquitetura", "Arte", "Astronomia", "Planos de Fundo", "Praia", "Biologia", "Negócios", "Carros", "Desenhos", "Celebridades", "Cidade", "Paisagem Urbana", "Nuvens", "Computadores", "Arte Conceitual", "Criativo", "Cyberpunk", "Escuro", "Design", "Arte Digital", "Educação", "Fantasia", "Moda", "Filme", "Flores", "Comida", "Floresta", "Futurista", "Jogos", "Geométrico", "Degradês", "Gráficos", "Saúde", "Feriados", "Casa", "Ícones", "Ilustrações", "Industrial", "Interiores", "Fotografia de Paisagem", "Paisagens", "Estilo de Vida", "Amor", "Macro", "Minimalista", "Montanhas", "Música", "Natureza", "Neon", "Noite", "Oceano", "Padrões", "Pessoas", "Animais de Estimação", "Fotografia", "Retratos", "Citações", "Retrô", "Robótica", "Ficção Científica", "Estações", "Céu", "Redes Sociais", "Espaço", "Esportes", "Rua", "Fotografia de Rua", "Surreal", "Tecnologia", "Texturas", "Time-lapse", "Viagem", "Tipografia", "Subaquático", "Urbano", "Vetor", "Veículos", "Vintage", "Água", "Cachoeiras", "Clima", "Vida Selvagem", "Inverno", "Bosque", "Zen"]
        };

        let categoriesList = CATEGORIES_DB['en'];

        // Function to re-render all category-dependent UI elements
        function renderCategoryWidgets() {
            // 1. Re-init Search Dropdown
            initSearchDropdown();
            
            // 2. Re-init Nav Tabs
            initNavTabs();
            
            // 3. Clear Category Modal Grid so it regenerates with new language on next open
            const grid = document.getElementById('categoryGrid');
            if(grid) grid.innerHTML = '';
        }

        let selectedRes = null;
        let selectedSize = null;
        let selectedCat = null;
        let selectedSort = 'newest';

        function initSearchDropdown() {
            const searchCatBtn = document.getElementById('searchCatBtn');
            const searchCatDropdown = document.getElementById('searchCatDropdown');

            if(searchCatBtn && searchCatDropdown) {
                // Generate Options: Wallpaper, 4K Images, + 4 Random
                const fixedOptions = ['Wallpaper', '4K Images'];
                const randomPool = categoriesList.filter(c => !fixedOptions.includes(c));
                const randomOptions = [];
                for(let i=0; i<4; i++) {
                    if(randomPool.length === 0) break;
                    const randomIndex = Math.floor(Math.random() * randomPool.length);
                    randomOptions.push(randomPool[randomIndex]);
                    randomPool.splice(randomIndex, 1);
                }
                const dropdownOptions = [...fixedOptions, ...randomOptions];

                // Clear and Populate
                searchCatDropdown.innerHTML = '';
                dropdownOptions.forEach(opt => {
                    const div = document.createElement('div');
                    div.className = 'cat-option';
                    div.textContent = opt;
                    div.addEventListener('click', () => {
                        const searchInput = document.querySelector('.search-input');
                        if(searchInput) {
                            searchInput.value = opt;
                            selectedCat = null;
                            updateFilterActiveState();
                            window.performSearch();
                        }
                        searchCatDropdown.classList.remove('active');
                    });
                    searchCatDropdown.appendChild(div);
                });

                if (searchCatBtn.dataset.hasListener) return;
                searchCatBtn.dataset.hasListener = 'true';

                searchCatBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    searchCatDropdown.classList.toggle('active');
                });

                document.addEventListener('click', (e) => {
                    if (!searchCatBtn.contains(e.target) && !searchCatDropdown.contains(e.target)) {
                        searchCatDropdown.classList.remove('active');
                    }
                });
            }
        }
            

        document.addEventListener('DOMContentLoaded', () => {
            // --- SEARCH LOGIC ---
            const searchInput = document.querySelector('.search-input');
            
            // Check for server-side search query
            const serverQuery = {{ search_query|default(None)|tojson }};
            if (serverQuery && searchInput) {
                searchInput.value = serverQuery;
                // Trigger search to load grid (client-side fetch)
                setTimeout(() => {
                    if (typeof window.performSearch === 'function') window.performSearch();
                }, 100);
            }

            const heroSearchInput = document.querySelector('.hero-search-wrapper input');

            if (heroSearchInput) {
                heroSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (searchInput) {
                            searchInput.value = heroSearchInput.value;
                            window.performSearch();
                        }
                    }
                });
                heroSearchInput.addEventListener('input', (e) => {
                    if (searchInput) searchInput.value = e.target.value;
                });
            }
            
            const welcomeSearchInput = document.querySelector('.welcome-search-input');
            if (welcomeSearchInput) {
                welcomeSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (searchInput) {
                            searchInput.value = welcomeSearchInput.value;
                            window.performSearch();
                        }
                    }
                });
            }

            const welcomeSearchBtn = document.getElementById('welcomeSearchBtn');
            if (welcomeSearchBtn && welcomeSearchInput) {
                welcomeSearchBtn.addEventListener('click', () => {
                    if (searchInput) {
                        searchInput.value = welcomeSearchInput.value;
                        window.performSearch();
                    }
                });
            }

            // Helper: Levenshtein Distance for fuzzy matching (Orthography)
            function getLevenshteinDistance(a, b) {
                if (a.length === 0) return b.length;
                if (b.length === 0) return a.length;
                const matrix = [];
                for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
                for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
                for (let i = 1; i <= b.length; i++) {
                    for (let j = 1; j <= a.length; j++) {
                        if (b.charAt(i - 1) === a.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1));
                        }
                    }
                }
                return matrix[b.length][a.length];
            }

            function findClosestMatch(word, options) {
                let bestMatch = null;
                let minDistance = Infinity;
                // Allow 1 typo for short words, 2 for longer
                const threshold = word.length > 4 ? 2 : 1; 
                
                options.forEach(opt => {
                    const dist = getLevenshteinDistance(word.toLowerCase(), opt.toLowerCase());
                    if (dist < minDistance && dist <= threshold) {
                        minDistance = dist;
                        bestMatch = opt;
                    }
                });
                return bestMatch;
            }

            // Helper: Get English Category for API
            function getEnglishCategory(term) {
                if (!term) return '';
                const lang = translationSystem.currentLang;
                if (CATEGORIES_DB[lang]) {
                    const index = CATEGORIES_DB[lang].indexOf(term);
                    if (index !== -1 && CATEGORIES_DB['en'][index]) {
                        return CATEGORIES_DB['en'][index];
                    }
                }
                return term;
            }

            // Helper for image URL logic (PC = Medium, Mobile = Small)
            window.getGridImageUrl = function(asset) {
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    return `/uploads/${asset.link_small}`;
                } else {
                    return asset.link_medium ? `/uploads/${asset.link_medium}` : `/uploads/${asset.link_small}`;
                }
            };

            window.performSearch = function() {
                if (!searchInput) return;
                let rawQuery = searchInput.value.trim();
                
                // Mobile Optimization: Dismiss keyboard and scroll to top for immediate view
                if(searchInput) searchInput.blur();
                window.scrollTo(0, 0);
                
                // Define known filters
                const knownResolutions = ['4K', '8K', '2K', 'HD', 'FHD'];
                const knownSizes = ['Vertical', 'Horizontal', 'Square'];
                
                let detectedRes = selectedRes;
                let detectedSize = selectedSize;
                let detectedCat = selectedCat;
                
                // Logic Parsing & Orthography Correction
                if (rawQuery) {
                    const words = rawQuery.split(/\s+/);
                    const remainingWords = [];
                    
                    words.forEach(word => {
                        let handled = false;
                        
                        /* Auto-detection disabled to allow normal search behavior
                        // 1. Check Resolution
                        let resMatch = findClosestMatch(word, knownResolutions);
                        if (resMatch) {
                            detectedRes = resMatch;
                            handled = true;
                        }
                        
                        // 2. Check Size
                        if (!handled) {
                            let sizeMatch = findClosestMatch(word, knownSizes);
                            if (sizeMatch) {
                                detectedSize = sizeMatch;
                                handled = true;
                            }
                        }
                        
                        // 3. Check Category (if not manually set)
                        // We use the global categoriesList defined in this file
                        if (!handled && !detectedCat && typeof categoriesList !== 'undefined') {
                            let catMatch = findClosestMatch(word, categoriesList);
                            if (catMatch) {
                                detectedCat = catMatch;
                                handled = true;
                            }
                        }
                        */
                        
                        if (!handled) {
                            remainingWords.push(word);
                        }
                    });
                    
                    rawQuery = remainingWords.join(' ');
                }
                
                // Build Query Params
                const params = new URLSearchParams();
                if(rawQuery) params.append('q', rawQuery);
                if(detectedCat) params.append('category', getEnglishCategory(detectedCat));
                if(detectedRes) params.append('resolution', detectedRes);
                if(detectedSize) params.append('size', detectedSize);
                if(selectedSort) params.append('sort', selectedSort);
                
                // Switch to search section to show results
                document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
                const searchSection = document.getElementById('section-search');
                searchSection.style.display = 'block';
                
                const grid = searchSection.querySelector('.gallery-grid');
                grid.innerHTML = ''; // Clear current content
                grid.classList.remove('masonry-active');
                
                // Show loader
                grid.innerHTML = `
                    <div style="width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 0;">
                        <div class="surface-spinner" style="position: relative; width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                        <p style="margin-top: 15px; color: var(--text-secondary); font-size: 1rem; font-weight: 500;">{{ t('Searching...') }}</p>
                    </div>
                `;
                
                fetch(`/api/search?${params.toString()}`)
                    .then(r => r.json())
                    .then(data => {
                        grid.innerHTML = ''; // Clear loader
                        
                        if(data.success) {
                            // Update Search Header with query and count
                            const searchHeader = document.getElementById('search-header-title');
                            if (searchHeader) {
                                let displayTitle = rawQuery || detectedCat || "{{ t('Search Results') }}";
                                displayTitle = displayTitle.charAt(0).toUpperCase() + displayTitle.slice(1);
                                
                                searchHeader.innerHTML = ''; 
                                searchHeader.appendChild(document.createTextNode(displayTitle));
                                
                                const countSpan = document.createElement('span');
                                countSpan.style.cssText = "color: #888; font-size: 1rem; font-weight: 400; margin-left: 10px;";
                                countSpan.textContent = `${data.assets.length} results`;
                                searchHeader.appendChild(countSpan);

                                // Check for random results
                                const allRandom = data.assets.length > 0 && data.assets.every(a => a.is_random);
                                if (allRandom) {
                                     const suggestionSpan = document.createElement('div');
                                     suggestionSpan.style.fontSize = "1rem";
                                     suggestionSpan.style.color = "var(--primary)";
                                     suggestionSpan.style.marginTop = "5px";
                                     suggestionSpan.textContent = "{{ t('No exact matches found. Suggested for you:') }}";
                                     searchHeader.appendChild(suggestionSpan);
                                }
                            }

                            if(data.assets.length === 0) {
                                grid.innerHTML = '<div class="empty-state"><h2>{{ t("No results found") }}</h2><p>{{ t("Try different keywords or filters.") }}</p></div>';
                                return;
                            }
                            
                            setupMasonryGrid(grid);
                            
                            // Reuse the existing rendering logic by setting the global galleryImages
                            galleryImages = data.assets;
                            
                            // Instant Load Logic (Parallel)
                            data.assets.forEach((asset, index) => {
                                const smallUrl = window.getGridImageUrl(asset);
                                const arStyle = typeof getAspectRatioStyle === 'function' ? getAspectRatioStyle(asset.resolution) : '';

                                // Random Badge
                                const randomBadge = asset.is_random ? `<div style="position:absolute; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.6); color:#fff; padding:4px 10px; border-radius:12px; font-size:0.7rem; backdrop-filter:blur(4px); border:1px solid rgba(255,255,255,0.2); z-index:5;">{{ t('Suggested') }}</div>` : '';

                                const card = document.createElement('div');
                                card.className = asset.category_type === 'logo' ? 'image-card logo-card fade-in' : 'image-card fade-in';
                                
                                card.innerHTML = `
                                    ${randomBadge}
                                    <div class="card-img-wrapper" style="${arStyle}">
                                        <img src="${smallUrl}" alt="${asset.name}" style="width: 100%; height: auto; display: block;">
                                    </div>
                                    <button class="card-action-btn like-btn top-left ${asset.is_liked ? 'active' : ''}" data-id="${asset.id}" data-category="${asset.category_type}" onclick="event.stopPropagation(); toggleLike(this)">
                                    </button>
                                    <button class="card-action-btn save-btn top-right ${asset.is_saved ? 'active' : ''}" data-id="${asset.id}" data-category="${asset.category_type}" onclick="event.stopPropagation(); toggleSave(this)">
                                    </button>
                                    <div class="card-overlay">
                                        <h3 class="card-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">${asset.name || 'Untitled'}</h3>
                                        <p style="font-size: 0.8rem; color: #ddd; margin: 4px 0 0; font-weight: 400;">${asset.category || ''}</p>
                                        <div class="card-actions">
                                        <div class="download-icon-btn" onclick="event.stopPropagation(); window.location.href='/download/${asset.category_type || 'image'}/${asset.id}'">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mobile-card-footer">
                                        <div class="mobile-user-info">
                                            <img src="${asset.avatar ? (asset.avatar.startsWith('/static/') ? asset.avatar : '/static/avatars/' + asset.avatar) : 'https://via.placeholder.com/32'}" class="mobile-avatar" alt="User">
                                            <span class="mobile-username">${asset.username || 'User'}</span>
                                        </div>
                                        <span style="font-size: 0.75rem; color: #888;">${asset.resolution || ''}</span>
                                    <button class="mobile-download-btn" onclick="event.stopPropagation(); window.location.href='/download/${asset.category_type || 'image'}/${asset.id}'">
                                            <img src="/static/icons/download.png" style="width: 16px;">
                                        </button>
                                    </div>
                                `;
                                
                                // Distribute to shortest column based on HEIGHT
                                const cols = grid.querySelectorAll('.gallery-col');
                                if (cols.length > 0) {
                                    let target = cols[0];
                                    cols.forEach(col => {
                                        if (col.offsetHeight < target.offsetHeight) target = col;
                                    });
                                    target.appendChild(card);
                                } else {
                                    grid.appendChild(card);
                                }
                                
                                card.addEventListener('click', () => {
                                    if(asset.category_type === 'logo') openIconViewer(asset, index, data.assets);
                                    else openImageViewer(asset, index, data.assets);
                                });
                            });
                        }
                    })
                    .catch(err => {
                        grid.innerHTML = '';
                        console.error(err);
                        if (!navigator.onLine) updateConnectionStatus();
                        createErrorCard(grid, "{{ t('Search failed. Please check your connection.') }}", () => window.performSearch());
                    });
            };

            if(searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if(e.key === 'Enter') window.performSearch();
                });
            }

            // --- INFINITE SCROLL LISTENER ---
            window.addEventListener('scroll', () => {
                // Check if near bottom (within 300px)
                const scrollHeight = document.documentElement.scrollHeight;
                const scrollTop = window.scrollY || document.documentElement.scrollTop;
                const clientHeight = document.documentElement.clientHeight;

                if (scrollTop + clientHeight >= scrollHeight - 400) {
                    const imagesSection = document.getElementById('section-images');
                    const logosSection = document.getElementById('section-logos');
                    const publicProfileSection = document.getElementById('section-public-profile');
                    const homeSection = document.getElementById('section-home');
                    
                    if (homeSection && homeSection.style.display !== 'none') {
                        loadNextHomeFeedSection();
                    }
                    
                    if (imagesSection.style.display !== 'none') {
                        if (imageState.offset < imageState.limitThreshold) loadGalleryImages();
                    } else if (logosSection.style.display !== 'none') {
                        loadLogos();
                    } else if (publicProfileSection && publicProfileSection.style.display !== 'none') {
                        loadPublicProfileImages();
                    }
                }
            });
        });

        function createLoadMoreButton(container, onClick) {
            if (document.getElementById('galleryLoadMoreBtn')) return;
            
            const btnWrapper = document.createElement('div');
            btnWrapper.id = 'galleryLoadMoreWrapper';
            btnWrapper.style.width = '100%';
            btnWrapper.style.display = 'flex';
            btnWrapper.style.justifyContent = 'center';
            btnWrapper.style.padding = '30px 0 50px';
            btnWrapper.style.clear = 'both';
            
            const btn = document.createElement('button');
            btn.id = 'galleryLoadMoreBtn';
            btn.textContent = "{{ t('Next') }}";
            btn.style.background = 'var(--primary)';
            btn.style.color = '#fff';
            btn.style.border = 'none';
            btn.style.padding = '12px 40px';
            btn.style.borderRadius = '30px';
            btn.style.fontSize = '1rem';
            btn.style.fontWeight = '600';
            btn.style.cursor = 'pointer';
            btn.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
            
            btn.onclick = () => {
                btnWrapper.remove();
                onClick();
            };
            
            btnWrapper.appendChild(btn);
            container.appendChild(btnWrapper);
        }

        function loadImagesContent() {
            if (imageState.loaded) return;
            imageState.loaded = true;
            loadGalleryImages();
        }

        function loadLogosContent() {
            if (logoState.loaded) return;
            logoState.loaded = true;
            loadLogos();
        }

        function loadHomeContent() {
            if (homeLoaded) return;
            homeLoaded = true;
            
            loadHeroImages();
            loadHeroLogos();

            const sectionsContainer = document.getElementById('dynamic-sections-container');
            if (!sectionsContainer) return;

            fetch('/home-sections')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.sections) {
                        sectionsContainer.innerHTML = ''; // Clear container
                        let combinedHTML = '';
                        data.sections.forEach(section => {
                            combinedHTML += section.html;
                        });
                        sectionsContainer.innerHTML = combinedHTML;

                        // Execute scripts found in the injected HTML
                        sectionsContainer.querySelectorAll('script').forEach(oldScript => {
                            const newScript = document.createElement('script');
                            Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });

                        // Load random images into the featured section
                        loadFeaturedImages();
                        
                        // Start Home Feed
                        loadNextHomeFeedSection();
                    } else {
                        console.error('Failed to load home page sections:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching home page sections:', error);
                    if (!navigator.onLine) updateConnectionStatus();
                    createErrorCard(sectionsContainer, "{{ t('Failed to load home sections.') }}", () => loadHomeContent());
                });
        }

        function calculateHomeFeedLimit(gridElement) {
            const colWidth = 280; 
            const gap = 24;
            const containerWidth = gridElement.clientWidth || (window.innerWidth - 40);
            let cols = Math.floor((containerWidth + gap) / (colWidth + gap));
            if (cols < 1) cols = 1;
            if (window.innerWidth <= 768) cols = 1; 
            
            return cols * 4; // 4 lines
        }

        function loadNextHomeFeedSection() {
            if (homeFeedState.loading) return;
            
            const container = document.getElementById('home-feed-container');
            if (!container) return;

            // Determine next section config
            let config = null;
            if (homeFeedState.queue.length > 0) {
                config = homeFeedState.queue.shift();
            } else {
                // Generate from categoriesList
                if (typeof categoriesList !== 'undefined' && homeFeedState.categoryIndex < categoriesList.length) {
                    // Shuffle categories on first run if index is 0
                    if (homeFeedState.categoryIndex === 0) {
                        categoriesList.sort(() => 0.5 - Math.random());
                    }
                    const cat = categoriesList[homeFeedState.categoryIndex];
                    config = { type: 'category', value: cat, title: cat, icon: 'picture.png' };
                    homeFeedState.categoryIndex++;
                } else {
                    return; // No more content
                }
            }

            homeFeedState.loading = true;

            // Create Section Structure
            const section = document.createElement('div');
            section.className = 'home-feed-section fade-in';
            section.style.marginBottom = '40px';
            
            // Header
            const header = document.createElement('div');
            header.className = 'feed-header';
            header.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 0 20px 20px; margin-top: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px;';
            
            const iconUrl = `/static/icons/${config.icon}`;
            header.innerHTML = `
                <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <img src="${iconUrl}" style="width: 20px; height: 20px; filter: brightness(0) invert(1);">
                </div>
                <h2 style="margin: 0; font-size: 1.4rem; font-weight: 700; color: var(--text-primary);">${config.title}</h2>
            `;
            section.appendChild(header);

            // Grid
            const grid = document.createElement('div');
            grid.className = 'gallery-grid';
            section.appendChild(grid);
            container.appendChild(section);

            // Calculate Limit (4 lines)
            const limit = calculateHomeFeedLimit(grid);
            
            // Setup Masonry
            setupMasonryGrid(grid);
            
            // Skeletons
            const skeletons = createSkeletons(grid, limit, 'image');

            // Build API URL
            let url = `/api/search?limit=${limit}`;
            if (config.type === 'size') url += `&size=${config.value}`;
            else if (config.type === 'category') url += `&category=${encodeURIComponent(config.value)}&sort=random`;

            fetch(url)
                .then(r => r.json())
                .then(data => {
                    homeFeedState.loading = false;
                    
                    if (data.success && data.assets.length > 0) {
                        data.assets.forEach((asset, index) => {
                            // Reuse card creation logic
                            const smallUrl = window.getGridImageUrl(asset);
                            const arStyle = typeof getAspectRatioStyle === 'function' ? getAspectRatioStyle(asset.resolution) : '';

                            const card = document.createElement('div');
                            card.className = 'image-card fade-in';
                            card.innerHTML = `<div class="card-img-wrapper" style="${arStyle}"><img src="${smallUrl}" alt="${asset.name}" style="width: 100%; height: auto; display: block;"></div><div class="card-overlay"><h3 class="card-title">${asset.name || 'Image'}</h3></div>`;
                            
                            // Masonry append logic
                            const cols = grid.querySelectorAll('.gallery-col');
                            if (cols.length > 0) {
                                let target = cols[0];
                                cols.forEach(col => { if (col.offsetHeight < target.offsetHeight) target = col; });
                                target.appendChild(card);
                            } else {
                                grid.appendChild(card);
                            }
                            
                            card.addEventListener('click', () => {
                                if(typeof openImageViewer === 'function') openImageViewer(asset, index, data.assets);
                            });
                        });
                    } else {
                        section.remove();
                        loadNextHomeFeedSection(); // Try next if empty
                    }
                })
                .catch(e => {
                    console.error(e);
                    homeFeedState.loading = false;
                    section.remove();
                });
        }

        function getDynamicLimit() {
            // Flexible logic: Calculate items needed to cover the viewport + buffer
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            let columns = 1;
            let avgHeight = 300;

            if (viewportWidth <= 768) {
                // Mobile: 1 Column, height depends on width
                columns = 1;
                avgHeight = viewportWidth * 0.8; 
            } else {
                // Desktop: Masonry (approx 304px per item including gap)
                // Sidebar (64px) + Padding (~48px)
                const availableWidth = viewportWidth - 112; 
                columns = Math.floor(availableWidth / 304); 
                if (columns < 1) columns = 1;
                avgHeight = 280; // Average height of masonry items
            }

            // Calculate items to fill one screen
            const itemsPerScreen = Math.ceil((viewportHeight / avgHeight) * columns);
            
            // Request 2 screens worth of content to ensure smooth scrolling
            return Math.max(columns, itemsPerScreen * 2);
        }

        // --- MASONRY SETUP ---
        function setupMasonryGrid(grid) {
            if (grid.classList.contains('masonry-active')) return;
            
            // Calculate columns based on width (approx 280px per col + gap)
            const colWidth = 280;
            const gap = 24;
            let numCols = Math.floor((grid.clientWidth + gap) / (colWidth + gap));
            if (numCols < 1) numCols = 1;
            if (window.innerWidth <= 768) numCols = 2; // Force 2 cols on mobile

            for (let i = 0; i < numCols; i++) {
                const col = document.createElement('div');
                col.className = 'gallery-col';
                grid.appendChild(col);
            }
            grid.classList.add('masonry-active');
        }

        // --- ASPECT RATIO HELPER ---
        function getAspectRatioStyle(resolution) {
            if (!resolution) return '';
            const parts = resolution.toLowerCase().split('x');
            if (parts.length === 2) {
                const w = parseFloat(parts[0]);
                const h = parseFloat(parts[1]);
                if (!isNaN(w) && !isNaN(h) && h !== 0) return `aspect-ratio: ${w}/${h};`;
            }
            return '';
        }

        // --- SKELETON LOADING HELPERS ---
        function createSkeletons(container, count, type = 'image') {
            const skeletons = [];
            for (let i = 0; i < count; i++) {
                const div = document.createElement('div');
                
                if (type === 'logo') {
                    div.className = 'image-card logo-card skeleton-card';
                    div.innerHTML = '<div class="skeleton-img"></div>';
                } else if (type === 'hero-img') {
                    div.className = 'hero-img-box skeleton';
                } else if (type === 'hero-logo') {
                    div.className = 'hero-logo-card skeleton';
                } else if (type === 'featured') {
                    div.className = 'grid-box skeleton';
                } else {
                    // Standard image card
                    div.className = 'image-card skeleton-card';
                    // Random height for masonry effect (200px to 400px)
                    const height = Math.floor(Math.random() * (400 - 200 + 1) + 200);
                    div.style.height = `${height}px`;
                    div.innerHTML = '<div class="skeleton-img"></div>';
                }
                
                // Distribute into columns if they exist (Masonry)
                const cols = container.querySelectorAll('.gallery-col');
                if (cols.length > 0) {
                    // Find shortest column to append to
                    let target = cols[0];
                    cols.forEach(col => {
                        if (col.children.length < target.children.length) target = col;
                    });
                    target.appendChild(div);
                } else {
                    container.appendChild(div);
                }
                skeletons.push(div);
            }
            return skeletons;
        }

        function removeSkeletons(skeletons) {
            skeletons.forEach(el => el.remove());
        }

        function loadGalleryImages() {
            const grid = document.querySelector('#section-images .gallery-grid');
            if (grid && grid.querySelector('.error-state-card')) return;

            if (imageState.loading || !imageState.hasMore) return;
            
            // Ensure scroll stays at 0 for initial load to prevent auto-scrolling
            if (imageState.offset === 0) window.scrollTo(0, 0);
            
            imageState.loading = true;

            // Show mobile surface loader
            const mobileSurfaceLoader = document.getElementById('mobileSurfaceLoader');
            if (window.innerWidth <= 768 && mobileSurfaceLoader) mobileSurfaceLoader.classList.add('active');

            // Calculate limit based on screen size (small chunks for mobile)
            const limit = getDynamicLimit();
            
            // Initialize columns if not already done
            setupMasonryGrid(grid);
            
            // Add skeletons before fetch
            const skeletons = createSkeletons(grid, limit, 'image');

            fetch(`/api/assets/image?offset=${imageState.offset}&limit=${limit}`)
                .then(r => r.json())
                .then(data => {
                    // removeSkeletons(skeletons); // Removed to allow progressive replacement
                    imageState.loading = false;
                    if (data.success) {
                        if (data.assets.length === 0 && mobileSurfaceLoader) {
                            mobileSurfaceLoader.classList.remove('active');
                        }

                        if (data.assets.length < limit) imageState.hasMore = false;
                        
                        // Update global gallery images (append instead of replace for infinite scroll)
                        if (imageState.offset === 0) galleryImages = data.assets;
                        else galleryImages = [...galleryImages, ...data.assets];

                        // Batch Load Logic: Wait for all images to load before displaying
                        const currentBatchOffset = imageState.offset;

                        const batchPromises = data.assets.map((asset, index) => {
                            return new Promise((resolve) => {
                                const smallUrl = window.getGridImageUrl(asset);
                                const arStyle = getAspectRatioStyle(asset.resolution);

                                const card = document.createElement('div');
                                card.className = 'image-card fade-in';

                                card.innerHTML = `
                                    <div class="card-img-wrapper" style="${arStyle}">
                                        <img src="${smallUrl}" alt="Image" style="width: 100%; height: auto; display: block;">
                                    </div>
                                    <button class="card-action-btn like-btn top-left ${asset.is_liked ? 'active' : ''}" data-id="${asset.id}" data-category="${asset.category_type}" onclick="event.stopPropagation(); toggleLike(this)">
                                    </button>
                                    <button class="card-action-btn save-btn top-right ${asset.is_saved ? 'active' : ''}" data-id="${asset.id}" data-category="${asset.category_type}" onclick="event.stopPropagation(); toggleSave(this)">
                                    </button>
                                    <div class="card-overlay">
                                        <h3 class="card-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">${asset.name || 'Image'}</h3>
                                        <p style="font-size: 0.8rem; color: #ddd; margin: 4px 0 0; font-weight: 400;">${asset.category || ''}</p>
                                        <div class="card-actions">
                                        <div class="download-icon-btn" onclick="event.stopPropagation(); window.location.href='/download/${asset.category_type || 'image'}/${asset.id}'" title="{{ t('Download') }}">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mobile-card-footer">
                                        <div class="mobile-user-info" onclick="event.stopPropagation(); openUserProfile(this.dataset.uid, this.dataset.uname, this.dataset.uavatar)" data-uid="${asset.user_id}" data-uname="${asset.username}" data-uavatar="${asset.avatar}">
                                            <img src="${asset.avatar ? (asset.avatar.startsWith('/static/') ? asset.avatar : '/static/avatars/' + asset.avatar) : 'https://via.placeholder.com/32'}" class="mobile-avatar" alt="User">
                                            <span class="mobile-username">${asset.username || 'User'}</span>
                                        </div>
                                        <span style="font-size: 0.75rem; color: #888;">${asset.resolution || ''}</span>
                                    <button class="mobile-download-btn" onclick="event.stopPropagation(); window.location.href='/download/${asset.category_type || 'image'}/${asset.id}'" title="{{ t('Download') }}">
                                            <img src="/static/icons/download.png" style="width: 16px;">
                                        </button>
                                    </div>
                                `;

                                // Preload Image
                                const img = new Image();
                                img.src = smallUrl;
                                const finish = () => resolve({ card, asset, index });
                                if(img.complete) finish();
                                else {
                                    img.onload = finish;
                                    img.onerror = finish;
                                }
                            });
                        });

                        Promise.all(batchPromises).then(results => {
                            results.forEach(({ card, asset, index }) => {
                                // Place in exact skeleton slot to maintain order
                                if (skeletons[index] && skeletons[index].parentNode) {
                                    skeletons[index].parentNode.replaceChild(card, skeletons[index]);
                                } else {
                                    // Fallback
                                    const cols = grid.querySelectorAll('.gallery-col');
                                    if (cols.length > 0) {
                                        let target = cols[0];
                                        cols.forEach(col => {
                                            if (col.offsetHeight < target.offsetHeight) target = col;
                                        });
                                        target.appendChild(card);
                                    } else {
                                        grid.appendChild(card);
                                    }
                                }

                                card.addEventListener('click', (e) => {
                                    openImageViewer(asset, currentBatchOffset + index, galleryImages);
                                });
                            });

                            // Cleanup unused skeletons
                            for (let i = data.assets.length; i < skeletons.length; i++) {
                                if (skeletons[i]) skeletons[i].remove();
                            }

                            if (mobileSurfaceLoader) mobileSurfaceLoader.classList.remove('active');
                        });
                        
                        if (data.assets.length > 0) imageState.offset += data.assets.length;

                        // Check Limit for Infinite Scroll
                        if (imageState.offset >= imageState.limitThreshold && imageState.hasMore) {
                            createLoadMoreButton(grid.parentNode, () => {
                                imageState.limitThreshold += 100;
                                loadGalleryImages();
                            });
                        }

                    } else {
                        if (mobileSurfaceLoader) mobileSurfaceLoader.classList.remove('active');
                    }
                })
                .catch(() => {
                    const mobileSurfaceLoader = document.getElementById('mobileSurfaceLoader');
                    if (mobileSurfaceLoader) mobileSurfaceLoader.classList.remove('active');
                    removeSkeletons(skeletons);
                    imageState.loading = false;
                    if (!navigator.onLine) updateConnectionStatus();
                    createErrorCard(grid, "{{ t('Could not load images.') }}", () => loadGalleryImages());
                });
        }

        function loadHeroImages() {
            const container = document.querySelector('.hero-right');
            if (!container) return;

            // Clear and show skeletons
            container.innerHTML = '';
            const skeletons = createSkeletons(container, 8, 'hero-img');

            // Hero section is small, 20 is sufficient
            fetch('/api/assets/image?limit=20&offset=0')
                .then(r => r.json())
                .then(data => {
                    removeSkeletons(skeletons);
                    if (data.success && data.assets.length > 0) {
                        
                        // Calculate grid capacity
                        const boxSize = 200; 
                        const gap = 12;
                        const width = container.clientWidth;
                        const height = container.clientHeight || 400;
                        
                        const cols = Math.floor(width / (boxSize + gap)) || 2;
                        const rows = Math.floor(height / (boxSize + gap)) || 2;
                        const count = cols * rows;

                        const shuffled = [...data.assets].sort(() => 0.5 - Math.random());
                        const items = shuffled.slice(0, count);
                        
                        items.forEach((asset, index) => {
                            const box = document.createElement('div');
                            box.className = 'hero-img-box';
                            
                            const smallUrl = window.getGridImageUrl(asset);
                            
                            box.innerHTML = `<img src="${smallUrl}" alt="Hero Image">`;
                            container.appendChild(box);
                            
                            box.addEventListener('click', () => openImageViewer(asset, index, items));
                        });
                    }
                })
                .catch(() => {
                    if (!navigator.onLine) updateConnectionStatus();
                    createErrorCard(container, "{{ t('Failed to load.') }}", () => loadHeroImages());
                });
        }

        function loadHeroLogos() {
            const container = document.querySelector('.hero-logo-grid');
            if (!container) return;

            // Ensure visibility
            container.style.display = '';

            container.innerHTML = '';
            const skeletons = createSkeletons(container, 10, 'hero-logo');

            // Fetch random images instead of logos
            fetch('/api/assets/image?limit=20&sort=random')
                .then(r => r.json())
                .then(data => {
                    removeSkeletons(skeletons);
                    if (data.success && data.assets.length > 0) {
                        const shuffled = [...data.assets].sort(() => 0.5 - Math.random());
                        
                        const containerWidth = container.clientWidth;
                        const minItemWidth = 110; 
                        const gap = 12;
                        let columns = Math.floor((containerWidth + gap) / (minItemWidth + gap));
                        if (columns < 1) columns = 1;
                        const rows = 2; 
                        const itemsToShow = shuffled.slice(0, columns * rows);

                        itemsToShow.forEach((asset, index) => {
                            const card = document.createElement('div');
                            card.className = 'hero-logo-card';
                            // Use object-fit: cover for images
                            card.innerHTML = `<img src="${window.getGridImageUrl(asset)}" alt="Image" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">`;
                            card.onclick = () => openImageViewer(asset, index, itemsToShow);
                            container.appendChild(card);
                        });
                    }
                })
                .catch(() => {
                    if (!navigator.onLine) updateConnectionStatus();
                });
        }

        function loadLogos() {
            const grid = document.querySelector('#section-logos .logo-grid');
            if (grid && grid.querySelector('.error-state-card')) return;

            if (logoState.loading || !logoState.hasMore) return;
            
            if (logoState.offset === 0) window.scrollTo(0, 0);
            logoState.loading = true;

            const limit = getDynamicLimit();
            
            const skeletons = createSkeletons(grid, limit, 'logo');

            fetch(`/api/assets/logo?offset=${logoState.offset}&limit=${limit}`)
                .then(r => r.json())
                .then(data => {
                    removeSkeletons(skeletons);
                    logoState.loading = false;
                    if (data.success) {
                        if (data.assets.length < limit) logoState.hasMore = false;

                        data.assets.forEach((asset, index) => {
                            const smallUrl = window.getGridImageUrl(asset);
                            
                            const card = document.createElement('div');
                            card.className = 'image-card logo-card';
                            
                            // Logos often have transparency, so we give them a nice container background
                            card.innerHTML = `
                                <div class="card-img-wrapper">
                                    <img src="${smallUrl}" alt="${asset.name}" style="width: 100%; height: auto; display: block; border-radius: 12px; background: #fff;">
                                </div>
                                <button class="card-action-btn like-btn top-left ${asset.is_liked ? 'active' : ''}" data-id="${asset.id}" data-category="${asset.category_type}" onclick="event.stopPropagation(); toggleLike(this)">
                                </button>
                                <button class="card-action-btn save-btn top-right ${asset.is_saved ? 'active' : ''}" data-id="${asset.id}" data-category="${asset.category_type}" onclick="event.stopPropagation(); toggleSave(this)">
                                </button>
                                <div class="card-overlay" style="justify-content: flex-end;">
                                    <div class="download-icon-btn" onclick="event.stopPropagation(); window.location.href='/download/${asset.category_type || 'logo'}/${asset.id}'">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                    </div>
                                </div>
                            `;
                            grid.appendChild(card);

                            // Add click event for viewer
                            card.addEventListener('click', () => {
                                openIconViewer(asset, index, data.assets);
                            });
                        });

                        if (data.assets.length > 0) logoState.offset += data.assets.length;
                    }
                })
                .catch(() => {
                    removeSkeletons(skeletons);
                    logoState.loading = false;
                    if (!navigator.onLine) updateConnectionStatus();
                    createErrorCard(grid, "{{ t('Could not load logos.') }}", () => loadLogos());
                });
        }

        // --- PUBLIC PROFILE LOGIC ---
        window.openUserProfile = function(userId, username, avatar) {
            if (!userId || userId === 'undefined') return;
            
            // Switch section
            document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
            const profileSection = document.getElementById('section-public-profile');
            if(profileSection) profileSection.style.display = 'block';
            
            // Initial Header Update (Fast)
            const nameEl = document.getElementById('publicProfileName');
            const avatarEl = document.getElementById('publicProfileAvatar');
            const bioEl = document.getElementById('publicProfileBio');
            const socialsContainer = document.getElementById('publicProfileSocials');
            const contactBtn = document.getElementById('publicProfileContactBtn');

            if(nameEl) nameEl.textContent = username || 'User';
            if(avatarEl) avatarEl.src = avatar && avatar !== 'null' && avatar !== 'undefined' ? (avatar.startsWith('/static/') ? avatar : `/static/avatars/${avatar}`) : 'https://via.placeholder.com/100';
            
            // Reset Extended Info
            if(bioEl) { bioEl.textContent = ''; bioEl.style.display = 'none'; }
            if(socialsContainer) socialsContainer.innerHTML = '';
            if(contactBtn) contactBtn.style.display = 'none';
            
            // Reset State
            publicProfileState = { offset: 0, loading: false, hasMore: true, loaded: false, currentUserId: userId };
            const grid = document.getElementById('public-profile-grid');
            if(grid) grid.innerHTML = '';
            
            // Fetch Full Details
            fetch(`/api/user/${userId}/details`)
                .then(r => r.json())
                .then(data => {
                    if(data.success && data.user) {
                        const u = data.user;
                        if(bioEl && u.bio) {
                            bioEl.textContent = u.bio;
                            bioEl.style.display = 'block';
                        }
                        
                        // Render Socials
                        if(socialsContainer) {
                            const createLink = (url, icon, label) => {
                                if(!url) return;
                                const cleanUrl = url.startsWith('http') ? url : `https://${url}`;
                                const a = document.createElement('a');
                                a.href = cleanUrl;
                                a.target = "_blank";
                                a.className = "nav-btn secondary";
                                a.style.width = "auto";
                                a.style.padding = "0 15px";
                                a.style.fontSize = "0.9rem";
                                // Icons are black, invert for dark button background
                                a.innerHTML = `<img src="/static/icons/${icon}" style="width:16px; margin-right:8px; filter: brightness(0) invert(1);"> ${label}`;
                                socialsContainer.appendChild(a);
                            };
                            
                            if(u.website) createLink(u.website, 'domain.png', 'Website');
                            if(u.instagram) createLink(`https://instagram.com/${u.instagram.replace('@','')}`, 'instagram.png', 'Instagram');
                            if(u.twitter) createLink(`https://twitter.com/${u.twitter.replace('@','')}`, 'twitter.png', 'Twitter');
                        }

                        if(contactBtn && u.contact_email) {
                            contactBtn.href = `mailto:${u.contact_email}`;
                            contactBtn.style.display = 'inline-flex';
                            // Contact button is white, keep icon black
                            contactBtn.innerHTML = `<img src="/static/icons/email.png" style="width:16px; margin-right:8px;"> Contact`;
                        }
                    }
                });

            loadPublicProfileImages();
            window.scrollTo(0, 0);
        };

        function loadPublicProfileImages() {
            const grid = document.getElementById('public-profile-grid');
            if (!grid || publicProfileState.loading || !publicProfileState.hasMore) return;
            
            publicProfileState.loading = true;
            const limit = getDynamicLimit();
            setupMasonryGrid(grid);
            const skeletons = createSkeletons(grid, limit, 'image');
            
            fetch(`/api/assets/image?user_id=${publicProfileState.currentUserId}&offset=${publicProfileState.offset}&limit=${limit}`)
                .then(r => r.json())
                .then(data => {
                    publicProfileState.loading = false;
                    if (data.success) {
                        if (skeletons.length > data.assets.length) {
                            for (let i = data.assets.length; i < skeletons.length; i++) {
                                if (skeletons[i]) skeletons[i].remove();
                            }
                        }
                        if (data.assets.length < limit) publicProfileState.hasMore = false;
                        
                        data.assets.forEach((asset, index) => {
                            const smallUrl = window.getGridImageUrl(asset);
                            const arStyle = getAspectRatioStyle(asset.resolution);
                            const card = document.createElement('div');
                            card.className = 'image-card fade-in';
                            card.innerHTML = `
                                <div class="card-img-wrapper" style="${arStyle}">
                                    <img src="${smallUrl}" style="width:100%; height:auto; display:block;">
                                </div>
                            `;
                            
                            if (skeletons[index] && skeletons[index].parentNode) skeletons[index].parentNode.replaceChild(card, skeletons[index]);
                            else grid.appendChild(card);
                            
                            card.onclick = () => openImageViewer(asset, index, data.assets);
                        });
                        if (data.assets.length > 0) publicProfileState.offset += data.assets.length;
                    }
                })
                .catch(e => {
                    console.error(e);
                    publicProfileState.loading = false;
                    removeSkeletons(skeletons);
                });
        }

        function loadFeaturedImages() {
            const container = document.querySelector('.portfolio-container');
            // If container exists, clear it and add skeletons
            let skeletons = [];
            if (container) {
                container.innerHTML = '';
                skeletons = createSkeletons(container, 12, 'featured');
            }

            // Featured section (Home tab) - Load dynamic amount to fill screen
            fetch(`/api/assets/image?limit=${getDynamicLimit()}&offset=0`)
                .then(r => r.json())
                .then(data => {
                    if (container) removeSkeletons(skeletons);
                    
                    if (data.success && data.assets.length > 0) {
                        if (!container) return;
                        

                        // Shuffle the images array to get random selection
                        const shuffled = [...data.assets].sort(() => 0.5 - Math.random());
                        
                        // --- DYNAMIC CALCULATION ---
                        // Calculate items needed to fill the grid (columns * rows)
                        const containerWidth = container.clientWidth || window.innerWidth;
                        const availableWidth = containerWidth - 30; // Subtract padding
                        const minColWidth = 232; // 220px card + 12px gap
                        
                        let columns = Math.floor(availableWidth / minColWidth);
                        if (columns < 1) columns = 1;

                        // Adapt rows: 3 lines for normal, 4-5 for ultra-wide screens
                        let rows = 3;
                        if (window.innerWidth > 1900) rows = 4;
                        if (window.innerWidth > 2800) rows = 5;

                        let itemCount = columns * rows;
                        // Adjust for large feature (2x2) on desktop: takes 4 slots, counts as 1 item (-3 total)
                        if (window.innerWidth > 640) itemCount -= 3;
                        
                        const featuredList = shuffled.slice(0, Math.max(1, itemCount));
                        
                        featuredList.forEach((asset, index) => {
                            const smallUrl = window.getGridImageUrl(asset);

                            // Create the card element
                            const box = document.createElement('div');
                            box.className = 'grid-box';
                            
                            // Make the first item a large feature card
                            if (index === 0) box.classList.add('large-feature');

                            box.innerHTML = `
                                <img src="${smallUrl}" alt="Featured">
                                <div class="box-overlay"></div>
                                <div class="corner-icon-circle" onclick="event.stopPropagation(); window.location.href='/download/${asset.category_type || 'image'}/${asset.id}'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </div>
                            `;

                            container.appendChild(box);

                            box.addEventListener('click', () => {
                                openImageViewer(asset, index, featuredList);
                            });
                        });
                    }
                })
                .catch(() => {
                    if (!navigator.onLine) updateConnectionStatus();
                    if (container) createErrorCard(container, "{{ t('Failed to load featured items.') }}", () => loadFeaturedImages());
                });
        }

        // LOADING ANIMATION
        const loader = document.querySelector('.page-loader');
        const logo = document.querySelector('.logo');

        function animateLoader() {
            // Reset
            loader.style.width = '0';
            loader.style.opacity = '1';
            loader.style.transition = 'none';
            
            // Force reflow
            void loader.offsetWidth;

            // Animate to 80%
            loader.style.transition = 'width 1.5s cubic-bezier(0.2, 0.8, 0.2, 1)';
            loader.style.width = '80%';

            // Finish animation (simulated)
            setTimeout(() => {
                loader.style.width = '100%';
                setTimeout(() => {
                    loader.style.opacity = '0';
                }, 200);
            }, 1000);
        }

        // SIDEBAR NAV BUTTONS LOGIC
        const sidebarNavButtons = document.querySelectorAll('.sidebar-nav-btn');
        sidebarNavButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetId = e.currentTarget.getAttribute('data-target');
                if(!targetId) return;

                // Direct section switch
                animateLoader();
                window.scrollTo(0, 0);
                document.querySelectorAll('.content-section').forEach(sec => {
                    sec.style.display = 'none';
                });
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.style.display = 'block';
                }

                // Lazy load content based on target
                if (targetId === 'section-home') loadHomeContent();
                if (targetId === 'section-images') loadImagesContent();
                if (targetId === 'section-logos') loadLogosContent();

                if(window.innerWidth <= 768) closeAllMenus();
            });
        });

        logo.addEventListener('click', (e) => {
            e.preventDefault();
            animateLoader();
        });

        // MOBILE MENU TOGGLE
        const leftMenuToggle = document.querySelector('.menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        
        // RIGHT MENU TOGGLE
        const rightMenuToggle = document.getElementById('rightMenuToggle');
        const rightSidebar = document.querySelector('.right-sidebar');
        const closeRightBtn = document.getElementById('closeRight');

        // MOBILE SEARCH TRANSFORMATION
        const mobileSearchBtn = document.getElementById('mobileSearchBtn');
        const navbar = document.querySelector('.navbar');
        const searchInput = document.querySelector('.search-input');
        const searchWrapper = document.querySelector('.search-wrapper');

        if (mobileSearchBtn) {
            mobileSearchBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                navbar.classList.add('search-active');
                setTimeout(() => searchInput.focus(), 100);
            });
        }
        
        document.addEventListener('click', (e) => {
            if (navbar.classList.contains('search-active') && !searchWrapper.contains(e.target)) {
                navbar.classList.remove('search-active');
            }
        });

        const overlay = document.querySelector('.sidebar-overlay');

        // ================= UPLOAD MODAL LOGIC =================
        const uploadNavBtn = document.getElementById('uploadNavBtn');
        const uploadModal = document.getElementById('uploadModal');

        function closeUploadModal() {
            uploadModal.classList.remove('active');
            toggleMobileBackground(false);
            setTimeout(() => {
                uploadModal.style.display = 'none';
            }, 300);
        }

        if (uploadNavBtn) {
            uploadNavBtn.addEventListener('click', () => {
            // Show loader
            animateLoader();
            
            toggleMobileBackground(true);
            // Check if already loaded
            if (uploadModal.querySelector('.uploader-template-wrapper')) {
                uploadModal.style.display = 'flex';
                setTimeout(() => uploadModal.classList.add('active'), 10);
                return;
            }

            // Fetch the upload template
            fetch('/uploader-template') 
                .then(response => response.text())
                .then(html => {
                    uploadModal.innerHTML = html;
                    
                    // Add Exit Button to the wrapper
                    const wrapper = uploadModal.querySelector('.uploader-template-wrapper');
                    const exitBtn = document.createElement('button');
                    exitBtn.className = 'upload-close-btn';
                    exitBtn.innerHTML = '&times;';
                    exitBtn.onclick = closeUploadModal;
                    
                    if (wrapper) {
                        wrapper.style.maxHeight = '90vh';
                        wrapper.style.maxWidth = '1200px';
                        wrapper.style.width = '95%';
                        wrapper.style.boxShadow = '0 40px 80px rgba(0,0,0,0.6)';
                        wrapper.style.position = 'relative';
                        wrapper.appendChild(exitBtn);
                    } else {
                        uploadModal.appendChild(exitBtn);
                    }

                    // Show Modal
                    uploadModal.style.display = 'flex';
                    setTimeout(() => {
                        uploadModal.classList.add('active');
                    }, 10);

                    // Execute Scripts inside the template
                    const scripts = uploadModal.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });
                    
                    // Apply translations after injecting the HTML
                    if (window.translationSystem) {
                        window.translationSystem.applyTranslations(window.translationSystem.currentLang);
                    }
                })
                .catch(err => console.error('Failed to load upload form', err));
            });
        }

        // ================= EDITOR MODAL LOGIC =================
        const editorModal = document.getElementById('editorModal');

        function closeEditorModal() {
            editorModal.classList.remove('active');
            toggleMobileBackground(false);
            setTimeout(() => {
                editorModal.style.display = 'none';
                editorModal.innerHTML = '';
            }, 300);
        }

        function openEditorModal(asset) {
            animateLoader();
            toggleMobileBackground(true);
            // Make asset available to the editor script
            window.currentEditingAsset = asset;

            fetch('/image-editor-template')
                .then(response => response.text())
                .then(html => {
                    editorModal.innerHTML = html;
                    
                    // Add Close Button
                    const exitBtn = document.createElement('button');
                    exitBtn.className = 'upload-close-btn';
                    exitBtn.innerHTML = '&times;';
                    exitBtn.onclick = closeEditorModal;
                    
                    // Append to the first child (wrapper) if exists, else to modal
                    if (editorModal.firstElementChild) {
                        editorModal.firstElementChild.appendChild(exitBtn);
                    } else {
                        editorModal.appendChild(exitBtn);
                    }

                    editorModal.style.display = 'flex';
                    setTimeout(() => editorModal.classList.add('active'), 10);

                    // Execute Scripts
                    const scripts = editorModal.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });

                    // Initialize the editor using the function defined in the loaded template
                    if (typeof window.launchImageEditor === 'function') {
                        window.launchImageEditor(asset);
                    }

                    // Ensure the editor's Cancel button closes the modal completely
                    const editorCancelBtn = document.getElementById('editorCancelBtn');
                    if (editorCancelBtn) {
                        editorCancelBtn.onclick = closeEditorModal;
                    }
                })
                .catch(err => console.error('Failed to load editor', err));
        }

        // ================= PROFILE VIEW LOGIC =================
        const myProfileBtn = document.getElementById('myProfileBtn');
        const profileSection = document.getElementById('section-profile');

        if (myProfileBtn) {
            myProfileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (typeof closeAllMenus === 'function') closeAllMenus();

                // Hide all other sections
                document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
                document.getElementById('section-home').style.display = 'none'; // Ensure home is hidden
                
                // Show Profile Section
                profileSection.style.display = 'block';

                // Check if already loaded
                if (profileSection.innerHTML.trim() !== "") {
                    return;
                }

                // Fetch Template
                fetch('/profile-template?t=' + Date.now())
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status} - Route not found`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        profileSection.innerHTML = html;
                        
                        // Execute Scripts inside the template
                        const scripts = profileSection.querySelectorAll('script');
                        scripts.forEach(oldScript => {
                            const newScript = document.createElement('script');
                            Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });

                    })
                    .catch(err => {
                        console.error('Error loading profile:', err);
                        alert("{{ t('Failed to load profile. Ensure the backend route /profile-template exists.') }}");
                    });
            });
        }

        window.openReportSettings = function(id, category) {
            if (typeof openReportModal === 'function') openReportModal(id, category);
        };

        // ================= SETTINGS LOGIC =================
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsTriggers = document.querySelectorAll('.settings-trigger');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');

        function openSettings(targetTab = null) {
            if (typeof closeAllMenus === 'function') closeAllMenus();
            toggleMobileBackground(true);
            
            // Fetch Settings Template
            fetch('/settings-template')
                .then(response => response.text())
                .then(html => {
                    settingsModal.innerHTML = html;
                    settingsModal.classList.add('active');
                    
                    // Execute Scripts inside the template
                    const scripts = settingsModal.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });

                    // Switch tab if requested
                    if (targetTab && typeof window.switchSettingsTab === 'function') {
                        setTimeout(() => window.switchSettingsTab(targetTab), 50);
                    }
                })
                .catch(err => console.error('Failed to load settings', err));
        }

        function closeSettings() {
            settingsModal.classList.remove('active');
            toggleMobileBackground(false);
        }

        if (settingsBtn) settingsBtn.addEventListener('click', (e) => { e.preventDefault(); openSettings(); });
        settingsTriggers.forEach(btn => btn.addEventListener('click', (e) => { e.preventDefault(); openSettings(); }));
        if (closeSettingsBtn) closeSettingsBtn.addEventListener('click', closeSettings);
        if (settingsModal) settingsModal.addEventListener('click', (e) => { if(e.target === settingsModal) closeSettings(); });

        // Settings Tabs
        window.switchSettingsTab = function(tabName) {
            // Update Nav
            document.querySelectorAll('.settings-nav-item').forEach(btn => {
                if(btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(tabName)) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            
            // Update Content
            document.querySelectorAll('.settings-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            const targetSection = document.getElementById('settings-tab-' + tabName);
            if (targetSection) {
                targetSection.classList.add('active');
            } else if (tabName !== 'general') {
                const general = document.getElementById('settings-tab-general');
                if (general) general.classList.add('active');
            }
            
            // Update Title
            const titles = { 'general': 'General Settings', 'appearance': 'Appearance', 'account': 'Account Settings', 'support': 'Help & Support' };
            const titleEl = document.getElementById('settingsTitle');
            if (titleEl) titleEl.textContent = titles[tabName] || 'Settings';
        };

        // ================= TRANSLATION SYSTEM =================
        class TranslationSystem {
            constructor() {
                this.currentLang = localStorage.getItem('app_lang') || 'en';
                this.translations = {};
                
                // Initialize selector if exists
                const selector = document.getElementById('languageSelect');
                if(selector) selector.value = this.currentLang;

                // Always load the current language to ensure data is available
                this.loadLanguage(this.currentLang);
            }

            async setLanguage(lang) {
                if(lang === this.currentLang) return;
                await this.loadLanguage(lang);
            }

            async loadLanguage(lang) {
                // Check cache
                if (this.translations[lang]) {
                    this.applyTranslations(lang);
                    return;
                }

                try {
                    // Fetch JSON from static folder (You must move your JSON files to /static/locales/)
                    // Mapping: en -> english.json, fr -> french.json, etc.
                    // Fetch JSON from static folder
                    const fileMap = { 'en': 'english', 'fr': 'fr', 'es': 'espagnol', 'de': 'german', 'pt': 'Brazilian Portuguese' };
                    const filename = fileMap[lang] || 'english';
                    
                    const response = await fetch(`/static/locales/${filename}.json`);
                    if(!response.ok) throw new Error('Language file not found');
                    
                    const data = await response.json();
                    this.translations[lang] = data;
                    this.currentLang = lang;
                    
                    // Update Categories List and Re-render UI
                    if (CATEGORIES_DB[lang]) categoriesList = CATEGORIES_DB[lang];
                    renderCategoryWidgets();
                    
                    localStorage.setItem('app_lang', lang);
                    this.applyTranslations(lang);
                } catch (e) {
                    console.error('Translation failed:', e);
                }
            }

            applyTranslations(lang) {
                const data = this.translations[lang];
                if (!data) return;

                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (data[key]) {
                        // Handle attributes like placeholder
                        const targetAttr = el.getAttribute('data-i18n-attr');
                        if (targetAttr) {
                            el.setAttribute(targetAttr, data[key]);
                        } else {
                            // Handle text content
                            // If element has children (like icons), we might need to be careful
                            // For now, we assume simple text replacement or span wrapping
                            if(el.children.length === 0) {
                                el.textContent = data[key];
                            } else {
                                // If it has children, try to find a text node or just replace text content if it's safe
                                // Ideally, wrap text in spans in HTML. 
                                // Fallback:
                                el.childNodes.forEach(node => {
                                    if(node.nodeType === 3 && node.nodeValue.trim() !== '') {
                                        node.nodeValue = data[key];
                                    }
                                });
                            }
                        }
                    }
                });
            }
        }

        // Initialize
        window.translationSystem = new TranslationSystem();

        // Theme Switcher
        window.setTheme = function(color, el) {
            document.documentElement.style.setProperty('--primary', color);
            document.documentElement.style.setProperty('--primary-dark', color);
            
            document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
            el.classList.add('active');
            
            // Save to local storage
            localStorage.setItem('theme-color', color);
            
            // Save to Backend
            fetch('/api/user/preferences', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ theme_color: color })
            }).catch(e => console.error('Failed to save theme', e));
        };

        // Theme Mode Toggle
        window.toggleThemeMode = function(checkbox) {
            const mode = checkbox.checked ? 'light' : 'dark';
            if (mode === 'light') document.documentElement.setAttribute('data-theme', 'light');
            else document.documentElement.removeAttribute('data-theme');
            
            localStorage.setItem('theme-mode', mode);
            
            fetch('/api/user/preferences', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ theme_mode: mode })
            }).catch(e => console.error('Failed to save mode', e));
        };

        // Initialize Toggle State
        const currentMode = document.documentElement.getAttribute('data-theme');
        const modeToggle = document.getElementById('themeModeToggle');
        if(modeToggle) modeToggle.checked = (currentMode === 'light');

        // Custom Color Picker Logic
        const themeColorInput = document.getElementById('themeColorInput');
        const customColorSwatch = document.getElementById('customColorSwatch');

        if (themeColorInput && customColorSwatch) {
            themeColorInput.addEventListener('input', (e) => {
                const color = e.target.value;
                document.documentElement.style.setProperty('--primary', color);
                document.documentElement.style.setProperty('--primary-dark', color);
                
                // Visual feedback
                document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
                customColorSwatch.classList.add('active');
                customColorSwatch.style.background = color;
                customColorSwatch.querySelector('span').style.display = 'none';
            });

            themeColorInput.addEventListener('change', (e) => {
                const color = e.target.value;
                setTheme(color, customColorSwatch);
            });
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme-color');
        if(savedTheme) {
            document.documentElement.style.setProperty('--primary', savedTheme);
            const swatches = document.querySelectorAll('.theme-swatch');
            let foundPreset = false;
            swatches.forEach(s => {
                const onclick = s.getAttribute('onclick');
                if(onclick && onclick.includes(savedTheme)) {
                    s.classList.add('active');
                    foundPreset = true;
                }
                else s.classList.remove('active');
            });
            
            if (!foundPreset && customColorSwatch) {
                customColorSwatch.classList.add('active');
                customColorSwatch.style.background = savedTheme;
                if(themeColorInput) themeColorInput.value = savedTheme;
                const icon = customColorSwatch.querySelector('span');
                if(icon) icon.style.display = 'none';
            }
        }

        // ================= SAVED ITEMS LOGIC =================
        const savedBtn = document.getElementById('savedBtn');
        if (savedBtn) {
            savedBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (typeof closeAllMenus === 'function') closeAllMenus();
                
                // Switch Section
                document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
                const savedSection = document.getElementById('section-saved');
                savedSection.style.display = 'block';
                
                animateLoader();
                if (!savedLoaded) {
                    savedLoaded = true;
                    loadSavedAssets();
                }
            });
        }

        function loadSavedAssets() {
            const grid = document.getElementById('saved-grid');
            const emptyState = document.getElementById('saved-empty');
            
            fetch('/api/user/saved')
            .then(r => {
                if(r.status === 401) {
                    document.querySelector('.signup-trigger').click();
                    throw new Error('Auth required');
                }
                return r.json();
            })
            .then(data => {
                if(data.success) {
                    grid.innerHTML = '';
                    if(data.assets.length === 0) {
                        emptyState.style.display = 'block';
                        return;
                    }
                    emptyState.style.display = 'none';
                    
                    data.assets.forEach(asset => {
                        const card = document.createElement('div');
                        const smallUrl = window.getGridImageUrl(asset);
                        
                        // Render based on category type
                        if (asset.category_type === 'logo') {
                            card.className = 'image-card logo-card';
                            card.innerHTML = `
                                <div class="card-img-wrapper">
                                    <img src="${smallUrl}" alt="${asset.name}" style="width: 100%; height: auto; display: block; border-radius: 12px; background: #fff;">
                                </div>
                                <button class="card-action-btn like-btn top-left ${asset.is_liked ? 'active' : ''}" data-id="${asset.id}" data-category="${asset.category_type}" onclick="event.stopPropagation(); toggleLike(this)">
                                </button>
                                <button class="card-action-btn save-btn top-right active" data-id="${asset.id}" data-category="${asset.category_type}" onclick="event.stopPropagation(); toggleSave(this)">
                                </button>
                            `;
                            card.addEventListener('click', () => openIconViewer(asset, 0, [asset]));
                        } else {
                            // Default to image
                            card.className = 'image-card';
                            card.innerHTML = `
                                <div class="card-img-wrapper">
                                    <img src="${smallUrl}" alt="Image" style="width: 100%; height: auto; display: block;">
                                </div>
                                <button class="card-action-btn like-btn top-left ${asset.is_liked ? 'active' : ''}" data-id="${asset.id}" data-category="${asset.category_type}" onclick="event.stopPropagation(); toggleLike(this)">
                                </button>
                                <button class="card-action-btn save-btn top-right active" data-id="${asset.id}" data-category="${asset.category_type}" onclick="event.stopPropagation(); toggleSave(this)">
                                </button>
                                <div class="card-overlay">
                                    <h3 class="card-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">${asset.name || 'Image'}</h3>
                                    <p style="font-size: 0.8rem; color: #ddd; margin: 4px 0 0; font-weight: 400;">${asset.category || ''}</p>
                                    <div class="card-actions">
                                        <div class="download-icon-btn" onclick="event.stopPropagation(); window.location.href='/download/${asset.category_type || 'image'}/${asset.id}'" title="{{ t('Download') }}">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                        </div>
                                    </div>
                                </div>
                            `;
                            card.addEventListener('click', () => openImageViewer(asset, 0, [asset]));
                        }
                        grid.appendChild(card);
                    });
                }
            })
            .catch(e => {
                console.log(e);
                if (!navigator.onLine) updateConnectionStatus();
            });
        }

        function closeAllMenus() {
            sidebar.classList.remove('active');
            if (rightSidebar) rightSidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        function toggleLeftMenu() {
            if (sidebar.classList.contains('active')) closeAllMenus();
            else {
                closeAllMenus();
                sidebar.classList.add('active');
                overlay.classList.add('active');
            }
        }

        function toggleRightMenu() {
            if (rightSidebar) {
                if (rightSidebar.classList.contains('active')) closeAllMenus();
                else {
                    closeAllMenus();
                    rightSidebar.classList.add('active');
                    overlay.classList.add('active');
                }
            }
        }

        leftMenuToggle.addEventListener('click', toggleLeftMenu);
        if (rightMenuToggle) {
            rightMenuToggle.addEventListener('click', toggleRightMenu);
        }
        if (closeRightBtn) {
            closeRightBtn.addEventListener('click', closeAllMenus);
        }
        overlay.addEventListener('click', closeAllMenus);

        // ================= IMAGE VIEWER LOGIC =================
        const imageViewerModal = document.getElementById('imageViewerModal');
        const closeViewerBtn = document.getElementById('closeViewerBtn');
        const viewerImage = document.getElementById('viewerImage');
        const viewerTitle = document.getElementById('viewerTitle');
        const expandViewerBtn = document.getElementById('expandViewerBtn');
        const similarGrid = document.getElementById('similarGrid');
        const viewerUsernameMobile = document.getElementById('viewerUsernameMobile');
        const viewerAvatarMobile = document.getElementById('viewerAvatarMobile');
        const expandViewerBtnMobile = document.getElementById('expandViewerBtnMobile');
        const prevImageBtn = document.getElementById('prevImageBtn');
        const nextImageBtn = document.getElementById('nextImageBtn');
        const shareImageBtn = document.getElementById('shareImageBtn');
        let galleryImages = [];
        let currentViewerList = [];
        let currentImageIndex = 0;
        let similarModeActive = false;

        function openImageViewer(asset, index = -1, list = null) {
            if (!imageViewerModal.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
                toggleMobileBackground(true);
            }

            // Track View
            fetch('/api/track/view', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({asset_id: asset.id, category: asset.category || 'image'})
            }).catch(e => console.log('View track error', e));
            
            const viewerLeft = document.querySelector('#imageViewerModal .viewer-left');
            if (window.innerWidth <= 768 && viewerLeft) {
                viewerLeft.classList.add('skeleton');
            }

            // Reset Similar Mode on new open
            if(viewerLeft) viewerLeft.classList.remove('similar-active');
            similarModeActive = false;
            const sBtn = document.querySelector('.similar-btn');
            if(sBtn) sBtn.style.display = '';

            const mediumUrl = asset.link_medium ? `/uploads/${asset.link_medium}` : `/uploads/${asset.link_small}`;
            viewerImage.src = mediumUrl;
            viewerImage.onload = () => {
                if (viewerLeft) viewerLeft.classList.remove('skeleton');
            };
            viewerImage.onerror = () => { if (viewerLeft) viewerLeft.classList.remove('skeleton'); };

            viewerTitle.textContent = asset.name || 'Image';
            const viewerDesc = document.getElementById('viewerDescription');
            if (viewerDesc) viewerDesc.textContent = asset.description || 'No description available';
            document.getElementById('viewerRes').textContent = asset.resolution || 'Unknown';
            document.getElementById('viewerQuality').textContent = asset.quality || 'Unknown';
            
            // Update User Info
            const viewerUsername = document.getElementById('viewerUsername');
            const viewerAvatar = document.getElementById('viewerAvatar');
            
            if (viewerUsername) {
                viewerUsername.textContent = asset.username || 'Unknown Artist';
            }
            
            // Make viewer user info clickable
            const viewerUserElements = document.querySelectorAll('#imageViewerModal .user-info-group, #imageViewerModal .account-circle');
            viewerUserElements.forEach(el => {
                el.onclick = (e) => { 
                    e.stopPropagation();
                    closeImageViewer(); 
                    openUserProfile(asset.user_id, asset.username, asset.avatar); 
                };
                el.style.cursor = 'pointer';
            });

            if (viewerUsernameMobile) {
                viewerUsernameMobile.textContent = asset.username || 'Unknown Artist';
            }
            if (viewerAvatar) {
                viewerAvatar.src = asset.avatar ? (asset.avatar.startsWith('/static/') ? asset.avatar : `/static/avatars/${asset.avatar}`) : 'https://via.placeholder.com/50';
            }
            if (viewerAvatarMobile) {
                viewerAvatarMobile.src = asset.avatar ? (asset.avatar.startsWith('/static/') ? asset.avatar : `/static/avatars/${asset.avatar}`) : 'https://via.placeholder.com/50';
            }

            const editBtn = document.getElementById('editImageBtn');
            if (editBtn) {
                editBtn.onclick = () => {
                    openEditorModal(asset);
                };
            }

            // Share Button Logic
            if (shareImageBtn) {
                shareImageBtn.onclick = () => {
                    const shareData = {
                        title: asset.name || 'Image',
                        text: `Check out this image by ${asset.username || 'User'}`,
                        url: window.location.origin + `/uploads/${asset.link_original}`
                    };
                    
                    if (navigator.share) {
                        navigator.share(shareData).catch(console.error);
                    } else {
                        navigator.clipboard.writeText(shareData.url).then(() => alert("{{ t('Link copied to clipboard!') }}"));
                    }
                };
            }

            // Report Button Logic
            const reportBtn = document.getElementById('reportImageBtn');
            if (reportBtn) {
                reportBtn.onclick = () => {
                    openReportSettings(asset.id, asset.category_type || 'image');
                };
            }

            // Download Button Logic
            const downloadBtn = document.getElementById('downloadImageBtn');
            if (downloadBtn) {
                downloadBtn.onclick = () => {
                    window.location.href = `/download/${asset.category_type || 'image'}/${asset.id}`;
                };
            }
            
            if (list) {
                currentViewerList = list;
            } else {
                currentViewerList = galleryImages;
            }
            if (index !== -1) currentImageIndex = index;
            imageViewerModal.classList.add('active');
            imageViewerModal.focus();

            if (window.innerWidth <= 768) {
                loadSimilarImages();
            }
        }

        // Similar Images Logic
        const similarBtn = document.querySelector('.similar-btn');
        if(similarBtn) {
            similarBtn.addEventListener('click', () => {
                const viewerLeft = document.querySelector('.viewer-left');
                similarModeActive = !similarModeActive;
                
                if(similarModeActive) {
                    viewerLeft.classList.add('similar-active');
                    similarBtn.style.display = 'none';
                    loadSimilarImages();
                } else {
                    viewerLeft.classList.remove('similar-active');
                }
            });
        }

        function loadSimilarImages() {
            if(!similarGrid) return;
            similarGrid.innerHTML = '';
            
            const currentAsset = currentViewerList[currentImageIndex];
            if (!currentAsset) return;
            
            const category = currentAsset.category || '';

            // Request 10 images from server with the same category
            fetch(`/api/search?category=${encodeURIComponent(category)}&limit=10`)
                .then(r => r.json())
                .then(data => {
                    similarGrid.innerHTML = '';
                    if (data.success && data.assets) {
                        // Filter out current image if present
                        const similarAssets = data.assets.filter(a => a.id !== currentAsset.id);

                        similarAssets.forEach(asset => {
                            const card = document.createElement('div');
                            card.className = 'similar-card';
                            card.innerHTML = `<img src="/uploads/${asset.link_small}" loading="lazy">`;
                            card.onclick = (e) => {
                                e.stopPropagation();
                                openImageViewer(asset, 0, similarAssets);
                            };
                            similarGrid.appendChild(card);
                        });
                    }
                })
                .catch(e => console.error(e));
        }

        function closeImageViewer() {
            document.body.style.overflow = '';
            imageViewerModal.classList.remove('active');
            toggleMobileBackground(false);
            setTimeout(() => { viewerImage.src = ''; }, 300);
        }

        closeViewerBtn.addEventListener('click', closeImageViewer);
        imageViewerModal.addEventListener('click', (e) => {
            if (e.target === imageViewerModal) closeImageViewer();
        });

        function toggleFullScreen() {
            if (viewerImage.requestFullscreen) {
                viewerImage.requestFullscreen();
            } else if (viewerImage.webkitRequestFullscreen) { /* Safari */
                viewerImage.webkitRequestFullscreen();
            } else if (viewerImage.msRequestFullscreen) { /* IE11 */
                viewerImage.msRequestFullscreen();
            }
        }

        if(expandViewerBtn) expandViewerBtn.addEventListener('click', toggleFullScreen);
        if(expandViewerBtnMobile) expandViewerBtnMobile.addEventListener('click', toggleFullScreen);

        function updateViewerImage() {
            if (currentViewerList.length === 0) return;
            const asset = currentViewerList[currentImageIndex];
            openImageViewer(asset, currentImageIndex, currentViewerList);
        }

        prevImageBtn.addEventListener('click', () => {
            if (currentViewerList.length === 0) return;
            currentImageIndex = (currentImageIndex - 1 + currentViewerList.length) % currentViewerList.length;
            updateViewerImage();
        });

        nextImageBtn.addEventListener('click', () => {
            if (currentViewerList.length === 0) return;
            currentImageIndex = (currentImageIndex + 1) % currentViewerList.length;
            updateViewerImage();
        });

        // ================= ICON/LOGO VIEWER LOGIC =================
        const iconViewerModal = document.getElementById('iconViewerModal');
        const closeIconViewerBtn = document.getElementById('closeIconViewerBtn');
        const iconViewerImage = document.getElementById('iconViewerImage');
        const iconViewerTitle = document.getElementById('iconViewerTitle');
        const iconViewerSubGrid = document.getElementById('iconViewerSubGrid');
        const prevIconBtn = document.getElementById('prevIconBtn');
        const nextIconBtn = document.getElementById('nextIconBtn');
        const iconDownloadBtn = document.getElementById('iconDownloadBtn');
        
        let currentIconList = [];
        let currentIconIndex = 0;

        function openIconViewer(asset, index, list) {
            toggleMobileBackground(true);

            // Track View
            fetch('/api/track/view', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({asset_id: asset.id, category: asset.category || 'logo'})
            }).catch(e => console.log('View track error', e));

            currentIconList = list || [];
            currentIconIndex = index;
            
            // Populate Main Image
            const originalUrl = `/uploads/${asset.link_original}`;

            const previewBox = document.querySelector('#iconViewerModal .main-preview-box');
            if (window.innerWidth <= 768 && previewBox) {
                previewBox.classList.add('skeleton');
            }

            iconViewerImage.src = originalUrl;
            iconViewerImage.onload = () => {
                if (previewBox) previewBox.classList.remove('skeleton');
            };
            iconViewerImage.onerror = () => { if (previewBox) previewBox.classList.remove('skeleton'); };
            
            // Populate Details
            iconViewerTitle.textContent = asset.name || 'Untitled';
            
            // Update User Info
            const iconViewerAvatar = document.getElementById('iconViewerAvatar');
            const iconViewerUsername = document.getElementById('iconViewerUsername');
            
            if (iconViewerAvatar) {
                iconViewerAvatar.src = asset.avatar ? (asset.avatar.startsWith('/static/') ? asset.avatar : `/static/avatars/${asset.avatar}`) : 'https://via.placeholder.com/55';
            }
            if (iconViewerUsername) {
                iconViewerUsername.textContent = asset.username || 'Unknown Artist';
            }

            // Make icon viewer user info clickable
            const iconHeaderRow = document.querySelector('#iconViewerModal .header-row');
            if(iconHeaderRow) {
                iconHeaderRow.onclick = () => {
                    closeIconViewer();
                    openUserProfile(asset.user_id, asset.username, asset.avatar);
                };
                iconHeaderRow.style.cursor = 'pointer';
            }
            
            // Populate Sub-Grid (Next 6 items for preview)
            iconViewerSubGrid.innerHTML = '';
            for (let i = 1; i <= 6; i++) {
                const nextIndex = (index + i) % currentIconList.length;
                const nextAsset = currentIconList[nextIndex];
                const thumbUrl = `/uploads/${nextAsset.link_small}`;
                
                const miniBox = document.createElement('div');
                miniBox.className = 'mini-icon-box';
                miniBox.innerHTML = `<img src="${thumbUrl}" style="width:100%; height:100%; object-fit:cover; border-radius:4px;">`;
                miniBox.onclick = () => openIconViewer(nextAsset, nextIndex, currentIconList);
                iconViewerSubGrid.appendChild(miniBox);
            }

            // Download Button Logic
            iconDownloadBtn.onclick = () => {
                window.location.href = `/download/${asset.category_type || 'logo'}/${asset.id}`;
            };

            iconViewerModal.classList.add('active');
        }

        function closeIconViewer() {
            iconViewerModal.classList.remove('active');
            toggleMobileBackground(false);
        }

        closeIconViewerBtn.onclick = closeIconViewer;
        iconViewerModal.onclick = (e) => {
            if (e.target === iconViewerModal) closeIconViewer();
        };

        prevIconBtn.onclick = () => {
            if (currentIconList.length === 0) return;
            const newIndex = (currentIconIndex - 1 + currentIconList.length) % currentIconList.length;
            openIconViewer(currentIconList[newIndex], newIndex, currentIconList);
        };

        nextIconBtn.onclick = () => {
            if (currentIconList.length === 0) return;
            const newIndex = (currentIconIndex + 1) % currentIconList.length;
            openIconViewer(currentIconList[newIndex], newIndex, currentIconList);
        };

        // ================= SIGNUP MODAL LOGIC =================
        const signupModal = document.getElementById('signupModal');
        const closeSignupBtn = document.getElementById('closeSignupBtn');
        const signupTriggers = document.querySelectorAll('.signup-trigger');
        const loginTriggers = document.querySelectorAll('.login-trigger');

        function openAuthModal(mode) {
            toggleMobileBackground(true);
            signupModal.classList.add('active');
            if (typeof closeAllMenus === 'function') closeAllMenus();
            
            const toggleLink = document.getElementById('authToggleLink');
            if (toggleLink) {
                if (mode === 'login' && !isLoginMode) toggleLink.click();
                else if (mode === 'signup' && isLoginMode) toggleLink.click();
            }
        }

        signupTriggers.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                openAuthModal('signup');
            });
        });

        loginTriggers.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                openAuthModal('login');
            });
        });

        if(closeSignupBtn) {
            closeSignupBtn.addEventListener('click', () => {
                signupModal.classList.remove('active');
                toggleMobileBackground(false);
            });
        }
        if(signupModal) {
            signupModal.addEventListener('click', (e) => { if (e.target === signupModal) {
                signupModal.classList.remove('active');
                toggleMobileBackground(false);
            }});
        }

        // ================= SECURITY ALERT LOGIC =================
        const securityModal = document.getElementById('securityModal');
        const closeSecurityBtn = document.getElementById('closeSecurityBtn');
        const ackSecurityBtn = document.getElementById('ackSecurityBtn');

        window.triggerSecurityAlert = function(reason) {
            if(!securityModal) return;
            
            // 1. Close any open upload/editor modals to "shut down process"
            if(typeof closeUploadModal === 'function') closeUploadModal();
            if(typeof closeEditorModal === 'function') closeEditorModal();
            
            // 2. Set Message
            const msgEl = document.getElementById('securityMessage');
            // Extract clean reason if it matches the backend format
            let displayReason = reason;
            if (reason && reason.includes('SECURITY ALERT:')) {
                displayReason = reason.split('SECURITY ALERT:')[1].split('.')[0].trim();
            }
            
            msgEl.textContent = "{{ t('Upload blocked. The image was flagged for:') }} " + (displayReason || "{{ t('Safety Violation') }}") + ".";
            
            // 3. Show Modal
            toggleMobileBackground(true);
            securityModal.classList.add('active');
        }

        function closeSecurityModal() {
            securityModal.classList.remove('active');
            toggleMobileBackground(false);
        }

        if(closeSecurityBtn) closeSecurityBtn.addEventListener('click', closeSecurityModal);
        if(ackSecurityBtn) ackSecurityBtn.addEventListener('click', closeSecurityModal);

     

        // ================= AUTH TOGGLE LOGIC =================
        const authToggleLink = document.getElementById('authToggleLink');
        const authTitle = document.getElementById('authTitle');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const nameInputGroup = document.getElementById('nameInputGroup');
        const authPromptText = document.getElementById('authPromptText');
        let isLoginMode = false;

        if (authToggleLink) {
            authToggleLink.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('authErrorMessage').style.display = 'none';
                isLoginMode = !isLoginMode;
                
                if (isLoginMode) {
                    authTitle.textContent = "{{ t('Welcome Back') }}";
                    authSubmitBtn.textContent = "{{ t('Log In') }}";
                    nameInputGroup.style.display = 'none';
                    nameInputGroup.querySelector('input').removeAttribute('required');
                    authPromptText.textContent = "{{ t("Don't have an account?") }}";
                    authToggleLink.textContent = "{{ t('Join Community') }}";
                } else {
                    authTitle.textContent = "{{ t('Create Account') }}";
                    authSubmitBtn.textContent = "{{ t('Sign Up') }}";
                    nameInputGroup.style.display = 'block';
                    nameInputGroup.querySelector('input').setAttribute('required', 'true');
                    authPromptText.textContent = "{{ t('Already have an account?') }}";
                    authToggleLink.textContent = "{{ t('Log In') }}";
                }
            });
        }

        // Sidebar Profile Button Logic
        const sidebarProfileBtn = document.getElementById('sidebarProfileBtn');
        if (sidebarProfileBtn) {
            sidebarProfileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const myProfileBtn = document.getElementById('myProfileBtn');
                if (myProfileBtn) myProfileBtn.click();
            });
        }

        // ================= AUTH FORM SUBMISSION =================
        const signupForm = document.getElementById('signupForm');
        if (signupForm) {
            signupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const nameInput = document.querySelector('#nameInputGroup input');
                const emailInput = signupForm.querySelector('input[type="email"]');
                const passwordInput = signupForm.querySelector('input[type="password"]');
                const submitBtn = document.getElementById('authSubmitBtn');
                const errorMsg = document.getElementById('authErrorMessage');
                
                const originalBtnText = submitBtn.textContent;
                submitBtn.textContent = "{{ t('Processing...') }}";
                submitBtn.disabled = true;

                let url = isLoginMode ? '/login' : '/register';
                let body = {};

                if (isLoginMode) {
                    body = { username: emailInput.value, password: passwordInput.value };
                } else {
                    body = { username: nameInput.value, email: emailInput.value, password: passwordInput.value };
                }

                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        if (isLoginMode) {
                            window.location.reload();
                        } else {
                            errorMsg.textContent = "{{ t('Account created! Switching to login...') }}";
                            errorMsg.style.color = '#4caf50';
                            errorMsg.style.display = 'block';
                            setTimeout(() => {
                                document.getElementById('authToggleLink').click();
                                errorMsg.style.display = 'none';
                                errorMsg.style.color = '#ff5f56';
                            }, 1500);
                        }
                    } else {
                        errorMsg.textContent = data.message || "{{ t('An error occurred') }}";
                        errorMsg.style.display = 'block';
                    }
                })
                .catch(err => { 
                    console.error(err); 
                    errorMsg.textContent = "{{ t('Network error. Please try again.') }}";
                    errorMsg.style.display = 'block';
                })
                .finally(() => { submitBtn.textContent = originalBtnText; submitBtn.disabled = false; });
            });
        }

        // ================= LIKE FUNCTIONALITY =================
        async function toggleLike(btn) {
            const id = btn.dataset.id;
            const category = btn.dataset.category;
            
            // Optimistic UI update
            btn.classList.toggle('active');
            
            try {
                const res = await fetch('/api/like', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({asset_id: id, category: category})
                });
                const data = await res.json();
                if(!data.success) {
                    btn.classList.toggle('active'); // Revert
                    if(data.message === 'Authentication required') {
                        document.querySelector('.signup-trigger').click();
                    }
                }
            } catch(e) {
                btn.classList.toggle('active'); // Revert
            }
        }

        async function toggleSave(btn) {
            const id = btn.dataset.id;
            const category = btn.dataset.category;
            
            btn.classList.toggle('active');
            
            try {
                const res = await fetch('/api/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({asset_id: id, category: category})
                });
                const data = await res.json();
                if(!data.success && data.message === 'Authentication required') {
                    btn.classList.toggle('active');
                    document.querySelector('.signup-trigger').click();
                }
            } catch(e) {
                btn.classList.toggle('active');
            }
        }

        // ================= CATEGORY MODAL LOGIC =================
        const categoryModal = document.getElementById('categoryModal');
        const filterTriggers = document.querySelectorAll('.filter-trigger');
        const closeCategoryBtn = document.getElementById('closeCategoryBtn');
        const categoryGrid = document.getElementById('categoryGrid');
        const modalResGrid = document.getElementById('modalResGrid');
        const modalSizeGrid = document.getElementById('modalSizeGrid');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const sidebarResGrid = document.getElementById('sidebarResGrid');
        const sidebarSizeGrid = document.getElementById('sidebarSizeGrid');
        const modalSortGrid = document.getElementById('modalSortGrid');

        function setupSelection(container, onSelect) {
            if(!container) return;
            const btns = container.querySelectorAll('.filter-btn');
            btns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.classList.contains('selected')) {
                        btn.classList.remove('selected');
                        onSelect(null);
                    } else {
                        btns.forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        onSelect(btn.dataset.value || btn.textContent.trim());
                    }
                });
            });
        }

        setupSelection(modalResGrid, (val) => selectedRes = val);
        setupSelection(modalSizeGrid, (val) => selectedSize = val);
        setupSelection(modalSortGrid, (val) => selectedSort = val || 'newest');

        // Sidebar Filter Logic (Immediate Search)
        setupSelection(sidebarResGrid, (val) => {
            selectedRes = val;
            window.performSearch();
            updateFilterActiveState();
        });
        setupSelection(sidebarSizeGrid, (val) => {
            selectedSize = val;
            window.performSearch();
            updateFilterActiveState();
        });

        window.updateFilterActiveState = function() {
            const hasFilters = selectedRes || selectedSize || selectedCat;
            document.querySelectorAll('.filter-trigger').forEach(btn => {
                if (hasFilters) btn.classList.add('active-filters');
                else btn.classList.remove('active-filters');
            });
        }

        filterTriggers.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                toggleMobileBackground(true);
                if (typeof closeAllMenus === 'function') closeAllMenus();
                
                // Populate if empty
                if (categoryGrid.children.length === 0) {
                    categoriesList.forEach(cat => {
                        const item = document.createElement('div');
                        item.className = 'category-item';
                        item.textContent = cat;
                        item.onclick = () => {
                            if (item.classList.contains('selected')) {
                                item.classList.remove('selected');
                                selectedCat = null;
                            } else {
                                const allItems = categoryGrid.querySelectorAll('.category-item');
                                allItems.forEach(i => i.classList.remove('selected'));
                                item.classList.add('selected');
                                selectedCat = cat;
                            }
                            
                            window.performSearch();
                            updateFilterActiveState();
                            categoryModal.classList.remove('active');
                            toggleMobileBackground(false);
                        };
                        categoryGrid.appendChild(item);
                    });
                }

                // Sync visual state with current selectedCat
                categoryGrid.querySelectorAll('.category-item').forEach(item => {
                    if (item.textContent === selectedCat) item.classList.add('selected');
                    else item.classList.remove('selected');
                });

                categoryModal.classList.add('active');
            });
        });

        if(applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', () => {
                const requestData = {
                    resolution: selectedRes,
                    size: selectedSize,
                    category: selectedCat,
                    sort: selectedSort
                };
                console.log("Building Request:", requestData);
                window.performSearch(); // Trigger search with selected filters
                
                updateFilterActiveState();

                categoryModal.classList.remove('active');
                toggleMobileBackground(false);
            });
        }

        window.initNavTabs = function() {
            const container = document.getElementById('navTabsContainer');
            const dropdown = document.getElementById('navTabDropdown');
            const plusBtn = document.getElementById('navPlusBtn');
            
            if (!container || !dropdown) return;
            
            // Clear existing items for re-render
            container.innerHTML = '';
            dropdown.innerHTML = '';

            // 1. Add "Featured" first
            const featuredLink = document.createElement('a');
            featuredLink.href = "#";
            featuredLink.className = "nav-tab active";
            featuredLink.textContent = "Featured";
            featuredLink.setAttribute('data-i18n', "Featured");
            featuredLink.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                featuredLink.classList.add('active');
                const searchInput = document.querySelector('.search-input');
                if(searchInput) searchInput.value = '';
                
                selectedCat = null;
                selectedRes = null;
                selectedSize = null;
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('selected'));
                updateFilterActiveState();
                
                const homeBtn = document.querySelector('.sidebar-nav-btn[data-target="section-home"]');
                if(homeBtn) homeBtn.click();
            });
            container.appendChild(featuredLink);

            // 2. Populate Horizontal Bar & Dropdown
            categoriesList.forEach(cat => {
                // Add to horizontal bar
                const tab = document.createElement('a');
                tab.href = "#";
                tab.className = "nav-tab";
                tab.textContent = cat;
                
                tab.addEventListener('click', (e) => {
                    e.preventDefault();

                    if (tab.classList.contains('active')) {
                        // Already active, so deactivate by triggering the 'Featured' tab's logic
                        const featuredLink = document.querySelector('.nav-tab[data-i18n="Featured"]');
                        if (featuredLink) {
                            featuredLink.click();
                        }
                    } else {
                        // Not active, so activate it
                        // Reset other filters to ensure fresh search
                        selectedRes = null;
                        selectedSize = null;
                        document.querySelectorAll('.filter-btn.selected').forEach(b => b.classList.remove('selected'));

                        const searchInput = document.querySelector('.search-input');
                        if(searchInput) {
                            searchInput.value = cat;
                        selectedCat = null;
                            updateFilterActiveState();
                            searchInput.focus();
                            if (window.performSearch) window.performSearch();
                        }
                        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                    }
                });
                container.appendChild(tab);

                // Add to dropdown
                const dropItem = document.createElement('div');
                dropItem.className = "category-item";
                dropItem.textContent = cat;
                dropItem.onclick = () => {
                    // Reset filters
                    selectedRes = null;
                    selectedSize = null;
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('selected'));

                    const searchInput = document.querySelector('.search-input');
                    if(searchInput) {
                        searchInput.value = cat;
                        selectedCat = null;
                        updateFilterActiveState();
                        searchInput.focus();
                        if (window.performSearch) window.performSearch();
                    }
                    dropdown.classList.remove('active');
                    plusBtn.style.transform = 'rotate(0deg)';
                    
                    document.querySelectorAll('.nav-tab').forEach(t => {
                        if (t.textContent === cat) t.classList.add('active');
                        else t.classList.remove('active');
                    });
                };
                dropdown.appendChild(dropItem);
            });

            // 3. Toggle Dropdown
            // Remove old listeners to prevent duplicates if re-run
            const newPlusBtn = plusBtn.cloneNode(true);
            plusBtn.parentNode.replaceChild(newPlusBtn, plusBtn);
            
            newPlusBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('active');
                newPlusBtn.style.transform = dropdown.classList.contains('active') ? 'rotate(45deg)' : 'rotate(0deg)';
            });

            // Close when clicking outside
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target) && !newPlusBtn.contains(e.target)) {
                    dropdown.classList.remove('active');
                    newPlusBtn.style.transform = 'rotate(0deg)';
                }
            });
        };

        if (closeCategoryBtn) {
            closeCategoryBtn.addEventListener('click', () => {
                categoryModal.classList.remove('active');
                toggleMobileBackground(false);
            });
        }
        if (categoryModal) {
            categoryModal.addEventListener('click', (e) => {
                if (e.target === categoryModal) {
                    categoryModal.classList.remove('active');
                    toggleMobileBackground(false);
                }
            });
        }

        // ================= AUTO RELOAD ON VIEW CHANGE =================
        // Reloads page when switching between Mobile, Tablet, and Desktop views
        // to ensure Masonry grids and layout calculations are correct.
        let currentViewMode = getViewMode();

        function getViewMode() {
            const w = window.innerWidth;
            if (w <= 768) return 'mobile';
            if (w <= 1150) return 'tablet';
            return 'desktop';
        }

        let resizeDebounce;
        window.addEventListener('resize', () => {
            clearTimeout(resizeDebounce);
            resizeDebounce = setTimeout(() => {
                const newMode = getViewMode();
                const homeSection = document.getElementById('section-home');
                // Only reload if the view mode changed AND we are currently on the Home section
                if (newMode !== currentViewMode) {
                    if (homeSection && homeSection.style.display !== 'none') {
                        window.location.reload();
                    }
                    currentViewMode = newMode;
                }
            }, 300);
        });

        // Initial Render
        renderCategoryWidgets();
        if (window.innerWidth > 768) {
            loadHomeContent();
        }

        // --- AUTO-OPEN VIEWER FOR SEO LANDING PAGES ---
        // If the server passed a 'view_asset' object, open it immediately
        const serverAsset = {{ view_asset|default(None)|tojson }};
        if (serverAsset) {
            // Wait slightly for DOM to be ready
            setTimeout(() => {
                if (serverAsset.category_type === 'logo') {
                    openIconViewer(serverAsset, 0, [serverAsset]);
                } else {
                    openImageViewer(serverAsset, 0, [serverAsset]);
                }
            }, 500);
        }
    </script>

    </body>

</html>
