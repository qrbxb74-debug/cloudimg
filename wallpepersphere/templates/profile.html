{% include 'theme_loader.html' %}
<style>
/* ===== RESET ===== */
.profile-root * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

/* ===== THEME VARIABLES ===== */
:root {
    --bg: #0b0f1a;
    --card: #0c0f16;
    --primary: #3b82f6;
    --primary-hover: #2563eb;
    --text-main: #e5e7eb;
    --text-muted: #9ca3af;
    --border: rgba(255,255,255,0.12);
    --glass: rgba(255,255,255,0.08);
    --shadow: 0 20px 60px rgba(0,0,0,0.55);
}

[data-theme="light"] {
    --bg: #f3f4f6;
    --card: #ffffff;
    --text-main: #111827;
    --text-muted: #6b7280;
    --border: #e5e7eb;
    --glass: rgba(0,0,0,0.05);
    --shadow: 0 10px 30px rgba(0,0,0,0.1);
}

[data-theme="light"] .btn {
    background: #000 !important;
    color: #fff !important;
    border-color: #000 !important;
}

/* ===== BODY ===== */
.profile-root {
    font-family: Inter, Roboto, Arial, sans-serif;
    color: var(--text-main);
    width: 100%;
    background: transparent;
}

/* ===== MAIN CONTAINER ===== */
.profile-container {
    
    margin: auto;
    background: var(--card);
    
    
    border-radius: 22px;
    box-shadow: var(--shadow);
    padding: 28px;
    border: 1px solid var(--border);
    width: 100%;
}

/* ===== HEADER & INFO ===== */
.header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.info-section {
    display: flex;
    flex-wrap: wrap;
    gap: 30px;
    align-items: center;
    margin-bottom: 30px;
}

/* ===== USER INFO ===== */
.user-info {
    text-align: center;
    flex: 0 0 auto;
    min-width: 160px;
}

.avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    margin: 0 auto 12px;
    background: linear-gradient(135deg, #3b82f6, #9333ea);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    color: #fff;
    box-shadow: 0 0 0 4px rgba(255,255,255,0.1), 0 15px 35px rgba(0,0,0,0.4);
}

.avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.username {
    margin-top: 16px;
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 0.5px;
}

/* ===== STATS ===== */
.stats {
    display: flex;
    flex-direction: row;
    gap: 16px;
    flex: 1;
    flex-wrap: wrap;
}

.stat-box {
    flex: 1;
    min-width: 140px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 16px 20px;
    border-radius: 16px;
    background: var(--glass);
    backdrop-filter: blur(12px);
    border: 1px solid var(--border);
    transition: transform 0.2s ease, background 0.2s ease;
    align-items: center;
}

.stat-box:hover {
    transform: translateY(-3px);
    background: rgba(255,255,255,0.1);
}

.stat-label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 6px;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-main);
}

/* ===== ACTION BUTTONS ===== */
.actions {
    display: flex;
    gap: 12px;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border-radius: 999px;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--glass);
    color: var(--text-main);
    backdrop-filter: blur(10px);
    transition: all 0.25s ease;
}

.btn:hover {
    transform: translateY(-1px);
    background: rgba(255,255,255,0.15);
}

.btn-icon {
    width: 16px;
    height: 16px;
    object-fit: contain;
    filter: brightness(0) invert(1);
}

.btn-primary {
    background: linear-gradient(135deg, #3b82f6, #7c3aed);
    color: #fff;
    border: none;
}

.btn-primary:hover {
    filter: brightness(1.1);
}

.btn-primary:hover {
    background: var(--primary-hover);
}

.btn-outline {
    background: var(--glass);
    color: var(--text-main);
}

.btn-outline:hover {
    background: #f1f5f9;
}

/* ===== NOTIFICATION AREA ===== */
.notification-box {
    background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(124,58,237,0.15));
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 16px 24px;
    backdrop-filter: blur(14px);
    display: flex;
    align-items: center;
    gap: 16px;
}

.notification-icon {
    display: none;
}

.notification-icon-img {
    width: 24px;
    height: 24px;
    opacity: 0.9;
    filter: brightness(0) invert(1);
}

.notification-text {
    font-size: 14px;
    color: var(--text-main);
    line-height: 1.5;
}

/* ===== DIVIDER ===== */
.divider {
    margin: 28px 0;
    height: 1px;
    background: linear-gradient(to right, transparent, var(--border), transparent);
}

/* ===== IMAGE GALLERY ===== */
.gallery {
    border-radius: 20px;
    padding: 28px;
    min-height: 280px;
    background: var(--glass);
    border: 1px dashed var(--border);
    backdrop-filter: blur(14px);
}
.profile-tabs {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
}
.tab-btn {
    background: transparent;
    border: none;
    color: var(--text-muted);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    padding: 8px 12px;
    position: relative;
    transition: color 0.3s;
}
.tab-btn.active {
    color: var(--text-main);
}
.tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: -11px;
    left: 0;
    width: 100%;
    height: 2px;
    background: var(--primary);
}
.profile-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px;
}
.profile-card {
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    aspect-ratio: 1/1;
    background: #000;
    cursor: pointer;
    border: 1px solid var(--border);
}
.profile-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s, opacity 0.5s ease;
    opacity: 0;
}
.profile-card img.loaded {
    opacity: 1;
}
.profile-card:hover img {
    transform: scale(1.05);
}

.gallery-placeholder {
    text-align: center;
    color: var(--text-muted);
    font-size: 16px;
}

/* ===== ICONS ===== */
.stat-icon {
    width: 24px;
    height: 24px;
    margin-bottom: 8px;
    object-fit: contain;
    filter: brightness(0) invert(1);
}

/* ===== RESPONSIVE ===== */
@media (max-width: 900px) {
    .profile-root {
        width: 100vw;
        height: 100vh;
        overflow-x: hidden; /* Prevent horizontal scrolling */
        overflow-y: auto; /* Allow vertical scrolling for the page content */
        position: fixed; /* Make it cover the whole viewport */
        top: 0;
        left: 0;
        z-index: 1000; /* Ensure it's on top */
        background-color: var(--bg); /* Match root background */
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        scrollbar-width: none; /* Hide scrollbar for Firefox */
    }
    .profile-root::-webkit-scrollbar {
        display: none; /* Hide scrollbar for Chrome, Safari */
    }

    .profile-container {
        padding: 15px; /* Slightly increased padding for better touch targets */
        border-radius: 0; /* Full screen, no rounded corners */
        box-shadow: none; /* Remove shadows for full-page feel */
        border: none; /* Remove border for full-page feel */
        width: 100%;
        min-height: 100vh; /* Ensure it takes at least full viewport height */
        margin: 0 auto; /* Center content within the root if it doesn't take full width */
    }
    .header-row {
        flex-direction: row; /* Keep row for buttons */
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px; /* Adjusted margin */
        justify-content: space-between; /* Space out elements */
        align-items: center;
    }
    .actions {
        width: auto;
        flex: 1; /* Allow actions to take available space */
        justify-content: flex-end;
        display: flex; /* Ensure flex behavior */
        flex-wrap: wrap;
        gap: 6px; /* Slightly reduced gap between buttons */
        align-items: center;
    }
    .btn {
        padding: 6px 10px; /* Adjusted padding */
        font-size: 11px; /* Keep font size, but ensure it fits */
        height: 30px; /* Allow height to adjust */
        flex-shrink: 0; /* Prevent buttons from shrinking too much */
        border-radius: 8px;
    }
    .btn-icon {
        width: 12px; /* Slightly larger icons */
        height: 12px;
    }
    .info-section {
        flex-direction: column; /* Stack user info and stats vertically */
        align-items: center;
        gap: 20px; /* Increased gap for better separation */
        margin-bottom: 25px; /* Adjusted margin */
        text-align: center;
    }
    .user-info {
        min-width: auto;
        flex: 0 0 auto;
        margin-right: 0; /* Remove specific margin */
    }
    .avatar {
        width: 80px; /* Slightly larger avatar */
        height: 80px;
        font-size: 28px; /* Adjusted font size for larger avatar */
        margin: 0 auto 10px; /* Adjusted margin */
        box-shadow: 0 0 0 3px rgba(255,255,255,0.1), 0 8px 20px rgba(0,0,0,0.4); /* Adjusted shadow */
    }
    .username {
        font-size: 18px; /* Retain font size, ensure readability */
        margin-top: 8px; /* Adjusted margin */
    }
    .stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px; /* Adjusted gap */
        width: 100%;
    }
    .stat-box {
        min-width: 0;
        padding: 10px 5px; /* Adjusted padding */
        border-radius: 12px; /* Adjusted border radius */
    }
    .stat-icon {
        width: 18px; /* Slightly larger icons */
        height: 18px;
        margin-bottom: 6px; /* Adjusted margin */
    }
    .stat-label {
        font-size: 10px; /* Keep font size, ensure readability */
        margin-bottom: 2px;
    }
    .stat-value {
        font-size: 18px; /* Keep font size, ensure readability */
    }
    .notification-box {
        padding: 12px; /* Adjusted padding */
        border-radius: 15px; /* Adjusted border radius */
        gap: 12px; /* Adjusted gap */
        flex-wrap: wrap; /* Allow content to wrap */
        justify-content: center; /* Center content */
        text-align: center;
    }
    .notification-text {
        font-size: 13px; /* Keep font size, ensure readability */
        flex-grow: 1; /* Allow text to grow */
    }
    .notification-icon-img {
        width: 20px; /* Slightly larger icon */
        height: 20px;
        margin: 0 auto; /* Center icon */
    }
    .divider {
        margin: 20px 0; /* Adjusted margin */
    }
    .gallery {
        padding: 0; /* Remove padding as container is now full-width */
        min-height: 200px;
        border-radius: 0; /* Full screen */
    }
    .profile-tabs {
        gap: 15px;
        margin-bottom: 15px;
        padding-bottom: 8px; /* Adjusted padding */
        justify-content: center; /* Center tabs */
    }
    .tab-btn {
        font-size: 14px; /* Keep font size, ensure readability */
        padding: 5px 10px; /* Adjusted padding */
    }
    .profile-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* Larger minimum for cards */
        gap: 10px; /* Adjusted gap */
    }
    .profile-card {
        border-radius: 10px; /* Adjusted border radius */
    }
}

/* ===== AVATAR SELECTION MODAL ===== */
.avatar-modal {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(5px);
    z-index: 2000;
    justify-content: center;
    align-items: center;
}
.avatar-modal.active { display: flex; }
.avatar-grid-box {
    background: var(--card);
    padding: 20px;
    border-radius: 16px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    border: 1px solid var(--border);
    height: 80%;
    overflow-y: auto;
    position: relative;
    scrollbar-width: none;
}
.avatar-grid-box::-webkit-scrollbar { display: none; }
.avatar-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-top: 15px;
}
.avatar-option {
    width: 100%;
    aspect-ratio: 1/1;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: 0.2s;
}
.avatar-option:hover { border-color: var(--primary); transform: scale(1.1); }

.profile-input {
    width: 100%;
    background: var(--glass);
    border: 1px solid var(--border);
    padding: 10px;
    border-radius: 8px;
    color: var(--text-main);
    outline: none;
    font-family: inherit;
}
.profile-input:focus {
    border-color: var(--primary);
}

.close-modal-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
    color: var(--text-main);
}
.close-modal-btn:hover { background: var(--glass); }

.notif-item {
    background: var(--glass);
    border: 1px solid var(--border);
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 10px;
    text-align: left;
}
.notif-date {
    font-size: 10px;
    color: var(--text-muted);
    margin-bottom: 5px;
}
.notif-msg {
    font-size: 13px;
    color: var(--text-main);
}

.delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.2s;
    opacity: 0;
    z-index: 10;
}
.profile-card:hover .delete-btn {
    opacity: 1;
}
.delete-btn:hover {
    background: #ff4444;
    border-color: #ff4444;
    transform: scale(1.1);
}
.delete-btn svg {
    width: 14px;
    height: 14px;
    color: white;
}
@media (max-width: 768px) {
    .delete-btn {
        opacity: 1;
        background: rgba(0, 0, 0, 0.4);
    }
}
</style>

<div class="profile-root">
    <div class="profile-container">
        <!-- HEADER -->
        <div class="header-row">
            <button class="btn btn-outline" id="profileBackBtn" onclick="closeProfile()">
                <img src="/static/icons/back.png" class="btn-icon" alt="{{ _('Profile_Back') }}" data-i18n="Profile_Back" data-i18n-attr="alt"> <span data-i18n="Profile_Back">{{ _('Profile_Back') }}</span>
            </button>
            <div class="actions">
                {% if role == 'admin' %}
                <button type="button" class="btn btn-outline" onclick="window.location.href='/admin'" style="border-color: var(--primary); color: var(--primary);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    <span data-i18n="Admin_Dashboard">{{ _('Dashboard') }}</span>
                </button>
                {% endif %}
                <button class="btn btn-outline" onclick="openAvatarModal()"><img src="/static/icons/pencil.png" class="btn-icon" alt="{{ _('Profile_Edit') }}" data-i18n="Profile_Edit" data-i18n-attr="alt"> <span data-i18n="Profile_Change_Avatar">{{ _('Profile_Change_Avatar') }}</span></button>
                <button class="btn btn-outline" onclick="openSettings('account')"><img src="/static/icons/settings.png" class="btn-icon" alt="Edit Profile"> <span>Edit Profile</span></button>
                <button class="btn btn-primary" onclick="document.getElementById('uploadNavBtn').click()"><img src="/static/icons/upload.png" class="btn-icon" alt="{{ _('Profile_Upload') }}" data-i18n="Profile_Upload" data-i18n-attr="alt"> <span data-i18n="Profile_Upload">{{ _('Profile_Upload') }}</span></button>
            </div>
        </div>
        
        <!-- INFO SECTION -->
        <div class="info-section">
            <div class="user-info">
                <div class="avatar">
                    {% if avatar %}
                        <img src="{{ avatar if avatar.startswith('/static/') else '/static/avatars/' + avatar }}" alt="{{ _('Profile_Avatar') }}" data-i18n="Profile_Avatar" data-i18n-attr="alt">
                    {% else %}
                        <img src="https://via.placeholder.com/120" alt="{{ _('Profile_Avatar') }}" data-i18n="Profile_Avatar" data-i18n-attr="alt">
                    {% endif %}
                </div>
                <div class="username">{{ username }}</div>
            </div>
            <div class="stats">
                <div class="stat-box">
                    <img src="/static/icons/heart.png" class="stat-icon" alt="{{ _('Profile_Likes') }}" data-i18n="Profile_Likes" data-i18n-attr="alt">
                    <div class="stat-label" data-i18n="Profile_Likes">{{ _('Profile_Likes') }}</div>
                    <div class="stat-value">{{ total_likes }}</div>
                </div>
                <div class="stat-box">
                    <img src="/static/icons/download.png" class="stat-icon" alt="{{ _('Profile_Downloads') }}" data-i18n="Profile_Downloads" data-i18n-attr="alt">
                    <div class="stat-label" data-i18n="Profile_Downloads">{{ _('Profile_Downloads') }}</div>
                    <div class="stat-value">{{ total_downloads }}</div>
                </div>
                <div class="stat-box">
                    <img src="/static/icons/eye.png" class="stat-icon" alt="{{ _('Profile_Views') }}" data-i18n="Profile_Views" data-i18n-attr="alt">
                    <div class="stat-label" data-i18n="Profile_Views">{{ _('Profile_Views') }}</div>
                    <div class="stat-value">{{ total_views }}</div>
                </div>
            </div>
        </div>

        <div class="notification-box" onclick="openNotificationModal()" style="cursor: pointer;">
            <img src="/static/icons/{{ latest_notification_type }}.png" class="notification-icon-img" alt="{{ _('Profile_Notification') }}" data-i18n="Profile_Notification" data-i18n-attr="alt">
            <div class="notification-text">
                {{ latest_notification }}
            </div>
        </div>

    <!-- DIVIDER -->
    <div class="divider"></div>
    <!-- GALLERY -->
    <div class="gallery" style="border: none; background: transparent; padding: 0;">
        <div class="profile-tabs">
            <button class="tab-btn active" id="tabUploads" onclick="switchProfileTab('uploads')" data-i18n="Profile_My_Uploads">{{ _('Profile_My_Uploads') }}</button>
            <button class="tab-btn" id="tabSaved" onclick="switchProfileTab('saved')" data-i18n="Profile_Saved_Items">{{ _('Profile_Saved_Items') }}</button>
        </div>
        <div class="profile-grid" id="profileGrid">
            <!-- Content injected via JS -->
        </div>
        <div id="profileSentinel" style="height: 20px; width: 100%; margin-top: 20px;"></div>
    </div>
</div>


<!-- AVATAR MODAL -->
<div class="avatar-modal" id="avatarModal">
    <div class="avatar-grid-box">
        <button class="close-modal-btn" onclick="document.getElementById('avatarModal').classList.remove('active')" aria-label="{{ _('Close') }}">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 1L13 13M1 13L13 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        <h3 style="margin:0; color:var(--text-main); margin-bottom: 15px;" data-i18n="Profile_Edit_Profile">{{ _('Profile_Edit_Profile') }}</h3>
        
        <div class="user-info" style="margin-bottom: 20px;">
            <div class="avatar" id="modalAvatarContainer" style="margin: 0 auto; cursor: pointer;" onclick="document.getElementById('avatarUploadInput').click()">
                <img src="{{ (avatar if avatar.startswith('/static/') else '/static/avatars/' + avatar) if avatar else 'https://via.placeholder.com/120' }}" id="modalAvatarPreview" alt="{{ _('Profile_Avatar_Preview') }}" data-i18n="Profile_Avatar_Preview" data-i18n-attr="alt">
            </div>
            <input type="file" id="avatarUploadInput" hidden accept="image/*" onchange="previewModalAvatar(this)">
        </div>

        <label style="display:block; color:var(--text-muted); font-size:12px; margin-bottom:5px;" data-i18n="Profile_Username">{{ _('Profile_Username') }}</label>
            <input type="text" id="editUsername" class="profile-input" placeholder="{{ _('Profile_Username') }}" data-i18n="Profile_Username" data-i18n-attr="placeholder">
            
            <label style="display:block; color:var(--text-muted); font-size:12px; margin-bottom:5px; margin-top:10px;" data-i18n="Profile_New_Password">{{ _('Profile_New_Password') }}</label>
            <input type="password" id="editPassword" class="profile-input" placeholder="{{ _('Profile_Leave_Empty') }}" data-i18n="Profile_Leave_Empty" data-i18n-attr="placeholder">
            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="saveProfileChanges()" data-i18n="Profile_Save_Changes">{{ _('Profile_Save_Changes') }}</button>

        <h4 style="margin:0; color:var(--text-main); font-size: 14px; margin-bottom: 10px; border-top: 1px solid var(--border); padding-top: 15px;" data-i18n="Profile_Choose_Avatar">{{ _('Profile_Choose_Avatar') }}</h4>
        <div class="avatar-grid" id="avatarGrid"></div>
    </div>
    </div>
<div class="avatar-modal" id="notificationModal">
    <div class="avatar-grid-box">
        <button class="close-modal-btn" onclick="document.getElementById('notificationModal').classList.remove('active')" aria-label="{{ _('Close') }}">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 1L13 13M1 13L13 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        <h3 style="margin:0; color:var(--text-main); margin-bottom: 15px;" data-i18n="Profile_Notifications">{{ _('Profile_Notifications') }}</h3>
        <div id="notificationList" style="margin-top: 15px;">
            <!-- Notifications injected here -->
        </div>
    </div>
</div>
<!-- DELETE CONFIRMATION MODAL -->
<div class="avatar-modal" id="deleteModal">
    <div class="avatar-grid-box" style="height: auto; max-width: 350px; padding: 25px;">
        <h3 style="margin:0; color:var(--text-main); margin-bottom: 10px; font-size: 18px;">Confirm Deletion</h3>
        <p style="color:var(--text-muted); font-size: 13px; margin-bottom: 25px; line-height: 1.5;">
            Once deleted, this image will be permanently removed from our servers and will not be accessible.
        </p>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-outline" style="flex: 1; justify-content: center;" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn btn-primary" style="flex: 1; background: #ff4444; border-color: #ff4444; justify-content: center;" onclick="executeDelete()">Delete</button>
        </div>
    </div>
</div>
</div>

<script>
    // R2 CDN Configuration (Injected from backend)
    const R2_DOMAIN = "{{ r2_domain }}";
    function getAssetUrl(filename) {
        if (!filename) return '';
        return R2_DOMAIN ? `${R2_DOMAIN}/${filename}` : `/uploads/${filename}`;
    }

    // Observer for progressive loading
    const profileImgObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.onload = () => img.classList.add('loaded');
                img.src = img.dataset.src;
                observer.unobserve(img);
            }
        });
    });
    
    function previewModalAvatar(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('modalAvatarPreview').src = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // State for pagination
    let profileState = {
        currentTab: 'uploads',
        uploads: { offset: 0, loading: false, hasMore: true, items: [] },
        saved: { offset: 0, loading: false, hasMore: true, items: [] }
    };

    const profileSentinelObserver = new IntersectionObserver((entries) => {
        if(entries[0].isIntersecting) {
            loadMoreProfileAssets();
        }
    }, { rootMargin: "2500px" });

    // Function to close the profile view
    function closeProfile() {
        // Hide profile section
        const profileSection = document.getElementById('section-profile');
        if(profileSection) profileSection.style.display = 'none';
        
        // Show Images section instead of Home
        const imagesSection = document.getElementById('section-images');
        if(imagesSection) imagesSection.style.display = 'block';
        if(typeof loadImagesContent === 'function') loadImagesContent();
    }

    function openAvatarModal() {
        const modal = document.getElementById('avatarModal');
        const grid = document.getElementById('avatarGrid');
        
        // Pre-fill username
        const currentUsername = document.querySelector('.username').textContent.trim();
        document.getElementById('editUsername').value = currentUsername;
        document.getElementById('editPassword').value = '';

        // Pre-fill avatar preview
        const mainAvatarImg = document.querySelector('.info-section .avatar img');
        const modalAvatarPreview = document.getElementById('modalAvatarPreview');
        if (mainAvatarImg && modalAvatarPreview) {
            modalAvatarPreview.src = mainAvatarImg.src;
        } else if (modalAvatarPreview) {
            modalAvatarPreview.src = 'https://via.placeholder.com/120';
        }
        
        // Fetch available avatars
        fetch('/api/avatars')
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    grid.innerHTML = '';
                    data.avatars.forEach(av => {
                        const img = document.createElement('img');
                        img.src = `/static/avatars/${av.replace('.png', '.jpg')}`;
                        img.className = 'avatar-option';
                        img.alt = 'Avatar Option';
                        img.onclick = () => selectAvatar(av);
                        grid.appendChild(img);
                    });
                    modal.classList.add('active');
                }
            });
    }

    function openNotificationModal() {
        const modal = document.getElementById('notificationModal');
        const list = document.getElementById('notificationList');
        
        list.innerHTML = '<div style="color:#888; padding:20px;" data-i18n="Profile_Loading">{{ _("Profile_Loading") }}</div>';
        if(window.translationSystem) window.translationSystem.applyTranslations(window.translationSystem.currentLang);
        modal.classList.add('active');
        
        // Remove dot from sidebar if exists
        const dot = document.querySelector('.notification-dot');
        if(dot) dot.remove();
        
        fetch('/api/notifications')
            .then(r => r.json())
            .then(data => {
                list.innerHTML = '';
                if(data.success && data.notifications.length > 0) {
                    data.notifications.forEach(notif => {
                        const date = new Date(notif.created_at * 1000).toLocaleDateString();
                        const iconMap = {
                            'like': 'heart.png',
                            'download': 'download.png',
                            'view': 'eye.png',
                            'system': 'bell.png'
                        };
                        const iconName = iconMap[notif.type] || 'bell.png';
                        
                        const item = document.createElement('div');
                        item.className = 'notif-item';
                        item.innerHTML = `
                            <img src="/static/icons/${iconName}" style="width:20px; height:20px; float:left; margin-right:10px; filter: brightness(0) invert(1);" alt="">
                            <div style="overflow:hidden;">
                                <div class="notif-date">${date}</div>
                                <div class="notif-msg">${notif.message}</div>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                } else {
                    list.innerHTML = '<div style="color:#888; padding:20px;" data-i18n="Profile_No_Notifications">{{ _("Profile_No_Notifications") }}</div>';
                    if(window.translationSystem) window.translationSystem.applyTranslations(window.translationSystem.currentLang);
                }
            });
    }

    function saveProfileChanges() {
        const newUsername = document.getElementById('editUsername').value;
        const newPassword = document.getElementById('editPassword').value;
        const avatarFile = document.getElementById('avatarUploadInput').files[0];

        const formData = new FormData();
        formData.append('username', newUsername);

        if (newPassword) {
            formData.append('password', newPassword);
        }
        if (avatarFile) {
            formData.append('avatar', avatarFile);
        }
        fetch('/update-profile', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                // Full reload to update session avatar in sidebar/navbar
                window.location.reload();
            } else {
                alert(data.message);
            }
        });
    }

    function selectAvatar(filename) {
        fetch('/update-avatar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({avatar: filename})
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                // Reload profile to see changes
                document.getElementById('myProfileBtn').click(); 
                document.getElementById('avatarModal').classList.remove('active');
            }
        });
    }

    let deleteTarget = null;

    function confirmDeleteAsset(id, category) {
        deleteTarget = { id, category };
        document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('active');
        deleteTarget = null;
    }

    function executeDelete() {
        if (!deleteTarget) return;
        const { id, category } = deleteTarget;
        
        fetch('/api/delete_asset', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({asset_id: id, category: category})
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                const el = document.getElementById(`asset-${id}`);
                if(el) el.remove();
                closeDeleteModal();
            } else {
                alert(data.message || 'Error deleting asset');
                closeDeleteModal();
            }
        })
        .catch(e => {
            alert('Network error');
            closeDeleteModal();
        });
    }

    function switchProfileTab(tab) {
        const grid = document.getElementById('profileGrid');
        const tabUploads = document.getElementById('tabUploads');
        const tabSaved = document.getElementById('tabSaved');
        const sentinel = document.getElementById('profileSentinel');
        
        profileState.currentTab = tab;
        const state = profileState[tab];
        
        // Update Tabs UI
        if (tab === 'uploads') {
            tabUploads.classList.add('active');
            tabSaved.classList.remove('active');
        } else {
            tabUploads.classList.remove('active');
            tabSaved.classList.add('active');
        }
        
        // Clear grid to remove previous tab's items
        grid.innerHTML = '';

        // Render existing items or fetch if empty
        if (state.items.length > 0) {
            renderAssetsToGrid(state.items, tab);
        } else {
            if (state.offset === 0 && state.hasMore) {
                grid.innerHTML = '<div id="profileLoader" style="grid-column: 1/-1; text-align:center; padding: 40px; color: #888;" data-i18n="Profile_Loading">{{ _("Profile_Loading") }}</div>';
                if(window.translationSystem) window.translationSystem.applyTranslations(window.translationSystem.currentLang);
                
                const url = tab === 'uploads' ? '/api/user/uploads' : '/api/user/saved';
                fetchProfileAssets(url, tab);
            } else if (!state.hasMore) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding: 40px; color: #888;" data-i18n="Profile_No_Items_Found">{{ _("Profile_No_Items_Found") }}</div>';
                if(window.translationSystem) window.translationSystem.applyTranslations(window.translationSystem.currentLang);
            }
        }
        
        // Start observing sentinel
        if(sentinel) {
            profileSentinelObserver.disconnect();
            profileSentinelObserver.observe(sentinel);
        }
    }

    function loadMoreProfileAssets() {
        const tab = profileState.currentTab;
        const state = profileState[tab];
        
        if (state.loading || !state.hasMore) return;

        const url = tab === 'uploads' ? '/api/user/uploads' : '/api/user/saved';
        fetchProfileAssets(url, tab);
    }

    function fetchProfileAssets(baseUrl, tab) {
        const state = profileState[tab];
        if (state.loading) return;
        state.loading = true;

        // Capture current profile info to ensure it appears in the viewer for own uploads
        const usernameEl = document.querySelector('.profile-container .username');
        const avatarImg = document.querySelector('.profile-container .avatar img');
        const currentUsername = usernameEl ? usernameEl.textContent.trim() : '';
        let currentAvatar = null;
        
        if (avatarImg) {
            const src = avatarImg.getAttribute('src');
            if (src) currentAvatar = src.split('/').pop();
        }
        const isUploads = tab === 'uploads';

        fetch(`${baseUrl}?limit=20&offset=${state.offset}`)
        .then(r => r.json())
        .then(data => {
            state.loading = false;
            const grid = document.getElementById('profileGrid');
            const loader = document.getElementById('profileLoader');
            if(loader) loader.remove();
            
            if (state.offset === 0 && (!data.success || data.assets.length === 0)) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding: 40px; color: #888;" data-i18n="Profile_No_Items_Found">{{ _("Profile_No_Items_Found") }}</div>';
                if(window.translationSystem) window.translationSystem.applyTranslations(window.translationSystem.currentLang);
                return;
            }

            if(data.success) {
                if(data.has_more !== undefined) state.hasMore = data.has_more;
                else if(data.assets.length < 20) state.hasMore = false;
                
                state.offset += data.assets.length;

                const newAssets = data.assets.map(asset => {
                    if (isUploads) {
                        if (!asset.username) asset.username = currentUsername;
                        if (!asset.avatar && currentAvatar) asset.avatar = currentAvatar;
                    }
                    if (!asset.link_medium) asset.link_medium = asset.link_small;
                    return asset;
                });

                state.items.push(...newAssets);
                renderAssetsToGrid(newAssets, tab);
            }
        });
    }

    function renderAssetsToGrid(assets, tab) {
        const grid = document.getElementById('profileGrid');
        const isUploads = tab === 'uploads';
        
        assets.forEach(asset => {
            const card = document.createElement('div');
            card.className = 'profile-card fade-in';
            card.id = `asset-${asset.id}`;
            const isMobile = window.innerWidth <= 768;
            const filename = isMobile ? (asset.link_tiny || asset.link_small) : asset.link_small;
            const imgUrl = getAssetUrl(filename);
            
            const img = document.createElement('img');
            img.dataset.src = imgUrl;
            img.alt = asset.name || 'User Asset';
            card.appendChild(img);
            profileImgObserver.observe(img);

            if (isUploads) {
                const delBtn = document.createElement('div');
                delBtn.className = 'delete-btn';
                delBtn.setAttribute('role', 'button');
                delBtn.setAttribute('aria-label', '{{ _("Delete") }}');
                delBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    confirmDeleteAsset(asset.id, asset.category_type);
                };
                card.appendChild(delBtn);
            }
            
            card.onclick = () => {
                const state = profileState[tab];
                const index = state.items.findIndex(i => i.id === asset.id);
                
                fetch('/api/track/view', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({asset_id: asset.id, category: asset.category_type})
                }).catch(e => {});

                if (asset.category_type === 'logo') {
                    if(typeof openIconViewer === 'function') openIconViewer(asset, index, state.items);
                    else if(window.openIconViewer) window.openIconViewer(asset, index, state.items);
                } else {
                    if(typeof openImageViewer === 'function') openImageViewer(asset, index, state.items);
                    else if(window.openImageViewer) window.openImageViewer(asset, index, state.items);
                }
            };
            
            grid.appendChild(card);
        });
    }

    // Initial Load
    switchProfileTab('uploads');

    // Apply translations immediately if system is available
    setTimeout(() => {
        if(window.translationSystem && window.translationSystem.currentLang) {
            window.translationSystem.applyTranslations(window.translationSystem.currentLang);
        }
    }, 10);
</script>