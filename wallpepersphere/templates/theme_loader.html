<script>
    // Immediate Theme Application to prevent flash
    (function() {
        const serverTheme = "{{ theme_color }}";
        const serverMode = "{{ theme_mode }}";
        const localTheme = localStorage.getItem('theme-color');
        const localMode = localStorage.getItem('theme-mode');
        
        const theme = (serverTheme && serverTheme !== 'None' && serverTheme !== '#0a84ff') ? serverTheme : localTheme;
        if (theme) {
            document.documentElement.style.setProperty('--primary', theme);
            document.documentElement.style.setProperty('--primary-dark', theme);
        }
        
        const mode = (serverMode && serverMode !== 'None') ? serverMode : localMode;
        const metaThemeColor = document.querySelector('meta[name="theme-color"]');
        if (mode === 'light') {
            document.documentElement.setAttribute('data-theme', 'light');
            if (metaThemeColor) metaThemeColor.setAttribute('content', '#f2f2f7');
        } else {
            document.documentElement.removeAttribute('data-theme');
            if (metaThemeColor) metaThemeColor.setAttribute('content', '#0c0f16');
        }
    })();
</script>